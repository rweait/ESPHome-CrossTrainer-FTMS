esphome:
  name: crosstrainer
  friendly_name: crosstrainer
#  platformio_options:
#    board_build.arduino.memory_type: qio_opi
#  includes:
#  - incline_profiles.h

#  on_boot:
#    - priority: 600
#      then:
#        - script.execute: update_heart_rate_zones
#        - globals.set:
#            id: ble_client_connected
#            value: 'false'
#        - text_sensor.template.publish:
#            id: ble_server_status
#            state: "–û—Ç–∫–ª—é—á–µ–Ω"
#        - text_sensor.template.publish:
#            id: connection_status
#            state: "–û—Ç–∫–ª—é—á–µ–Ω–æ"
#        - sensor.template.publish:
#            id: heart_rate_sensor
#            state: 0  # –ò–∑–º–µ–Ω–µ–Ω–æ —Å !lambda 'return NAN;' –Ω–∞ 0
#        - sensor.template.publish:
#            id: battery_level_sensor
#            state: 0  # –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –±–∞—Ç–∞—Ä–µ–∏
#        - globals.set:
#            id: treadmill_running
#            value: 'false'
#        - globals.set:
#            id: current_distance_km
#            value: '0.0'
#        - globals.set:
#            id: current_speed
#            value: '0.0'
#        - lambda: |-
#            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Training Status: Idle (0x01)
#            std::vector<uint8_t> training_status = {0x00, 0x01};
#            id(training_status_char).set_value(training_status);
#            id(last_training_status) = training_status;
#            id(training_status_sensor).publish_state(id(training_status_to_string)(0x01));
#            ESP_LOGI("FTMS", "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ: Training Status = Idle (0x01)");
        # - lambda: |-
        #     // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å UART –Ω–∞ 9600
        #     id(uart_0).set_baud_rate(9600);
        #     id(uart_0).load_settings();
        #     ESP_LOGI("UART", "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞—á–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å UART: 9600");
        # - delay: 2s  # –ñ–¥—ë–º 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –¥–∏—Å–ø–ª–µ—è
        # - lambda: |-
        #     // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å UART –Ω–∞ 230400
        #     id(uart_0).set_baud_rate(230400);
        #     id(uart_0).load_settings();
        #     ESP_LOGI("UART", "–°–∫–æ—Ä–æ—Å—Ç—å UART –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: 230400");


#external_components:
#  - source: github://mrtoy-me/esphome-vl53l1x@main
#  #- source: github://samsonovss/esphome-vl53l1x@main
#    components: [ vl53l1x ]
#    refresh: 0s


esp32:
#  board: esp32-s3-devkitc-1
  board: seeed_xiao_esp32s3
#  flash_size: 16MB
#  cpu_frequency: 240MHz
  framework:
    type: esp-idf
#    sdkconfig_options:
      # üîπ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–¥ —Å–∫–æ—Ä–æ—Å—Ç—å
#      COMPILER_OPTIMIZATION_PERF: "y"                 # -O2 –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
#      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: "y"        # –ú–∞–∫—Å. —á–∞—Å—Ç–æ—Ç–∞ CPU
#      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"             # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π D-–∫—ç—à
#      CONFIG_ESP32S3_DATA_CACHE_LINE_32B: "y"         # 32B –ª–∏–Ω–∏—è –∫—ç—à–∞ ‚Äî –±—ã—Å—Ç—Ä–µ–µ –±–µ–∑ –≥—Ä–∞—Ñ–∏–∫–∏

      # üîπ PSRAM (—Ç–æ–ª—å–∫–æ –ø–æ–¥ –¥–∞–Ω–Ω—ã–µ)
#      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: "n"           # –ö–æ–¥ –≤ IRAM/Flash ‚Äî –±—ã—Å—Ç—Ä–µ–µ
#      CONFIG_SPIRAM_RODATA: "n"                        # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ DRAM –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
#      CONFIG_SPIRAM_MODE_OCT: "y"                      # Octal PSRAM
#      CONFIG_SPIRAM_USE_MALLOC: "y"                    # malloc() –º–æ–∂–µ—Ç –≤—ã–¥–µ–ª—è—Ç—å –≤ PSRAM
#      CONFIG_SPIRAM_ALLOW_STACK_EXTERNAL_MEMORY: "y"   # –†–∞–∑—Ä–µ—à–∏—Ç—å —Å—Ç–µ–∫ –≤ PSRAM
#      CONFIG_SPIRAM_ALLOW_BSS_SEG_EXTERNAL_MEMORY: "y" # –†–∞–∑—Ä–µ—à–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –±—É—Ñ–µ—Ä—ã –≤ PSRAM

      # ‚ùå LVGL ‚Äî —É–±—Ä–∞–Ω–æ
#      CONFIG_LV_MEM_CUSTOM: "n"
#      CONFIG_LV_MEMCPY_MEMSET_STD: "n"
#      CONFIG_LV_ATTRIBUTE_FAST_MEM: "n"

#psram:
#  mode: octal
#  speed: 80MHz


#safe_mode:
#  num_attempts: 1

# web_server:
#   port: 80
#   log: false
#   version: 2
#   css_include: "./treadmill-webserver/webserver-v2.min.css"
#   css_url: ""
#   js_include: "./treadmill-webserver/webserver.js" /config/esphome/treadmill-webserver/webserver.js
#   js_url: ""
#   local: false

# web_server:
#   port: 80
#   css_include: "./treadmill-webserver/webserver-v2.min.css"
#   js_include: "./treadmill-webserver/webserver.js"
#   css_url: ""
#   js_url: ""
#   local: false  # –†–∞–∑—Ä–µ—à–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ —Ä–µ—Å—É—Ä—Å—ã

# Enable logging
logger:
  level: INFO
#  baud_rate: 9600

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption

#ota:
#  - platform: esphome
#    password: "5283ff3a339cbd8f5c5eba074ad730cb"

# safe_mode:
#   num_attempts: 1

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
#  power_save_mode: none  # –û—Ç–∫–ª—é—á–∞–µ—Ç —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏–µ
#  fast_connect: true     # –ë—ã—Å—Ç—Ä–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

  # Enable fallback hotspot (captive portal) in case wifi connection fails
#  ap:
#    ssid: "Cross Trainer Fallback Hotspot"
#    password: !secret CTAP_password

#captive_portal:

#removed uart stuff

time:
  - platform: homeassistant
    id: homeassistant_time
    timezone: Europe/Brussels

# remove a bunch of stuff

  - id: ftms_status_to_string
    type: std::function<std::string(uint8_t)>
    restore_value: no
    initial_value: |-
      [](uint8_t code) -> std::string {
        switch (code) {
          case 0x01: return "Reset";
          case 0x02: return "Stopped or Paused";
          case 0x03: return "Stopped by Safety Key";
          case 0x04: return "Started or Resumed";
          case 0x05: return "Target Speed Changed";
          case 0x06: return "Target Incline Changed";
          case 0x07: return "Target Resistance Level Changed";
          case 0x08: return "Target Power Changed";
          case 0x09: return "Target Heart Rate Changed";
          case 0x0A: return "Targeted Expended Energy Changed";
          case 0x0B: return "Targeted Number of Steps Changed";
          case 0x0C: return "Targeted Number of Strides Changed";
          case 0x0D: return "Targeted Distance Changed";
          case 0x0E: return "Targeted Training Time Changed";
          case 0xFF: return "Control Permission Lost";
          default: return "Unknown (" + std::to_string(code) + ")";
        }
      }
  - id: training_status_to_string
    type: std::function<std::string(uint8_t)>
    restore_value: no
    initial_value: |-
      [](uint8_t code) -> std::string {
        switch (code) {
          case 0x00: return "Other";
          case 0x01: return "Idle";
          case 0x02: return "Warming Up";
          case 0x03: return "Low Intensity Interval";
          case 0x04: return "High Intensity Interval";
          case 0x05: return "Recovery Interval";
          case 0x06: return "Isometric";
          case 0x07: return "Heart Rate Control";
          case 0x08: return "Fitness Test";
          case 0x09: return "Speed Outside of Control Region - Low";
          case 0x0A: return "Speed Outside of Control Region - High";
          case 0x0B: return "Cool Down";
          case 0x0C: return "Watt Control";
          case 0x0D: return "Manual Mode";
          case 0x0E: return "Pre-Workout";
          case 0x0F: return "Post-Workout";
          default: return "Unknown (" + std::to_string(code) + ")";
        }
      }

  - id: last_ftms_status
    type: std::vector<uint8_t>
    restore_value: no
    initial_value: '{0x02, 0x01}'  # Stopped or Paused by User
  - id: last_training_status
    type: std::vector<uint8_t>
    restore_value: no
    initial_value: '{0x00, 0x01}'  # Idle, –±–µ–∑ —Å—Ç—Ä–æ–∫–∏


#---------------------------------- —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
# –¥–ª—è —É—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –∑–æ–Ω–∞–º
  - id: zone1_time
    type: int
    initial_value: '0'
  - id: zone2_time
    type: int
    initial_value: '0'
  - id: zone3_time
    type: int
    initial_value: '0'
  - id: zone4_time
    type: int
    initial_value: '0'
  - id: zone5_time
    type: int
    initial_value: '0'

  - id: total_time_min
    type: float
    initial_value: '0.0'  # –ù–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è
  - id: total_distance_km
    type: float
    initial_value: '0.0'  # –ù–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è
  - id: total_speed_sum
    type: float
    initial_value: '0.0'  # –°—É–º–º–∞ —Å–∫–æ—Ä–æ—Å—Ç–µ–π –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ
  - id: speed_count
    type: int
    initial_value: '0'    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π —Å–∫–æ—Ä–æ—Å—Ç–∏
  - id: total_incline_sum
    type: float
    initial_value: '0.0'  # –°—É–º–º–∞ –Ω–∞–∫–ª–æ–Ω–∞ –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ
  - id: incline_count
    type: int
    initial_value: '0'    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π –Ω–∞–∫–ª–æ–Ω–∞
  - id: total_heart_rate_sum
    type: float
    initial_value: '0.0'  # –°—É–º–º–∞ –ø—É–ª—å—Å–∞ –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ
  - id: heart_rate_count
    type: int
    initial_value: '0'    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π –ø—É–ª—å—Å–∞
  - id: max_heart_rate_total
    type: float
    initial_value: '0.0'  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—É–ª—å—Å

  - id: current_zone
    type: int
    initial_value: '0'

#–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:
  - id: last_time_stored
    type: float
    initial_value: '0.0'
  - id: last_distance_stored
    type: float
    initial_value: '0.0'
  - id: last_calories_stored
    type: int
    initial_value: '0'
  - id: avg_speed_stored
    type: float
    initial_value: '0.0'
  - id: avg_incline_stored
    type: float
    initial_value: '0.0'
  - id: avg_heart_rate_stored
    type: float
    initial_value: '0.0'
  - id: max_heart_rate_stored
    type: float
    initial_value: '0.0'
  - id: zone1_time_stored
    type: int
    initial_value: '0'
  - id: zone2_time_stored
    type: int
    initial_value: '0'
  - id: zone3_time_stored
    type: int
    initial_value: '0'
  - id: zone4_time_stored
    type: int
    initial_value: '0'
  - id: zone5_time_stored
    type: int
    initial_value: '0'

  - id: total_met_sum
    type: float
    initial_value: '0.0'
  - id: met_count
    type: int
    initial_value: '0'

  - id: log_lines_global
    type: std::vector<std::string>

  - id: fat_grams_stored
    type: float
    initial_value: '0.0'  # –•—Ä–∞–Ω–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∂–∂—ë–Ω–Ω–æ–≥–æ –∂–∏—Ä–∞ –≤ –≥—Ä–∞–º–º–∞—Ö


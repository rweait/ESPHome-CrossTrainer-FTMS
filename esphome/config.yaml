esphome:
  name: treadmill
  friendly_name: treadmill
  platformio_options:
    board_build.arduino.memory_type: qio_opi
  includes:
  - incline_profiles.h

  on_boot:
    - priority: 600
      then:
        - script.execute: update_heart_rate_zones
        - globals.set:
            id: ble_client_connected
            value: 'false'
        - text_sensor.template.publish:
            id: ble_server_status
            state: "–û—Ç–∫–ª—é—á–µ–Ω"
        - text_sensor.template.publish:
            id: connection_status
            state: "–û—Ç–∫–ª—é—á–µ–Ω–æ"
        - sensor.template.publish:
            id: heart_rate_sensor
            state: 0  # –ò–∑–º–µ–Ω–µ–Ω–æ —Å !lambda 'return NAN;' –Ω–∞ 0
        - sensor.template.publish:
            id: battery_level_sensor
            state: 0  # –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –±–∞—Ç–∞—Ä–µ–∏
        - globals.set:
            id: treadmill_running
            value: 'false'
        - globals.set:
            id: current_distance_km
            value: '0.0'
        - globals.set:
            id: current_speed
            value: '0.0'
        - lambda: |-
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Training Status: Idle (0x01)
            std::vector<uint8_t> training_status = {0x00, 0x01};
            id(training_status_char).set_value(training_status);
            id(last_training_status) = training_status;
            id(training_status_sensor).publish_state(id(training_status_to_string)(0x01));
            ESP_LOGI("FTMS", "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ: Training Status = Idle (0x01)");
        # - lambda: |-
        #     // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å UART –Ω–∞ 9600
        #     id(uart_0).set_baud_rate(9600);
        #     id(uart_0).load_settings();
        #     ESP_LOGI("UART", "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞—á–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å UART: 9600");
        # - delay: 2s  # –ñ–¥—ë–º 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –¥–∏—Å–ø–ª–µ—è
        # - lambda: |-
        #     // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å UART –Ω–∞ 115200
        #     id(uart_0).set_baud_rate(115200);
        #     id(uart_0).load_settings();
        #     ESP_LOGI("UART", "–°–∫–æ—Ä–æ—Å—Ç—å UART –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: 115200");


external_components:
  - source: github://mrtoy-me/esphome-vl53l1x@main
  #- source: github://samsonovss/esphome-vl53l1x@main
    components: [ vl53l1x ]
    refresh: 0s


esp32:
  board: esp32-s3-devkitc-1
  flash_size: 16MB
  cpu_frequency: 240MHz
  framework:
    type: esp-idf
    sdkconfig_options:
      # üîπ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–¥ —Å–∫–æ—Ä–æ—Å—Ç—å
      COMPILER_OPTIMIZATION_PERF: "y"                 # -O2 –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: "y"        # –ú–∞–∫—Å. —á–∞—Å—Ç–æ—Ç–∞ CPU
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"             # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π D-–∫—ç—à
      CONFIG_ESP32S3_DATA_CACHE_LINE_32B: "y"         # 32B –ª–∏–Ω–∏—è –∫—ç—à–∞ ‚Äî –±—ã—Å—Ç—Ä–µ–µ –±–µ–∑ –≥—Ä–∞—Ñ–∏–∫–∏

      # üîπ PSRAM (—Ç–æ–ª—å–∫–æ –ø–æ–¥ –¥–∞–Ω–Ω—ã–µ)
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: "n"           # –ö–æ–¥ –≤ IRAM/Flash ‚Äî –±—ã—Å—Ç—Ä–µ–µ
      CONFIG_SPIRAM_RODATA: "n"                        # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ DRAM –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
      CONFIG_SPIRAM_MODE_OCT: "y"                      # Octal PSRAM
      CONFIG_SPIRAM_USE_MALLOC: "y"                    # malloc() –º–æ–∂–µ—Ç –≤—ã–¥–µ–ª—è—Ç—å –≤ PSRAM
      CONFIG_SPIRAM_ALLOW_STACK_EXTERNAL_MEMORY: "y"   # –†–∞–∑—Ä–µ—à–∏—Ç—å —Å—Ç–µ–∫ –≤ PSRAM
      CONFIG_SPIRAM_ALLOW_BSS_SEG_EXTERNAL_MEMORY: "y" # –†–∞–∑—Ä–µ—à–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –±—É—Ñ–µ—Ä—ã –≤ PSRAM

      # ‚ùå LVGL ‚Äî —É–±—Ä–∞–Ω–æ
      CONFIG_LV_MEM_CUSTOM: "n"
      CONFIG_LV_MEMCPY_MEMSET_STD: "n"
      CONFIG_LV_ATTRIBUTE_FAST_MEM: "n"

psram:
  mode: octal
  speed: 80MHz

mdns:
  disabled: false

# web_server:
#   port: 80
#   log: false
#   version: 2
#   css_include: "./treadmill-webserver/webserver-v2.min.css"
#   css_url: ""
#   js_include: "./treadmill-webserver/webserver.js" /config/esphome/treadmill-webserver/webserver.js
#   js_url: ""
#   local: false

# web_server:
#   port: 80
#   css_include: "./treadmill-webserver/webserver-v2.min.css"
#   js_include: "./treadmill-webserver/webserver.js"
#   css_url: ""
#   js_url: ""
#   local: false  # –†–∞–∑—Ä–µ—à–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ —Ä–µ—Å—É—Ä—Å—ã

# Enable logging
logger:
  level: INFO
  baud_rate: 0

# Enable Home Assistant API
api:
  encryption:
    key: "nR8nIE5pccP+sy5PfH9pf3mfOcqiTAk7Ox6Q1ily1EI="

ota:
  - platform: esphome
    password: "5283ff3a339cbd8f5c5eba074ad730cb"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Treadmill Fallback Hotspot"
    password: "1YLAT5mbrJu6"

captive_portal:


i2c:
  sda: GPIO12
  scl: GPIO11
  scan: true
  id: bus_a
  frequency: 400kHz

  # #–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–ª–∞—Ç—ã pms
  # - id: uart_bus
  #   tx_pin: 
  #     number: GPIO17
  #     inverted: false
  #   rx_pin: 
  #     number: GPIO18
  #     mode: 
  #       input: true
  #       pullup: true
  #     inverted: false
  #   baud_rate: 4900
  #   data_bits: 8
  #   parity: NONE
  #   stop_bits: 1
  #   rx_buffer_size: 512
  #   debug:
  #     direction: RX
  #     dummy_receiver: false
  #     after:
  #       timeout: 100ms
  #       bytes: 30
  #     sequence:

uart:
  #–¥–∏—Å–ø–ª–µ–π nextion –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ    
  - id: uart_0
    rx_pin: GPIO1
    tx_pin: GPIO2
    baud_rate: 230400
  #–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–ª–∞—Ç—ã –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏
  - id: uart_bus
    tx_pin: 
      number: GPIO17
      inverted: false
    rx_pin: 
      number: GPIO18
      mode: 
        input: true
        pullup: true
      inverted: false
    baud_rate: 4900
    data_bits: 8
    parity: NONE
    stop_bits: 1
    rx_buffer_size: 512
    debug:
      direction: RX
      dummy_receiver: false
      after:
        timeout: 100ms
        bytes: 30
      sequence:
        - lambda: |-
            char message[31] = {0};
            int len = 0;
            for (size_t i = 0; i < std::min(bytes.size(), size_t(30)); i++) {
              if (bytes[i] != 0x00) {
                message[len++] = bytes[i];
              }
            }
            if (len > 0) {
              ESP_LOGD("UART", "–ü–æ–ª—É—á–µ–Ω–æ: %s", message);

              // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–º–∞–Ω–¥—ã –º–µ–∂–¥—É [ –∏ ]
              auto parse_command = [&](const char* start) {
                if (start == nullptr || *start != '[') return;
                const char* end = strchr(start, ']');
                if (end == nullptr || end <= start + 1) return; // –ù–µ—Ç –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–π —Å–∫–æ–±–∫–∏ –∏–ª–∏ –ø—É—Å—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞

                // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –∫–æ–º–∞–Ω–¥—ã –∏ –∑–Ω–∞—á–µ–Ω–∏–µ
                const char* colon = strchr(start + 1, ':');
                if (colon == nullptr || colon >= end) return; // –ù–µ—Ç –¥–≤–æ–µ—Ç–æ—á–∏—è

                char command_name[16] = {0}; // –ú–∞–∫—Å–∏–º—É–º 15 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –∏–º–µ–Ω–∏ –∫–æ–º–∞–Ω–¥—ã + '\0'
                char command_value[16] = {0}; // –ú–∞–∫—Å–∏–º—É–º 15 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏—è + '\0'

                int name_len = colon - (start + 1);
                int value_len = end - (colon + 1);
                if (name_len >= sizeof(command_name) || value_len >= sizeof(command_value)) {
                  ESP_LOGW("UART", "–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ: %s", start);
                  return;
                }

                memcpy(command_name, start + 1, name_len);
                memcpy(command_value, colon + 1, value_len);

                ESP_LOGD("UART", "–ö–æ–º–∞–Ω–¥–∞: %s, –ó–Ω–∞—á–µ–Ω–∏–µ: %s", command_name, command_value);

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
                if (strcmp(command_name, "SETSPD") == 0) {
                  int speed = 0;
                  bool valid = true;
                  for (int i = 0; command_value[i] != '\0' && i < 5; i++) { // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 5 —Ü–∏—Ñ—Ä
                    if (command_value[i] < '0' || command_value[i] > '9') {
                      valid = false;
                      break;
                    }
                    speed = speed * 10 + (command_value[i] - '0');
                  }
                  if (valid) {
                    id(treadmill_speed_feedback) = speed;
                    ESP_LOGD("UART", "–°–∫–æ—Ä–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞: %d", speed);
                  } else {
                    ESP_LOGW("UART", "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: %s", command_value);
                  }
                }
                else if (strcmp(command_name, "SETINC") == 0) {
                  int incline = 0;
                  bool valid = true;
                  for (int i = 0; command_value[i] != '\0' && i < 5; i++) {
                    if (command_value[i] < '0' || command_value[i] > '9') {
                      valid = false;
                      break;
                    }
                    incline = incline * 10 + (command_value[i] - '0');
                  }
                  if (valid) {
                    id(treadmill_incline_feedback) = incline;
                    ESP_LOGD("UART", "–ù–∞–∫–ª–æ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω: %d", incline);
                  } else {
                    ESP_LOGW("UART", "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–∞–∫–ª–æ–Ω: %s", command_value);
                  }
                }
                // –î—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
                else {
                  ESP_LOGD("UART", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞: %s=%s", command_name, command_value);
                }
              };

              // –ü–æ–∏—Å–∫ –ø–µ—Ä–≤–æ–π –∫–æ–º–∞–Ω–¥—ã –≤ message
              const char* start = strchr(message, '[');
              parse_command(start);

              // –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã
              if (start == nullptr) {
                ESP_LOGD("UART", "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–º–∞–Ω–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [–ö–û–ú–ê–ù–î–ê:–ó–ù–ê–ß–ï–ù–ò–ï]: %s", message);
              }
            }

# –≤—ã–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–µ–±–∞–≥–∞, c —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
# uart:
#   - id: uart_bus
#     tx_pin: 
#       number: GPIO17
#       inverted: false
#     rx_pin: 
#       number: GPIO18
#       mode: 
#         input: true
#         pullup: true
#       inverted: false
#     baud_rate: 4900
#     data_bits: 8
#     parity: NONE
#     stop_bits: 1
#     rx_buffer_size: 512
#     debug:
#       direction: RX
#       dummy_receiver: false  # –û—Ç–∫–ª—é—á–∞–µ–º dummy_receiver
#       after:
#         timeout: 100ms  # –û—Å—Ç–∞–≤–ª—è–µ–º —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç
#         bytes: 12  # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ 12 –±–∞–π—Ç, —á—Ç–æ–±—ã –≤–º–µ—Å—Ç–∏—Ç—å [SETSPD:XXX]
#       sequence:
#         - lambda: |-
#             std::vector<uint8_t> filtered_bytes;
#             filtered_bytes.reserve(30); // –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä
#             for (auto byte : bytes) {
#               if (byte != 0x00) {
#                 filtered_bytes.push_back(byte);
#               }
#             }
#             if (!filtered_bytes.empty()) {
#               // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –±–∞–π—Ç—ã –≤ —Å—Ç—Ä–æ–∫—É
#               std::string message(filtered_bytes.begin(), filtered_bytes.end());
#               UARTDebug::log_string(direction, filtered_bytes);  // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

#               // –ü–∞—Ä—Å–∏–Ω–≥ —Å–∫–æ—Ä–æ—Å—Ç–∏ [SETSPD:XXX]
#               size_t spd_pos = message.find("[SETSPD:");
#               if (spd_pos != std::string::npos) {
#                 std::string spd_str = message.substr(spd_pos + 8, 3);
#                 int speed = std::stoi(spd_str);
#                 id(treadmill_speed_feedback) = speed;
#                 ESP_LOGD("UART", "–°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞: %d", speed);
#               }

#               // –ü–∞—Ä—Å–∏–Ω–≥ –Ω–∞–∫–ª–æ–Ω–∞ [SETINC:XXX]
#               size_t inc_pos = message.find("[SETINC:");
#               if (inc_pos != std::string::npos) {
#                 std::string inc_str = message.substr(inc_pos + 8, 3);
#                 int incline = std::stoi(inc_str);
#                 id(treadmill_incline_feedback) = incline;
#                 ESP_LOGD("UART", "–ù–∞–∫–ª–æ–Ω –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ–±–Ω–æ–≤–ª–µ–Ω: %d", incline);
#               }
#             }

# –≤—ã–≤–æ–¥–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–µ–±–∞–≥–∞, –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ —à—É–º–∞ —Å 0x000
# uart:
  # - id: uart_bus
  #   tx_pin: 
  #     number: GPIO18
  #     inverted: false
  #   rx_pin: 
  #     number: GPIO17
  #     mode: 
  #       input: true
  #       pullup: true
  #     inverted: false
  #   baud_rate: 5000
  #   data_bits: 8
  #   parity: NONE
  #   stop_bits: 1
  #   rx_buffer_size: 1024
  #   debug:
  #     direction: RX
  #     dummy_receiver: false  # –û—Ç–∫–ª—é—á–∞–µ–º dummy_receiver
  #     after:
  #       timeout: 100ms  # –û—Å—Ç–∞–≤–ª—è–µ–º —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç
  #       bytes: 30  # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ 12 –±–∞–π—Ç, —á—Ç–æ–±—ã –≤–º–µ—Å—Ç–∏—Ç—å [SETSPD:XXX]
  #     sequence:
  #       - lambda: |-
  #           std::vector<uint8_t> filtered_bytes;
  #           for (auto byte : bytes) {
  #             if (byte != 0x00) {
  #               filtered_bytes.push_back(byte);
  #             }
  #           }
  #           if (!filtered_bytes.empty()) {
  #             UARTDebug::log_string(direction, filtered_bytes);
  #           }

time:
  - platform: sntp
    id: sntp_time

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ‚Äî –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–æ–π
globals:

# –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∞–≤—Ç–æ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
  # –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, —á—Ç–æ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
  - id: calibration_active
    type: bool
    restore_value: no
    initial_value: 'false'

  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, –∏–∑–º–µ—Ä–µ–Ω–Ω–æ–µ –≤–æ –≤—Ä–µ–º—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
  - id: calibration_min_distance
    type: float
    restore_value: no
    initial_value: '9999.0'

  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, –∏–∑–º–µ—Ä–µ–Ω–Ω–æ–µ –≤–æ –≤—Ä–µ–º—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
  - id: calibration_max_distance
    type: float
    restore_value: no
    initial_value: '0.0'

  # –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
  - id: calibration_start_time
    type: uint32_t
    restore_value: no
    initial_value: '0'
# -------------------------------------------------

  #–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, —Å–æ—Ö—Ä–∞–Ω—è—é—â–∞—è —è—Ä–∫–æ—Å—Ç—å —Å –¥–∏—Å–ø–ª–µ—è
  - id: brightness_level
    type: int
    restore_value: yes
    initial_value: '100'

  - id: control_mode
    type: int
    restore_value: no
    initial_value: '0'  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º
  - id: previous_control_mode
    type: int
    restore_value: no
    initial_value: '0'  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º

  - id: fast_update
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: last_update_time
    type: int
    restore_value: no
    initial_value: '0'
  - id: target_distance
    type: float
    restore_value: no
    initial_value: '0.0'
  - id: stable_distance_count
    type: int
    restore_value: no
    initial_value: '0'
  - id: stable_distance_sum
    type: float
    restore_value: no
    initial_value: '0.0'

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–≥–ª–∞–∂–µ–Ω–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
  - id: smoothed_distance
    type: float
    restore_value: no
    initial_value: '0'

  - id: free_running_active
    type: bool
    restore_value: no
    initial_value: 'false'

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  - id: emulate_ble_connected
    type: bool
    restore_value: no
    initial_value: 'false'
  # –•—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏, –ø–æ–ª—É—á–µ–Ω–Ω—É—é —á–µ—Ä–µ–∑ UART
  - id: treadmill_speed_feedback
    type: int
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0'          # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0 (–¥–æ—Ä–æ–∂–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ —á–µ—Ä–µ–∑ UART (–Ω–∞–ø—Ä–∏–º–µ—Ä, "[SETSPD:010]")

  # –•—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â–∏–π –Ω–∞–∫–ª–æ–Ω –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —á–µ—Ä–µ–∑ UART
  - id: treadmill_incline_feedback
    type: int
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0'          # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0 (–±–µ–∑ –Ω–∞–∫–ª–æ–Ω–∞)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∫–ª–æ–Ω–∞ –æ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ —á–µ—Ä–µ–∑ UART (–Ω–∞–ø—Ä–∏–º–µ—Ä, "[SETINC:000]")

  # –•—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â–∏–π —Ü–µ–ª–µ–≤–æ–π –Ω–∞–∫–ª–æ–Ω –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–æ–π
  - id: target_incline
    type: int
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0'          # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0 (–±–µ–∑ –Ω–∞–∫–ª–æ–Ω–∞)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞–∫–ª–æ–Ω–∞ –≤ UART –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

  # –•—Ä–∞–Ω–∏—Ç –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∫–ª–æ–Ω–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
  - id: incline_set_time
    type: unsigned long
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0'          # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥ –Ω–∞–∫–ª–æ–Ω–∞ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ 25 —Å–µ–∫—É–Ω–¥)

  # –•—Ä–∞–Ω–∏—Ç –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
  - id: boot_time
    type: unsigned long
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0'          # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –Ω–∞–∫–ª–æ–Ω–∞ –Ω–∞ 0 –≤ –ø–µ—Ä–≤—ã–µ 10 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ)

  # –•—Ä–∞–Ω–∏—Ç —Ü–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–∫–ª–æ–Ω–∞, –∑–∞–¥–∞–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
  - id: target_incline_goal
    type: int
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0'          # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0 (–±–µ–∑ –Ω–∞–∫–ª–æ–Ω–∞)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∫–ª–æ–Ω–∞ —á–µ—Ä–µ–∑ –ø–æ–ª–∑—É–Ω–æ–∫ "Set Incline" (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç: 1% = 30 –µ–¥–∏–Ω–∏—Ü)

  # –•—Ä–∞–Ω–∏—Ç –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞ —á–µ—Ä–µ–∑ UART –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
  - id: last_packet_time
    type: uint32_t
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0'          # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏ (binary_sensor "Treadmill Powered On")

  # –£–∫–∞–∑—ã–≤–∞–µ—Ç, –≤–∫–ª—é—á—ë–Ω –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç—å—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—É–ª—å—Å–∞
  - id: auto_mode
    type: bool
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: 'false'      # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî false (—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö "Pulse Zone", "Fat Burn", "Recovery run" –¥–ª—è —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏

  # –£–∫–∞–∑—ã–≤–∞–µ—Ç, –±—ã–ª–∞ –ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é
  - id: manual_stop
    type: bool
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: 'false'      # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî false (–Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –Ω–æ–≤—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º

  # –£–∫–∞–∑—ã–≤–∞–µ—Ç, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –º–æ—Ç–æ—Ä –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏
  - id: motor_running
    type: bool
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: 'false'      # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî false (–º–æ—Ç–æ—Ä –≤—ã–∫–ª—é—á–µ–Ω)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–æ—Ä–æ–∂–∫–∏ –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö (start, stop, intervals)

  # –•—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏ –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º —Ñ–æ—Ä–º–∞—Ç–µ (1 –∫–º/—á = 10)
  - id: target_speed
    type: int
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0'          # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0 (–¥–æ—Ä–æ–∂–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—É—â–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ UART –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º

  # –•—Ä–∞–Ω–∏—Ç —Ü–µ–ª–µ–≤—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏, –∫ –∫–æ—Ç–æ—Ä–æ–π —Å—Ç—Ä–µ–º–∏—Ç—Å—è —Å–∏—Å—Ç–µ–º–∞
  - id: target_speed_goal
    type: int
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0'          # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0 (–¥–æ—Ä–æ–∂–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤ —Å–∫—Ä–∏–ø—Ç–µ "smooth_speed" –∏ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∏ –ø–æ –ø—É–ª—å—Å—É

  # –•—Ä–∞–Ω–∏—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—É–ª—å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏ –ø–æ–ª–∞
  - id: max_heart_rate
    type: float
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0.0'        # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0.0 (–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–∫—Ä–∏–ø—Ç–µ "update_heart_rate_zones" –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∑–æ–Ω –ø—É–ª—å—Å–∞

  # –•—Ä–∞–Ω–∏—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≥—Ä–∞–Ω–∏—Ü—É —Ü–µ–ª–µ–≤–æ–π –∑–æ–Ω—ã –ø—É–ª—å—Å–∞
  - id: target_heart_rate_min
    type: float
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0.0'        # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0.0 (–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Ä–µ–∂–∏–º–µ –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ

  # –•—Ä–∞–Ω–∏—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≥—Ä–∞–Ω–∏—Ü—É —Ü–µ–ª–µ–≤–æ–π –∑–æ–Ω—ã –ø—É–ª—å—Å–∞
  - id: target_heart_rate_max
    type: float
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0.0'        # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0.0 (–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Ä–µ–∂–∏–º–µ –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ

  # –£–∫–∞–∑—ã–≤–∞–µ—Ç, –∞–∫—Ç–∏–≤–Ω–∞ –ª–∏ —Ñ–∞–∑–∞ —Ä–∞–∑–º–∏–Ω–∫–∏
  - id: warm_up_active
    type: bool
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: 'false'      # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî false (—Ä–∞–∑–º–∏–Ω–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∏–∫–æ–π —Ä–∞–∑–º–∏–Ω–∫–∏ –≤ —Å–∫—Ä–∏–ø—Ç–µ "warm_up"


  # –•—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏ –≤ –∫–º/—á –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤
  - id: current_speed
    type: float
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0.0'        # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0.0 (–¥–æ—Ä–æ–∂–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ (on_boot)

  # –•—Ä–∞–Ω–∏—Ç –¥–ª–∏–Ω—É –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–∏ —Ä–æ–ª–∏–∫–∞ –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏ –≤ –º–µ—Ç—Ä–∞—Ö
  - id: roller_circumference
    type: float
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0.2763'     # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0.2763 –º–µ—Ç—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ "Treadmill Speed Motor" –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–æ –∏–º–ø—É–ª—å—Å–∞–º

  # –•—Ä–∞–Ω–∏—Ç –ø–µ—Ä–µ–¥–∞—Ç–æ—á–Ω–æ–µ —á–∏—Å–ª–æ —Ä–µ–¥—É–∫—Ç–æ—Ä–∞ –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏
  - id: gear_ratio
    type: float
    restore_value: yes          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '74.5'       # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 74.5 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ "Treadmill Speed Motor" –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–æ –∏–º–ø—É–ª—å—Å–∞–º

  # –£–∫–∞–∑—ã–≤–∞–µ—Ç, –¥–≤–∏–∂–µ—Ç—Å—è –ª–∏ –±–µ–≥–æ–≤–∞—è –¥–æ—Ä–æ–∂–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–ø—É–ª—å—Å–æ–≤
  - id: treadmill_running
    type: bool
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: 'false'      # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî false (–¥–æ—Ä–æ–∂–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ "Treadmill Speed Motor" –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ –∏–º–ø—É–ª—å—Å–∞–º

  # –•—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â—É—é –¥–∏—Å—Ç–∞–Ω—Ü–∏—é, –ø—Ä–æ–π–¥–µ–Ω–Ω—É—é –Ω–∞ –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–µ –≤ –∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö
  - id: current_distance_km
    type: float
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0.0'        # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0.0 (–¥–∏—Å—Ç–∞–Ω—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ "Treadmill Distance" –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –∏ —Å–±—Ä–æ—Å–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ

  # –•—Ä–∞–Ω–∏—Ç –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö, –≤ —Ç–µ—á–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –∏–º–ø—É–ª—å—Å—ã –Ω–µ –ø–æ—Å—Ç—É–ø–∞—é—Ç
  - id: run_stopped_timer
    type: int
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0'          # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ "Treadmill Speed Motor" –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è

  # –£–∫–∞–∑—ã–≤–∞–µ—Ç, –ø–æ–¥–∫–ª—é—á—ë–Ω –ª–∏ BLE-–∫–ª–∏–µ–Ω—Ç –∫ —Å–µ—Ä–≤–µ—Ä—É –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏
  - id: ble_client_connected
    type: bool
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: 'false'      # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî false (–Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∫–æ–π –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ BLE –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞

  # –•—Ä–∞–Ω–∏—Ç –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
  - id: remaining_run_time
    type: int
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0'          # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0 (—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–µ –Ω–∞—á–∞—Ç–∞)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö "start_manual", "start_program", "run_program" –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏

  # –•—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â—É—é —Ñ–∞–∑—É –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ("high" –∏–ª–∏ "low")
  - id: interval_phase
    type: std::string
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '"high"'     # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî "high" (–≤—ã—Å–æ–∫–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–∫—Ä–∏–ø—Ç–µ "interval_training" –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ñ–∞–∑ HIIT

  # –•—Ä–∞–Ω–∏—Ç –≤—Ä–µ–º—è —Ç–µ–∫—É—â–µ–π —Ñ–∞–∑—ã –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
  - id: interval_time
    type: int
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0'          # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–∫—Ä–∏–ø—Ç–µ "interval_training" –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ñ–∞–∑—ã

  # –•—Ä–∞–Ω–∏—Ç –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è —Ä–∞–∑–º–∏–Ω–∫–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
  - id: remaining_warm_up_time
    type: int
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0'          # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0 (—Ä–∞–∑–º–∏–Ω–∫–∞ –Ω–µ –Ω–∞—á–∞—Ç–∞)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö "start_program", "warm_up" –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–∏–Ω–∫–æ–π

  # –•—Ä–∞–Ω–∏—Ç –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –∑–∞–º–∏–Ω–∫–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
  - id: remaining_cool_down_time
    type: int
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0'          # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0 (–∑–∞–º–∏–Ω–∫–∞ –Ω–µ –Ω–∞—á–∞—Ç–∞)
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö "run_program", "cool_down" –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–∏–Ω–∫–æ–π

  # –•—Ä–∞–Ω–∏—Ç –æ–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–∑–º–∏–Ω–∫–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (—Å—á–µ—Ç—á–∏–∫ –¥–ª—è –ª–æ–≥–∏–∫–∏)
  - id: warm_up_time
    type: int
    restore_value: no           # –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    initial_value: '0'          # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî 0
                                # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–∫—Ä–∏–ø—Ç–µ "warm_up" –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è –ø—É–ª—å—Å–∞


  - id: ftms_status_to_string
    type: std::function<std::string(uint8_t)>
    restore_value: no
    initial_value: |-
      [](uint8_t code) -> std::string {
        switch (code) {
          case 0x01: return "Reset";
          case 0x02: return "Stopped or Paused";
          case 0x03: return "Stopped by Safety Key";
          case 0x04: return "Started or Resumed";
          case 0x05: return "Target Speed Changed";
          case 0x06: return "Target Incline Changed";
          case 0x07: return "Target Resistance Level Changed";
          case 0x08: return "Target Power Changed";
          case 0x09: return "Target Heart Rate Changed";
          case 0x0A: return "Targeted Expended Energy Changed";
          case 0x0B: return "Targeted Number of Steps Changed";
          case 0x0C: return "Targeted Number of Strides Changed";
          case 0x0D: return "Targeted Distance Changed";
          case 0x0E: return "Targeted Training Time Changed";
          case 0xFF: return "Control Permission Lost";
          default: return "Unknown (" + std::to_string(code) + ")";
        }
      }
  - id: training_status_to_string
    type: std::function<std::string(uint8_t)>
    restore_value: no
    initial_value: |-
      [](uint8_t code) -> std::string {
        switch (code) {
          case 0x00: return "Other";
          case 0x01: return "Idle";
          case 0x02: return "Warming Up";
          case 0x03: return "Low Intensity Interval";
          case 0x04: return "High Intensity Interval";
          case 0x05: return "Recovery Interval";
          case 0x06: return "Isometric";
          case 0x07: return "Heart Rate Control";
          case 0x08: return "Fitness Test";
          case 0x09: return "Speed Outside of Control Region - Low";
          case 0x0A: return "Speed Outside of Control Region - High";
          case 0x0B: return "Cool Down";
          case 0x0C: return "Watt Control";
          case 0x0D: return "Manual Mode";
          case 0x0E: return "Pre-Workout";
          case 0x0F: return "Post-Workout";
          default: return "Unknown (" + std::to_string(code) + ")";
        }
      }

  - id: last_ftms_status
    type: std::vector<uint8_t>
    restore_value: no
    initial_value: '{0x02, 0x01}'  # Stopped or Paused by User
  - id: last_training_status
    type: std::vector<uint8_t>
    restore_value: no
    initial_value: '{0x00, 0x01}'  # Idle, –±–µ–∑ —Å—Ç—Ä–æ–∫–∏


#---------------------------------- —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
# –¥–ª—è —É—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –∑–æ–Ω–∞–º
  - id: zone1_time
    type: int
    initial_value: '0'
  - id: zone2_time
    type: int
    initial_value: '0'
  - id: zone3_time
    type: int
    initial_value: '0'
  - id: zone4_time
    type: int
    initial_value: '0'
  - id: zone5_time
    type: int
    initial_value: '0'

  - id: total_time_min
    type: float
    initial_value: '0.0'  # –ù–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è
  - id: total_distance_km
    type: float
    initial_value: '0.0'  # –ù–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è
  - id: total_speed_sum
    type: float
    initial_value: '0.0'  # –°—É–º–º–∞ —Å–∫–æ—Ä–æ—Å—Ç–µ–π –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ
  - id: speed_count
    type: int
    initial_value: '0'    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π —Å–∫–æ—Ä–æ—Å—Ç–∏
  - id: total_incline_sum
    type: float
    initial_value: '0.0'  # –°—É–º–º–∞ –Ω–∞–∫–ª–æ–Ω–∞ –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ
  - id: incline_count
    type: int
    initial_value: '0'    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π –Ω–∞–∫–ª–æ–Ω–∞
  - id: total_heart_rate_sum
    type: float
    initial_value: '0.0'  # –°—É–º–º–∞ –ø—É–ª—å—Å–∞ –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ
  - id: heart_rate_count
    type: int
    initial_value: '0'    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π –ø—É–ª—å—Å–∞
  - id: max_heart_rate_total
    type: float
    initial_value: '0.0'  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—É–ª—å—Å

  - id: current_zone
    type: int
    initial_value: '0'

#–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:
  - id: last_time_stored
    type: float
    initial_value: '0.0'
  - id: last_distance_stored
    type: float
    initial_value: '0.0'
  - id: last_calories_stored
    type: int
    initial_value: '0'
  - id: avg_speed_stored
    type: float
    initial_value: '0.0'
  - id: avg_incline_stored
    type: float
    initial_value: '0.0'
  - id: avg_heart_rate_stored
    type: float
    initial_value: '0.0'
  - id: max_heart_rate_stored
    type: float
    initial_value: '0.0'
  - id: zone1_time_stored
    type: int
    initial_value: '0'
  - id: zone2_time_stored
    type: int
    initial_value: '0'
  - id: zone3_time_stored
    type: int
    initial_value: '0'
  - id: zone4_time_stored
    type: int
    initial_value: '0'
  - id: zone5_time_stored
    type: int
    initial_value: '0'

  - id: total_met_sum
    type: float
    initial_value: '0.0'
  - id: met_count
    type: int
    initial_value: '0'

  - id: log_lines_global
    type: std::vector<std::string>

  - id: fat_grams_stored
    type: float
    initial_value: '0.0'  # –•—Ä–∞–Ω–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∂–∂—ë–Ω–Ω–æ–≥–æ –∂–∏—Ä–∞ –≤ –≥—Ä–∞–º–º–∞—Ö

  # - id: incline_profile_map_russia_ufa3_4km 
  #   type: float[114]
  #   restore_value: no
  #   initial_value: "{20, 10, 20, 0, 0, 0, 0, 10, 50, 60, 0, 0, 0, 40, 60, 50, 130, 90, 0, 0, 0, 0, 0, 0, 0, 10, 20, 10, 20, 20, 20, 0, 0, 0, 0, 20, 40, 60, 70, 20, 0, 0, 0, 0, 0, 0, 0, 0, 0, 60, 60, 60, 60, 30, 10, 10, 10, 0, 0, 90, 100, 0, 0, 0, 0, 40, 20, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 110, 140, 60, 0, 0, 30, 60, 40, 20, 20, 50, 40, 0, 0, 0, 0, 10, 30, 0, 0, 0, 0, 0, 30, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0}"

  # - id: incline_profile_map_sipailovo_circle_4_37km
  #   type: float[146]
  #   restore_value: no
  #   initial_value: "{0, 40, 50, 0, 0, 0, 0, 0, 0, 70, 150, 100, 70, 40, 0, 0, 0, 0, 60, 70, 80, 80, 0, 0, 0, 0, 0, 0, 50, 100, 110, 70, 50, 20, 0, 0, 70, 90, 140, 0, 0, 0, 0, 0, 40, 80, 80, 20, 20, 0, 0, 0, 0, 0, 0, 80, 30, 0, 0, 90, 100, 0, 0, 0, 40, 100, 90, 0, 0, 0, 0, 0, 0, 0, 0, 0, 20, 20, 20, 0, 0, 0, 0, 70, 10, 0, 0, 40, 70, 0, 10, 0, 0, 30, 0, 0, 0, 0, 0, 90, 80, 40, 0, 20, 40, 80, 50, 40, 0, 0, 30, 70, 70, 40, 0, 0, 10, 0, 0, 0, 0, 120, 60, 0, 0, 0, 0, 0, 0, 120, 150, 150, 30, 20, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 10}"

  # - id: incline_profile_map_sipailovo_Kashkadan_1_72km
  #   type: float[58]
  #   restore_value: no
  #   initial_value: "{30, 0, 0, 60, 0, 0, 0, 70, 150, 150, 150, 80, 70, 10, 70, 20, 50, 10, 0, 20, 50, 80, 30, 0, 0, 0, 0, 0, 0, 20, 10, 0, 50, 0, 0, 30, 60, 0, 0, 0, 0, 30, 100, 0, 0, 0, 0, 0, 0, 50, 60, 0, 0, 0, 0, 100, 30, 0}"

  # - id: incline_profile_map_russia_ufa3_4km_2d
  #   type: float[114][2]
  #   restore_value: no
  #   initial_value: "{{ {0.0,2.0}, {0.03,1.0}, {0.06,2.0}, {0.09,0.0}, {0.12,0.0}, {0.15,0.0}, {0.18,0.0}, {0.21,1.0}, {0.24,5.0}, {0.27,6.0}, {0.3,0.0}, {0.33,0.0}, {0.36,0.0}, {0.39,4.0}, {0.42,6.0}, {0.45,5.0}, {0.48,13.0}, {0.51,9.0}, {0.54,0.0}, {0.57,0.0}, {0.6,0.0}, {0.63,0.0}, {0.66,0.0}, {0.69,0.0}, {0.72,0.0}, {0.75,1.0}, {0.78,2.0}, {0.81,1.0}, {0.84,2.0}, {0.87,2.0}, {0.9,2.0}, {0.93,0.0}, {0.96,0.0}, {0.99,0.0}, {1.02,0.0}, {1.05,2.0}, {1.08,4.0}, {1.11,6.0}, {1.14,7.0}, {1.17,2.0}, {1.2,0.0}, {1.23,0.0}, {1.26,0.0}, {1.29,0.0}, {1.32,0.0}, {1.35,0.0}, {1.38,0.0}, {1.41,0.0}, {1.44,0.0}, {1.47,6.0}, {1.5,6.0}, {1.53,6.0}, {1.56,6.0}, {1.59,3.0}, {1.62,1.0}, {1.65,1.0}, {1.68,1.0}, {1.71,0.0}, {1.74,0.0}, {1.77,9.0}, {1.8,10.0}, {1.83,0.0}, {1.86,0.0}, {1.89,0.0}, {1.92,0.0}, {1.95,4.0}, {1.98,2.0}, {2.01,0.0}, {2.04,0.0}, {2.07,0.0}, {2.1,0.0}, {2.13,1.0}, {2.16,0.0}, {2.19,0.0}, {2.22,0.0}, {2.25,0.0}, {2.28,0.0}, {2.31,0.0}, {2.34,0.0}, {2.37,0.0}, {2.4,11.0}, {2.43,14.0}, {2.46,6.0}, {2.49,0.0}, {2.52,0.0}, {2.55,3.0}, {2.58,6.0}, {2.61,4.0}, {2.64,2.0}, {2.67,2.0}, {2.7,5.0}, {2.73,4.0}, {2.76,0.0}, {2.79,0.0}, {2.82,0.0}, {2.85,0.0}, {2.88,1.0}, {2.91,3.0}, {2.94,0.0}, {2.97,0.0}, {3.0,0.0}, {3.03,0.0}, {3.06,0.0}, {3.09,3.0}, {3.12,6.0}, {3.15,0.0}, {3.18,0.0}, {3.21,0.0}, {3.24,0.0}, {3.27,0.0}, {3.3,0.0}, {3.33,0.0}, {3.36,0.0}, {3.39,0.0} }}"

  # - id: incline_profile_map_sipailovo_circle_4_37km_2d
  #   type: float[146][2]
  #   restore_value: no
  #   initial_value: "{{ {0.0,0.0}, {0.03,4.0}, {0.06,5.0}, {0.09,0.0}, {0.12,0.0}, {0.15,0.0}, {0.18,0.0}, {0.21,0.0}, {0.24,0.0}, {0.27,7.0}, {0.3,15.0}, {0.33,10.0}, {0.36,7.0}, {0.39,4.0}, {0.42,0.0}, {0.45,0.0}, {0.48,0.0}, {0.51,0.0}, {0.54,6.0}, {0.57,7.0}, {0.6,8.0}, {0.63,8.0}, {0.66,0.0}, {0.69,0.0}, {0.72,0.0}, {0.75,0.0}, {0.78,0.0}, {0.81,0.0}, {0.84,5.0}, {0.87,10.0}, {0.9,11.0}, {0.93,7.0}, {0.96,5.0}, {0.99,2.0}, {1.02,0.0}, {1.05,0.0}, {1.08,7.0}, {1.11,9.0}, {1.14,14.0}, {1.17,0.0}, {1.2,0.0}, {1.23,0.0}, {1.26,0.0}, {1.29,0.0}, {1.32,4.0}, {1.35,8.0}, {1.38,8.0}, {1.41,2.0}, {1.44,2.0}, {1.47,0.0}, {1.5,0.0}, {1.53,0.0}, {1.56,0.0}, {1.59,0.0}, {1.62,0.0}, {1.65,8.0}, {1.68,3.0}, {1.71,0.0}, {1.74,0.0}, {1.77,9.0}, {1.8,10.0}, {1.83,0.0}, {1.86,0.0}, {1.89,0.0}, {1.92,4.0}, {1.95,10.0}, {1.98,9.0}, {2.01,0.0}, {2.04,0.0}, {2.07,0.0}, {2.1,0.0}, {2.13,0.0}, {2.16,0.0}, {2.19,0.0}, {2.22,0.0}, {2.25,0.0}, {2.28,2.0}, {2.31,2.0}, {2.34,2.0}, {2.37,0.0}, {2.4,0.0}, {2.43,0.0}, {2.46,0.0}, {2.49,7.0}, {2.52,1.0}, {2.55,0.0}, {2.58,0.0}, {2.61,4.0}, {2.64,7.0}, {2.67,0.0}, {2.7,1.0}, {2.73,0.0}, {2.76,0.0}, {2.79,3.0}, {2.82,0.0}, {2.85,0.0}, {2.88,0.0}, {2.91,0.0}, {2.94,0.0}, {2.97,9.0}, {3.0,8.0}, {3.03,4.0}, {3.06,0.0}, {3.09,2.0}, {3.12,4.0}, {3.15,8.0}, {3.18,5.0}, {3.21,4.0}, {3.24,0.0}, {3.27,0.0}, {3.3,3.0}, {3.33,7.0}, {3.36,7.0}, {3.39,4.0}, {3.42,0.0}, {3.45,0.0}, {3.48,1.0}, {3.51,0.0}, {3.54,0.0}, {3.57,0.0}, {3.6,0.0}, {3.63,12.0}, {3.66,6.0}, {3.69,0.0}, {3.72,0.0}, {3.75,0.0}, {3.78,0.0}, {3.81,0.0}, {3.84,0.0}, {3.87,12.0}, {3.9,15.0}, {3.93,15.0}, {3.96,3.0}, {3.99,2.0}, {4.02,0.0}, {4.05,0.0}, {4.08,0.0}, {4.11,0.0}, {4.14,0.0}, {4.17,0.0}, {4.2,0.0}, {4.23,0.0}, {4.26,0.0}, {4.29,1.0}, {4.32,0.0}, {4.35,1.0} }}"

  # - id: incline_profile_map_sipailovo_Kashkadan_1_72km_2d
  #   type: float[58][2]
  #   restore_value: no
  #   initial_value: "{{ {0.0,3.0}, {0.03,0.0}, {0.06,0.0}, {0.09,6.0}, {0.12,0.0}, {0.15,0.0}, {0.18,0.0}, {0.21,7.0}, {0.24,15.0}, {0.27,15.0}, {0.3,15.0}, {0.33,8.0}, {0.36,7.0}, {0.39,1.0}, {0.42,7.0}, {0.45,2.0}, {0.48,5.0}, {0.51,1.0}, {0.54,0.0}, {0.57,2.0}, {0.6,5.0}, {0.63,8.0}, {0.66,3.0}, {0.69,0.0}, {0.72,0.0}, {0.75,0.0}, {0.78,0.0}, {0.81,0.0}, {0.84,0.0}, {0.87,2.0}, {0.9,1.0}, {0.93,0.0}, {0.96,5.0}, {0.99,0.0}, {1.02,0.0}, {1.05,3.0}, {1.08,6.0}, {1.11,0.0}, {1.14,0.0}, {1.17,0.0}, {1.2,0.0}, {1.23,3.0}, {1.26,10.0}, {1.29,0.0}, {1.32,0.0}, {1.35,0.0}, {1.38,0.0}, {1.41,0.0}, {1.44,0.0}, {1.47,5.0}, {1.5,6.0}, {1.53,0.0}, {1.56,0.0}, {1.59,0.0}, {1.62,0.0}, {1.65,10.0}, {1.68,3.0}, {1.71,0.0} }}"

  # - id: incline_profile_zwift_Epic_Run_6_2km
  #   type: float[148][2]
  #   restore_value: no
  #   initial_value: "{{ {0.061,1}, {0.119,0}, {0.128,1}, {0.203,3}, {0.211,4}, {0.219,5}, {0.228,4}, {0.303,5}, {0.336,6}, {0.344,7}, {0.353,8}, {0.361,9}, {0.369,10}, {0.378,12}, {0.386,13}, {0.394,15}, {0.436,13}, {0.453,12}, {0.469,11}, {0.493,13}, {0.503,14}, {0.519,13}, {0.534,14}, {0.551,13}, {0.559,12}, {0.569,10}, {0.576,7}, {0.584,4}, {0.593,1}, {0.603,0}, {0.701,7}, {0.709,14}, {0.718,15}, {0.776,6}, {0.784,0}, {0.851,1}, {0.859,3}, {0.868,5}, {0.876,6}, {0.884,7}, {0.893,8}, {0.909,9}, {0.918,10}, {0.934,12}, {0.951,13}, {0.976,14}, {1.019,13}, {1.026,14}, {1.043,13}, {1.093,12}, {1.109,11}, {1.126,10}, {1.134,9}, {1.143,8}, {1.151,7}, {1.159,6}, {1.168,5}, {1.176,4}, {1.184,3}, {1.201,2}, {1.209,1}, {1.234,0}, {1.309,1}, {1.343,0}, {1.791,2}, {1.799,4}, {1.808,6}, {1.816,8}, {1.824,9}, {1.833,10}, {1.841,11}, {1.849,12}, {1.866,13}, {1.916,12}, {1.941,13}, {1.958,14}, {1.966,13}, {2.008,14}, {2.041,15}, {2.074,14}, {2.091,13}, {2.099,14}, {2.108,13}, {2.166,14}, {2.183,13}, {2.191,14}, {2.199,13}, {2.216,12}, {2.258,13}, {2.266,12}, {2.274,11}, {2.306,10}, {2.324,11}, {2.331,12}, {2.364,13}, {2.373,12}, {2.431,11}, {2.439,12}, {2.464,11}, {2.489,10}, {2.548,11}, {2.576,12}, {2.581,11}, {2.589,12}, {2.614,13}, {2.623,12}, {2.631,13}, {2.639,11}, {2.648,12}, {2.656,11}, {2.689,10}, {2.706,9}, {2.731,8}, {2.748,7}, {2.756,6}, {2.773,5}, {2.781,4}, {2.789,3}, {2.806,2}, {2.831,1}, {2.915,0}, {3.073,1}, {3.081,2}, {3.09,1}, {3.106,0}, {3.205,4}, {3.215,11}, {3.221,15}, {4.286,14}, {4.295,10}, {4.303,6}, {4.313,2}, {4.320,0}, {4.336,2}, {4.353,1}, {4.386,0}, {4.428,1}, {4.436,2}, {4.470,1}, {4.486,0}, {5.751,7}, {5.759,13}, {5.768,15}, {5.826,12}, {5.834,4}, {5.843,1}, {5.851,0}, {6.200,0} }}"


# –°–∫—Ä–∏–ø—Ç—ã
script:
  # –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–µ–≥–æ–≤—É—é –¥–æ—Ä–æ–∂–∫—É –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
  - id: start_manual
    mode: restart
    then:
      - lambda: |-
          id(motor_running) = true;
          id(manual_stop) = false;
          if (id(target_speed) == 0) {
            id(target_speed) = 10;
            id(target_speed_goal) = 10;
          }
          id(set_speed).publish_state(id(target_speed) / 10.0);
          id(remaining_warm_up_time) = 0;
          float run_time = id(set_run_time).state;
          id(remaining_run_time) = (run_time > 0) ? run_time * 60 : 0;
          id(remaining_cool_down_time) = 0;
          id(program_status).publish_state("Manual Mode");
          id(display_nextion).set_component_text("t5", "Manual Mode");
          id(control_mode) = 0;  // –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º
          id(auto_mode) = false;
          ESP_LOGI("Manual", "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º (control_mode = 0), –∏–∫–æ–Ω–∫–∞ 62");

          // Fitness Machine Status: Started or Resumed (0x04)
          std::vector<uint8_t> status = {0x04};
          id(ftms_status_char).set_value(status);
          id(ftms_status_char).notify();
          id(last_ftms_status) = status;
          id(ftms_status_sensor).publish_state(id(ftms_status_to_string)(0x04));
          ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Started or Resumed (0x04)");

          // Training Status: Manual Mode (0x0D)
          std::vector<uint8_t> training_status = {0x00, 0x0D};
          id(training_status_char).set_value(training_status);
          id(training_status_char).notify();
          id(last_training_status) = training_status;
          id(training_status_sensor).publish_state(id(training_status_to_string)(0x0D));
          ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Manual Mode (0x0D)");

          if (!id(speed).state) {
            id(display_nextion).send_command_printf("page 1");
            ESP_LOGI("Nextion", "–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É 1");
          }

# –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
  - id: start_program
    then:
      - lambda: |-
          id(motor_running) = true;
          id(manual_stop) = false;
          id(target_speed) = 20; //–Ω–∞—á–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã
          id(target_speed_goal) = 20;
          id(set_speed).publish_state(id(target_speed) / 10.0);

          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º control_mode –∏ –∏–∫–æ–Ω–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã
          std::string program = id(program_select).state;
          if (program == "Pulse Zone" || program == "Fat Burn" || program == "Recovery run") {
            id(control_mode) = 2;  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ –ø—É–ª—å—Å—É
            id(auto_mode) = true;
            id(display_nextion).send_command_printf("speed.p_icon_mode.pic=59"); // –ò–∫–æ–Ω–∫–∞ –¥–ª—è Pulse Zone
            ESP_LOGI("Program", "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä–µ–∂–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ –ø—É–ª—å—Å—É (control_mode = 2), –∏–∫–æ–Ω–∫–∞ 59");
          } else {
            id(control_mode) = 0;  // –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º –¥–ª—è HIIT –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º
            id(auto_mode) = false;
            id(display_nextion).send_command_printf("speed.p_icon_mode.pic=62"); // –ò–∫–æ–Ω–∫–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
            ESP_LOGI("Program", "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º (control_mode = 0), –∏–∫–æ–Ω–∫–∞ 62");
          }

          // Fitness Machine Status: Started or Resumed (0x04)
          if (id(last_ftms_status)[0] != 0x04) {
            std::vector<uint8_t> status = {0x04};
            id(ftms_status_char).set_value(status);
            id(ftms_status_char).notify();
            id(last_ftms_status) = status;
            id(ftms_status_sensor).publish_state(id(ftms_status_to_string)(0x04));
            ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Started or Resumed (0x04)");
          }

          float wu_time = id(set_warm_up_time).state;
          if (wu_time > 0) {
            id(warm_up_active) = true;
            id(remaining_warm_up_time) = wu_time * 60;
            int warm_up_minutes = id(remaining_warm_up_time) / 60;
            int warm_up_seconds = id(remaining_warm_up_time) % 60;
            char buffer[20];
            snprintf(buffer, sizeof(buffer), "Warm-up: (%d:%02d)", warm_up_minutes, warm_up_seconds);
            id(program_status).publish_state(buffer);
            id(display_nextion).set_component_text("t5", buffer);
            ESP_LOGI("DEBUG", "Status updated: %s, length: %d", buffer, strlen(buffer));

            // Training Status: Warming Up (0x02)
            if (id(last_training_status)[1] != 0x02) {
              std::vector<uint8_t> training_status = {0x00, 0x02};
              id(training_status_char).set_value(training_status);
              id(training_status_char).notify();
              id(last_training_status) = training_status;
              id(training_status_sensor).publish_state(id(training_status_to_string)(0x02));
              ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Warming Up (0x02)");
            }
          } else {
            id(warm_up_active) = false;
            id(remaining_warm_up_time) = 0;
            float run_time = id(set_run_time).state;
            id(remaining_run_time) = (run_time > 0) ? run_time * 60 : 0;

            if (program != "None" && id(remaining_run_time) > 0) {
              int remaining_minutes = id(remaining_run_time) / 60;
              int remaining_seconds = id(remaining_run_time) % 60;
              std::string zone = id(zone_select).state;
              char buffer[40];
              std::string short_zone = zone;
              if (zone == "1") short_zone = "Z1";
              else if (zone == "2") short_zone = "Z2";
              else if (zone == "3") short_zone = "Z3";
              else if (zone == "4") short_zone = "Z4";
              else if (zone == "5") short_zone = "Z5";
              if (program == "Pulse Zone") {
                snprintf(buffer, sizeof(buffer), "%s: %.0f-%.0f bpm (%d:%02d)",
                        short_zone.c_str(), id(target_heart_rate_min), id(target_heart_rate_max),
                        remaining_minutes, remaining_seconds);
                //snprintf(buffer, sizeof(buffer), "Pulse Zone, %s: %.0f-%.0f, Run (%d:%02d)",
                        //short_zone.c_str(), id(target_heart_rate_min), id(target_heart_rate_max),
                        //remaining_minutes, remaining_seconds);
              } else {
                snprintf(buffer, sizeof(buffer), "%s, %s: %.0f-%.0f, Run (%d:%02d)",
                        program.c_str(), short_zone.c_str(), id(target_heart_rate_min), id(target_heart_rate_max),
                        remaining_minutes, remaining_seconds);
              }
              id(program_status).publish_state(buffer);
              id(display_nextion).set_component_text("t5", buffer);
              ESP_LOGI("DEBUG", "Status updated: %s, length: %d", buffer, strlen(buffer));

              // Training Status –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã
              uint8_t status_code;
              if (program == "Pulse Zone" || program == "Fat Burn" || program == "Recovery run") {
                status_code = 0x07; // Heart Rate Control
              } else if (program == "HIIT") {
                status_code = 0x04; // High Intensity Interval
              } else {
                status_code = 0x00; // Other
              }
              if (id(last_training_status)[1] != status_code) {
                std::vector<uint8_t> training_status = {0x00, status_code};
                id(training_status_char).set_value(training_status);
                id(training_status_char).notify();
                id(last_training_status) = training_status;
                id(training_status_sensor).publish_state(id(training_status_to_string)(status_code));
                ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: %s (0x%02X)", id(training_status_to_string)(status_code).c_str(), status_code);
              }
            } else {
              id(program_status).publish_state("Program: No duration");
              id(display_nextion).set_component_text("t5", "Program: No duration");
            }
          }

          id(remaining_cool_down_time) = 0;
          id(warm_up_time) = 0;

          if (!id(speed).state) {
            id(display_nextion).send_command_printf("page 1");
            ESP_LOGI("Nextion", "–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É 1");
          }

# –°–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–º —Ä–∞–∑–º–∏–Ω–∫–∏, —É–≤–µ–ª–∏—á–∏–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∑–æ–Ω—ã 1 –ø—É–ª—å—Å–∞, –ø–µ—Ä–µ—Ö–æ–¥—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –∏–ª–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è—Å—å –ø—Ä–∏ –æ—à–∏–±–∫–µ.
  - id: warm_up
    then:
      - lambda: |-
          static int warm_up_time = 0;
          warm_up_time++;
          float heart_rate = id(heart_rate_sensor).state;
          float zone_1_min = id(max_heart_rate) * 0.5;

          // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –Ω–∞ 0.1 –∫–º/—á –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –≤–æ –≤—Ä–µ–º—è —Ä–∞–∑–º–∏–Ω–∫–∏
          if (id(control_mode) != 1 && id(remaining_warm_up_time) > 0 && warm_up_time % 10 == 0 && heart_rate < zone_1_min && !isnan(heart_rate)) {
            if (id(target_speed) < 120) {
              id(target_speed) += 1;
              id(target_speed_goal) = id(target_speed);
              id(set_speed).publish_state(id(target_speed) / 10.0);
              ESP_LOGI("WarmUp", "Increased speed by 0.1 km/h: target_speed=%d", id(target_speed));
            }
          }

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–∑–º–∏–Ω–∫–∏
          if (id(remaining_warm_up_time) <= 0) {
            // –≠—Ç–∞–ø –æ–∂–∏–¥–∞–Ω–∏—è –ø—É–ª—å—Å–∞
            if (heart_rate >= zone_1_min && !isnan(heart_rate)) {
              id(warm_up_active) = false;
              id(program_status).publish_state("Warm-up: Done");
              id(display_nextion).set_component_text("t5", "Warm-up: Done");
              warm_up_time = 0;

              // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ, –µ—Å–ª–∏ –æ–Ω–∞ –≤—ã–±—Ä–∞–Ω–∞
              if (id(program_select).state != "None" && id(remaining_run_time) > 0) {
                std::string program = id(program_select).state;
                std::string zone = id(zone_select).state;
                int remaining_minutes = id(remaining_run_time) / 60;
                int remaining_seconds = id(remaining_run_time) % 60;
                char buffer[40];
                std::string short_zone = zone;
                if (zone == "1") short_zone = "Z1";
                else if (zone == "2") short_zone = "Z2";
                else if (zone == "3") short_zone = "Z3";
                else if (zone == "4") short_zone = "Z4";
                else if (zone == "5") short_zone = "Z5";
                if (program == "Pulse Zone") {
                  snprintf(buffer, sizeof(buffer), "%s: %.0f-%.0f bpm (%d:%02d)",
                          short_zone.c_str(), id(target_heart_rate_min), id(target_heart_rate_max),
                          remaining_minutes, remaining_seconds);
                  //snprintf(buffer, sizeof(buffer), "Pulse Zone, %s: %.0f-%.0f, Run (%d:%02d)",
                          //short_zone.c_str(), id(target_heart_rate_min), id(target_heart_rate_max),
                          //remaining_minutes, remaining_seconds);
                } else {
                  snprintf(buffer, sizeof(buffer), "%s, %s: %.0f-%.0f, Run (%d:%02d)",
                          program.c_str(), short_zone.c_str(), id(target_heart_rate_min), id(target_heart_rate_max),
                          remaining_minutes, remaining_seconds);
                }
                id(program_status).publish_state(buffer);
                id(display_nextion).set_component_text("t5", buffer);
                ESP_LOGI("DEBUG", "Status updated: %s, length: %d", buffer, strlen(buffer));

                uint8_t status_code;
                if (program == "HIIT") {
                  id(interval_time) = 0;
                  id(interval_phase) = "high";
                  status_code = 0x04;
                } else if (program == "Pulse Zone" || program == "Fat Burn" || program == "Recovery run") {
                  status_code = 0x07;
                  id(auto_mode) = true;
                } else {
                  status_code = 0x00;
                }
                if (id(last_training_status)[1] != status_code) {
                  std::vector<uint8_t> training_status = {0x00, status_code};
                  id(training_status_char).set_value(training_status);
                  id(training_status_char).notify();
                  id(last_training_status) = training_status;
                  id(training_status_sensor).publish_state(id(training_status_to_string)(status_code));
                  ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: %s (0x%02X)", id(training_status_to_string)(status_code).c_str(), status_code);
                }

                id(run_program).execute();
              } else {
                if (id(last_training_status)[1] != 0x01) {
                  std::vector<uint8_t> training_status = {0x00, 0x01};
                  id(training_status_char).set_value(training_status);
                  id(training_status_char).notify();
                  id(last_training_status) = training_status;
                  id(training_status_sensor).publish_state(id(training_status_to_string)(0x01));
                  ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Idle (0x01)");
                }
              }
            } else if (warm_up_time >= 60 && isnan(heart_rate)) {
              id(warm_up_active) = false;
              id(motor_running) = false;
              id(target_speed) = 0;
              id(target_speed_goal) = 0;
              id(set_speed).publish_state(0.0);
              id(treadmill_speed_sensor_uart).publish_state(0.0);
              id(program_status).publish_state("Warm-up: No pulse");
              id(display_nextion).set_component_text("t5", "Warm-up: No pulse");
              warm_up_time = 0;
              if (id(last_training_status)[1] != 0x01) {
                std::vector<uint8_t> training_status = {0x00, 0x01};
                id(training_status_char).set_value(training_status);
                id(training_status_char).notify();
                id(last_training_status) = training_status;
                id(training_status_sensor).publish_state(id(training_status_to_string)(0x01));
                ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Idle (0x01)");
              }
              id(stop_program).execute();
              ESP_LOGI("WarmUp", "Stopped: No pulse detected for 60 seconds");
            }
          }

          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–∏—Å–ø–ª–µ—è
          char buffer[32];
          if (id(remaining_warm_up_time) > 0) {
            int remaining_minutes = id(remaining_warm_up_time) / 60;
            int remaining_seconds = id(remaining_warm_up_time) % 60;
            snprintf(buffer, sizeof(buffer), "Warm-up: (%d:%02d)", remaining_minutes, remaining_seconds);
          } else {
            if (isnan(heart_rate)) {
              snprintf(buffer, sizeof(buffer), "Warm-up: Wait pulse");
            } else {
              snprintf(buffer, sizeof(buffer), "Warm-up: Need %.0f bpm", zone_1_min);
            }
          }
          if (warm_up_time % 10 == 0) {
            id(program_status).publish_state(buffer);
            id(display_nextion).set_component_text("t5", buffer);
            ESP_LOGI("DEBUG", "Status updated: %s, length: %d", buffer, strlen(buffer));
          }


# –°–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–º–∏–Ω–∫–æ–π, –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Å–Ω–∏–∂–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è –¥–æ—Ä–æ–∂–∫—É –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏.
  - id: cool_down
    then:
      - lambda: |-
          if (id(control_mode) == 1) {
            ESP_LOGD("CoolDown", "Free Run –∞–∫—Ç–∏–≤–µ–Ω, —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–æ –ø—É–ª—å—Å—É –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
            return;
          }
          float heart_rate = id(heart_rate_sensor).state;
          float zone_1_max = id(max_heart_rate) * 0.6;
          float current_speed_kph = id(target_speed) / 10.0;
          float target_min_speed = 1.0;
          static int speed_adjust_timer = 0;
          static int min_speed_timer = 0;
          static float target_speed_kph = current_speed_kph;

          speed_adjust_timer++;
          if (speed_adjust_timer >= 15 && current_speed_kph > target_min_speed) {
            float speed_step = 0.0;
            if (!isnan(heart_rate)) {
              if (heart_rate > zone_1_max + 10) {
                speed_step = 0.5;
                ESP_LOGI("CoolDown", "High heart rate (>10 above max), decrease speed by 0.5");
              } else if (heart_rate > zone_1_max && heart_rate <= zone_1_max + 10) {
                speed_step = 0.1;
                ESP_LOGI("CoolDown", "High heart rate (‚â§10 above max), decrease speed by 0.1");
              }
            } else {
              speed_step = 0.5;
              ESP_LOGI("CoolDown", "No heart rate, decrease speed by 0.5");
            }
            if (speed_step > 0.0) {
              target_speed_kph -= speed_step;
              if (target_speed_kph < target_min_speed) target_speed_kph = target_min_speed;
              id(target_speed_goal) = (int)(target_speed_kph * 10);
              id(smooth_speed).execute();
              speed_adjust_timer = 0;
              ESP_LOGI("CoolDown", "Decrease speed by %.1f: target_speed_goal=%d", speed_step, id(target_speed_goal));
            }
          }
          if (current_speed_kph <= target_min_speed) {
            min_speed_timer++;
          } else {
            min_speed_timer = 0;
          }
          if (id(target_speed) != id(target_speed_goal)) {
            id(smooth_speed).execute();
          }
          if (id(remaining_cool_down_time) % 10 == 0) {
            int remaining_minutes = id(remaining_cool_down_time) / 60;
            int remaining_seconds = id(remaining_cool_down_time) % 60;
            char buffer[20];
            snprintf(buffer, sizeof(buffer), "Cool-down: (%d:%02d)", remaining_minutes, remaining_seconds);
            id(program_status).publish_state(buffer);
            id(display_nextion).set_component_text("t5", buffer);
            ESP_LOGI("DEBUG", "Status updated: %s, length: %d", buffer, strlen(buffer));
          }
          if (id(last_training_status)[1] != 0x0B) {
            std::vector<uint8_t> training_status = {0x00, 0x0B};
            id(training_status_char).set_value(training_status);
            id(training_status_char).notify();
            id(last_training_status) = training_status;
            id(training_status_sensor).publish_state(id(training_status_to_string)(0x0B));
            ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Cool Down (0x0B)");
          }
          bool pulse_ok = isnan(heart_rate) || heart_rate <= zone_1_max;
          if (id(remaining_cool_down_time) <= 0 || (pulse_ok && min_speed_timer >= 30)) {
            id(motor_running) = false;
            id(target_speed) = 0;
            id(target_speed_goal) = 0;
            id(set_speed).publish_state(0.0);
            id(treadmill_speed_sensor_uart).publish_state(0.0);
            id(program_status).publish_state("Cool-down: Done");
            id(display_nextion).set_component_text("t5", "Cool-down: Done");
            id(stop_program).execute();
            ESP_LOGI("CoolDown", "Cool-down completed");
          }

# –°–∫—Ä–∏–ø—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É, —á–µ—Ä–µ–¥—É—è –≤—ã—Å–æ–∫—É—é –∏ –Ω–∏–∑–∫—É—é –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—É–ª—å—Å–∞.
  - id: interval_training
    then:
      - lambda: |-
          if (id(control_mode) == 1) {
            ESP_LOGD("IntervalTraining", "Free Run –∞–∫—Ç–∏–≤–µ–Ω, —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–æ –ø—É–ª—å—Å—É –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
            return;
          }
          id(interval_time)++;
          const char* phase = id(interval_phase).c_str();
          int phase_duration = 60;
          float heart_rate = id(heart_rate_sensor).state;
          float zone_1_min = id(max_heart_rate) * 0.5;
          float zone_1_max = id(max_heart_rate) * 0.6;
          float zone_4_min = id(max_heart_rate) * 0.8;
          if (strcmp(phase, "high") == 0) {
            id(zone_select).publish_state("4");
            id(target_heart_rate_min) = zone_4_min;
            id(target_heart_rate_max) = id(max_heart_rate) * 0.9;
          } else {
            id(zone_select).publish_state("1");
            id(target_heart_rate_min) = zone_1_min;
            id(target_heart_rate_max) = zone_1_max;
          }
          if (id(interval_time) % 10 == 0 && !isnan(heart_rate)) {
            int step = (abs(heart_rate - id(target_heart_rate_min)) >= 15) ? 5 : 1;
            if (strcmp(phase, "high") == 0 && heart_rate < zone_4_min && id(target_speed_goal) < 120) {
              id(target_speed_goal) += step;
              ESP_LOGI("IntervalTraining", "High phase, increase speed by %.1f: target_speed_goal=%d", step / 10.0, id(target_speed_goal));
            } else if (strcmp(phase, "low") == 0 && heart_rate > zone_1_max && id(target_speed_goal) > 6) {
              id(target_speed_goal) -= step;
              ESP_LOGI("IntervalTraining", "Low phase, decrease speed by %.1f: target_speed_goal=%d", step / 10.0, id(target_speed_goal));
            }
            id(smooth_speed).execute();
          }
          bool in_target_zone = (strcmp(phase, "high") == 0 && heart_rate >= zone_4_min) ||
                                (strcmp(phase, "low") == 0 && heart_rate >= zone_1_min && heart_rate <= zone_1_max);
          if (id(interval_time) >= phase_duration && in_target_zone) {
            id(interval_time) = 0;
            id(interval_phase) = (strcmp(phase, "high") == 0) ? "low" : "high";
            uint8_t status_code = (strcmp(phase, "high") == 0) ? 0x03 : 0x04;
            std::vector<uint8_t> training_status = {0x00, status_code};
            id(training_status_char).set_value(training_status);
            id(training_status_char).notify();
            id(last_training_status) = training_status;
            id(training_status_sensor).publish_state(id(training_status_to_string)(status_code));
            ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: %s (0x%02X)", id(training_status_to_string)(status_code).c_str(), status_code);
          }

# –°–∫—Ä–∏–ø—Ç –ø–ª–∞–≤–Ω–æ —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –∫ —Ü–µ–ª–µ–≤–æ–π —Å —à–∞–≥–æ–º 0.1 –∫–º/—á.
  - id: smooth_speed
    mode: queued
    then:
      - lambda: |-
          if (id(control_mode) == 1) {
            ESP_LOGD("SmoothSpeed", "Free Run –∞–∫—Ç–∏–≤–µ–Ω, smooth_speed –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è");
            return;
          }
          ESP_LOGI("SmoothSpeed", "target_speed=%d, target_speed_goal=%d", id(target_speed), id(target_speed_goal));
          if (id(target_speed) < id(target_speed_goal)) {
            id(target_speed) += 1;
            if (id(target_speed) > id(target_speed_goal)) id(target_speed) = id(target_speed_goal);
          } else if (id(target_speed) > id(target_speed_goal)) {
            id(target_speed) -= 1;
            if (id(target_speed) < id(target_speed_goal)) id(target_speed) = id(target_speed_goal);
            if (id(target_speed) < 6) id(target_speed) = 6; // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∞–¥–µ–Ω–∏—è –Ω–∏–∂–µ 0.6 –∫–º/—á
          }
          id(motor_running) = true;
          id(set_speed).publish_state(id(target_speed) / 10.0);
          char buffer[13];
          snprintf(buffer, sizeof(buffer), "[SETSPD:%03d]", id(target_speed));
          id(uart_bus)->write_str(buffer);
          ESP_LOGI("SmoothSpeed", "Speed sent: %s", buffer);
          // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ FTMS
          int ftms_speed = id(target_speed) * 10;
          std::vector<uint8_t> status = {0x05, (uint8_t)(ftms_speed & 0xFF), (uint8_t)((ftms_speed >> 8) & 0xFF)};
          if (id(last_ftms_status) != status) {
            id(ftms_status_char).set_value(status);
            id(ftms_status_char).notify();
            id(last_ftms_status) = status;
            id(ftms_status_sensor).publish_state(id(ftms_status_to_string)(0x05));
            ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Speed %d (0x05)", ftms_speed);
          }


# –°–∫—Ä–∏–ø—Ç —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç —Ü–µ–ª–µ–≤—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—É–ª—å—Å–∞, —É–≤–µ–ª–∏—á–∏–≤–∞—è –∏–ª–∏ —É–º–µ–Ω—å—à–∞—è –µ—ë, –µ—Å–ª–∏ –ø—É–ª—å—Å –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ –∑–∞–¥–∞–Ω–Ω–æ–π –∑–æ–Ω—ã.
  - id: adjust_speed_by_pulse
    mode: queued
    then:
      - lambda: |-
          if (id(control_mode) == 1) {
            ESP_LOGD("AdjustSpeed", "Free Run –∞–∫—Ç–∏–≤–µ–Ω, —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–æ –ø—É–ª—å—Å—É –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
            return;
          }
          static int pulse_out_of_zone_count = 0;
          float heart_rate = id(heart_rate_sensor).state;
          ESP_LOGI("AdjustSpeed", "heart_rate=%.0f, target_speed_goal=%d, target_speed=%d, min_hr=%.0f, max_hr=%.0f", 
                   heart_rate, id(target_speed_goal), id(target_speed), id(target_heart_rate_min), id(target_heart_rate_max));
          if (isnan(heart_rate)) {
            id(target_speed_goal) = 10;
            id(target_speed) = 10;
            id(set_speed).publish_state(1.0);
            id(motor_running) = true;
            ESP_LOGI("AdjustSpeed", "No heart rate, set target_speed_goal=10");
          } else if (heart_rate >= id(target_heart_rate_min) && heart_rate <= id(target_heart_rate_max)) {
            pulse_out_of_zone_count = 0;
            ESP_LOGI("AdjustSpeed", "Heart rate in zone, no change");
          } else {
            pulse_out_of_zone_count++;
            if (pulse_out_of_zone_count >= 2) {
              if (heart_rate < id(target_heart_rate_min)) {
                if (heart_rate < (id(target_heart_rate_min) - 10) && id(target_speed_goal) < 120) {
                  id(target_speed_goal) += 5;
                  ESP_LOGI("AdjustSpeed", "Low heart rate (<10 below min), increase speed by 0.5: target_speed_goal=%d", id(target_speed_goal));
                } else if (id(target_speed_goal) < 120) {
                  id(target_speed_goal) += 1;
                  ESP_LOGI("AdjustSpeed", "Low heart rate, increase speed by 0.1: target_speed_goal=%d", id(target_speed_goal));
                }
              } else if (heart_rate > id(target_heart_rate_max)) {
                if (heart_rate <= (id(target_heart_rate_max) + 10) && id(target_speed_goal) > 6) {
                  id(target_speed_goal) -= 1;
                  ESP_LOGI("AdjustSpeed", "High heart rate (‚â§10 above max), decrease speed by 0.1: target_speed_goal=%d", id(target_speed_goal));
                } else if (heart_rate > (id(target_heart_rate_max) + 10) && id(target_speed_goal) > 6) {
                  id(target_speed_goal) -= 5;
                  if (id(target_speed_goal) < 6) id(target_speed_goal) = 6;
                  ESP_LOGI("AdjustSpeed", "High heart rate (>10 above max), decrease speed by 0.5: target_speed_goal=%d", id(target_speed_goal));
                }
              }
              pulse_out_of_zone_count = 0;
              // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è target_speed —Å target_speed_goal —á–µ—Ä–µ–∑ smooth_speed
              id(smooth_speed).execute();
            }
          }

# –°–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Å—Ç—å—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—è –≤—Ä–µ–º—è –∏ –ø–µ—Ä–µ—Ö–æ–¥—è –∫ –∑–∞–º–∏–Ω–∫–µ –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏.
  - id: run_program
    then:
      - lambda: |-
          // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç—å—é, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω Free Run
          if (id(control_mode) == 1) {
            ESP_LOGD("Program", "Free Run –∞–∫—Ç–∏–≤–µ–Ω, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ –ø—É–ª—å—Å—É –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
          } else {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º auto_mode –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º, –∑–∞–≤–∏—Å—è—â–∏—Ö –æ—Ç –ø—É–ª—å—Å–∞
            std::string program = id(program_select).state;
            if (program == "Pulse Zone" || program == "Fat Burn" || program == "Recovery run") {
              id(auto_mode) = true;
            } else {
              id(auto_mode) = false;
            }
          }

          // –û—Ç—Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
          id(remaining_run_time)--;
          if (id(remaining_run_time) % 60 == 0 || id(remaining_run_time) == 0) {
            int remaining_minutes = id(remaining_run_time) / 60;
            id(set_run_time).publish_state((float)remaining_minutes);
          }

          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
          if (id(remaining_run_time) % 10 == 0 || id(remaining_run_time) == 0) {
            int remaining_minutes = id(remaining_run_time) / 60;
            int remaining_seconds = id(remaining_run_time) % 60;
            std::string program = id(program_select).state;
            std::string zone = id(zone_select).state;
            std::string short_zone = zone;
            if (zone == "1") short_zone = "Z1";
            else if (zone == "2") short_zone = "Z2";
            else if (zone == "3") short_zone = "Z3";
            else if (zone == "4") short_zone = "Z4";
            else if (zone == "5") short_zone = "Z5";
            char buffer[40];
            if (program == "Pulse Zone") {
              snprintf(buffer, sizeof(buffer), "%s: %.0f-%.0f bpm (%d:%02d)",
                      short_zone.c_str(), id(target_heart_rate_min), id(target_heart_rate_max),
                      remaining_minutes, remaining_seconds);
              //snprintf(buffer, sizeof(buffer), "Pulse Zone, %s: %.0f-%.0f, Run (%d:%02d)",
                       //short_zone.c_str(), id(target_heart_rate_min), id(target_heart_rate_max),
                       //remaining_minutes, remaining_seconds);
            } else {
              snprintf(buffer, sizeof(buffer), "%s, %s: %.0f-%.0f, Run (%d:%02d)",
                       program.c_str(), short_zone.c_str(), id(target_heart_rate_min), id(target_heart_rate_max),
                       remaining_minutes, remaining_seconds);
            }
            id(program_status).publish_state(buffer);
            id(display_nextion).set_component_text("t5", buffer);
            ESP_LOGI("DEBUG", "Status updated: %s, length: %d", buffer, strlen(buffer));

            uint8_t status_code;
            if (program == "Pulse Zone" || program == "Fat Burn" || program == "Recovery run") {
              status_code = 0x07;
            } else if (program == "HIIT") {
              status_code = (id(interval_phase) == "high") ? 0x04 : 0x03;
            } else {
              status_code = 0x00;
            }
            if (id(last_training_status)[1] != status_code) {
              std::vector<uint8_t> training_status = {0x00, status_code};
              id(training_status_char).set_value(training_status);
              id(training_status_char).notify();
              id(last_training_status) = training_status;
              id(training_status_sensor).publish_state(id(training_status_to_string)(status_code));
              ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: %s (0x%02X)", id(training_status_to_string)(status_code).c_str(), status_code);
            }
          }

          // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∑–∞–º–∏–Ω–∫–µ
          if (id(remaining_run_time) <= 0 && id(program_select).state != "None") {
            float cool_down_time = id(set_cool_down_time).state;
            if (cool_down_time > 0) {
              id(remaining_cool_down_time) = cool_down_time * 60;
              int cool_down_minutes = id(remaining_cool_down_time) / 60;
              int cool_down_seconds = id(remaining_cool_down_time) % 60;
              char buffer[20];
              snprintf(buffer, sizeof(buffer), "Cool-down: (%d:%02d)", cool_down_minutes, cool_down_seconds);
              id(program_status).publish_state(buffer);
              id(display_nextion).set_component_text("t5", buffer);
              ESP_LOGI("DEBUG", "Status updated: %s, length: %d", buffer, strlen(buffer));
              id(cool_down).execute();
            } else {
              id(remaining_cool_down_time) = 0;
              id(motor_running) = false;
              id(target_speed) = 0;
              id(target_speed_goal) = 0;
              id(set_speed).publish_state(0.0);
              id(treadmill_speed_sensor_uart).publish_state(0.0);
              id(program_status).publish_state("Program: Done");
              id(stop_program).execute();
            }
          }
          
# –¢–∞–π–º–∞—É—Ç –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è QZ —á—Ç–æ–±—ã –¥–æ—Ä–æ–∂–∫–∞ –Ω–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ä–µ–∂–∏–º–µ –ê–í–¢–û–ù–ê–ö–õ–û–ù–ê –æ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç "Start" (0x07) —á–µ—Ä–µ–∑ FTMS,
# —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ n —Å–µ–∫—É–Ω–¥  id(manual_stop) = false; –µ—Å–ª–∏ —Ñ–ª–∞–≥ true —Ç–æ –¥–æ—Ä–æ–∂–∫–∞ –Ω–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç, –ø–æ—Å–ª–µ –≤—ã–ø–æ–Ω–ª–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –°–¢–û–ü,
# –¥–æ—Ä–æ–∂–∫–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç id(manual_stop) = true, QZ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–±—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–æ —Ñ–≥–∞–Ω —Å—Ç–æ–∏—Ç id(manual_stop) = true –ø–æ—ç—Ç–æ–º—É –Ω–µ –º–æ–∂–µ—Ç
# –∞ —Å–ø—É—Å—Ç—è n —Å–µ–∫—É–Ω–¥ –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç—Å—è –∏ —Ñ–ª–∞–≥ –≤–æ–∑–∞—Ä–∞—â–∞–µ—Ç—Å—è –≤ id(manual_stop) = false; —á—Ç–æ –¥–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞—Ç—å —á–µ—Ä–µ–∑ FTMS
  - id: reset_manual_stop 
    mode: single
    then:
      - delay: 5s
      - lambda: |-
          id(manual_stop) = false;
          ESP_LOGI("treadmill", "manual_stop —Å–±—Ä–æ—à–µ–Ω –≤ 0 –ø–æ—Å–ª–µ 5 —Å–µ–∫—É–Ω–¥");

  - id: stop_program
    mode: single
    then:
      - switch.turn_off: free_running_mode_switch
      - lambda: |-
          // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
          float weight = id(weight_kg).state;
          float last_time = id(total_time_min);
          float last_distance = id(total_distance_km);
          int calories = (int)id(total_calories).state;
          float avg_speed = (id(speed_count) > 0) ? (id(total_speed_sum) / id(speed_count)) : 0;
          float avg_incline = (id(incline_count) > 0) ? (id(total_incline_sum) / id(incline_count)) : 0;
          float avg_heart_rate = (id(heart_rate_count) > 0) ? (id(total_heart_rate_sum) / id(heart_rate_count)) : 0;

          // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
          id(last_time_stored) = last_time;
          id(last_distance_stored) = last_distance;
          id(last_calories_stored) = calories;
          id(avg_speed_stored) = avg_speed;
          id(avg_incline_stored) = avg_incline;
          id(avg_heart_rate_stored) = avg_heart_rate;
          id(max_heart_rate_stored) = id(max_heart_rate_total);
          id(zone1_time_stored) = id(zone1_time);
          id(zone2_time_stored) = id(zone2_time);
          id(zone3_time_stored) = id(zone3_time);
          id(zone4_time_stored) = id(zone4_time);
          id(zone5_time_stored) = id(zone5_time);

          // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
          id(motor_running) = false;
          id(auto_mode) = false;
          id(warm_up_active) = false;
          id(target_speed) = 0;
          id(target_speed_goal) = 0;
          id(set_speed).publish_state(0.0);
          id(set_incline).publish_state(0.0);
          id(treadmill_speed_sensor_uart).publish_state(0.0);

          id(remaining_run_time) = 0;
          id(set_run_time).publish_state(0.0);
          id(remaining_warm_up_time) = 0;
          id(set_warm_up_time).publish_state(0.0);
          id(remaining_cool_down_time) = 0;
          id(set_cool_down_time).publish_state(0.0);
          id(warm_up_time) = 0;
          id(interval_time) = 0;
          id(program_status).publish_state("Idle");
          id(manual_stop) = true;
          id(treadmill_incline_feedback_sensor).publish_state(0.0);
          id(program_select).publish_state("None");
          id(map_select).publish_state("None");

          // –°–±—Ä–æ—Å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
          id(total_time_min) = 0.0;
          id(total_distance_km) = 0.0;
          id(total_speed_sum) = 0.0;
          id(speed_count) = 0;
          id(total_incline_sum) = 0.0;
          id(incline_count) = 0;
          id(total_heart_rate_sum) = 0.0;
          id(heart_rate_count) = 0;
          id(max_heart_rate_total) = 0.0;
          id(zone1_time) = 0;
          id(zone2_time) = 0;
          id(zone3_time) = 0;
          id(zone4_time) = 0;
          id(zone5_time) = 0;
      - delay: 10ms
      - uart.write:
          id: uart_bus
          data: "[SETSPD:000]"
      - logger.log: "treadmill: Stop command sent (1): [SETSPD:000]"
      - delay: 10ms
      - uart.write:
          id: uart_bus
          data: "[SETSPD:000]"
      - logger.log: "treadmill: Stop command sent (2): [SETSPD:000]"
      - delay: 10ms
      - uart.write:
          id: uart_bus
          data: "[SETSPD:000]"
      - logger.log: "treadmill: Stop command sent (3): [SETSPD:000]"
      - delay: 10ms
      - lambda: |-
          if (id(last_ftms_status)[0] != 0x02) {
            std::vector<uint8_t> status = {0x02, 0x01};
            id(ftms_status_char).set_value(status);
            id(ftms_status_char).notify();
            id(last_ftms_status) = status;
            id(ftms_status_sensor).publish_state(id(ftms_status_to_string)(0x02));
            ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Stopped or Paused (0x02)");
          }
      - delay: 10ms
      - lambda: |-
          if (id(last_training_status)[1] != 0x01) {
            std::vector<uint8_t> training_status = {0x00, 0x01};
            id(training_status_char).set_value(training_status);
            id(training_status_char).notify();
            id(last_training_status) = training_status;
            id(training_status_sensor).publish_state(id(training_status_to_string)(0x01));
            ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Idle (0x01)");
          }
      - delay: 10ms
      - lambda: |-
          if (id(speed).state) {
            id(display_nextion).send_command_printf("page 7");
            ESP_LOGI("treadmill", "Nextion switched to page 7");
          }
      - delay: 10ms
      - script.execute: log_workout_summary
      - logger.log: "treadmill: log_workout_summary called"
      - script.execute: update_info_display
      - script.execute: reset_manual_stop 


#–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–Ω–µ –∑–æ–Ω—ã –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏
  - id: safe_stop
    mode: single
    then:
      - lambda: |-
          // –ü—Ä–æ–≤–µ—Ä–∫–∞, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –º–æ—Ç–æ—Ä
          if (!id(motor_running)) {
            ESP_LOGD("SafeStop", "–ú–æ—Ç–æ—Ä –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω, –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è");
            return;
          }

          // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
          float distance_cm = id(my_distance).state; // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö
          float treadmill_len = id(treadmill_length).state; // –î–ª–∏–Ω–∞ –¥–æ—Ä–æ–∂–∫–∏ (120 —Å–º)

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–∞
          if (isnan(distance_cm)) {
            ESP_LOGW("SafeStop", "–û—à–∏–±–∫–∞ –¥–∞—Ç—á–∏–∫–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ—Ä–æ–∂–∫–∏");
            id(free_running_active) = false;
            id(auto_mode) = false;
            id(free_running_mode_switch).turn_off();
            id(stop_program).execute();
            //id(display_nextion).set_component_text("t5", "Sensor Error");
            id(program_status).publish_state("Stopped: Sensor Error");
            return;
          }

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
          if (distance_cm < 0 || distance_cm > treadmill_len) {
            ESP_LOGW("SafeStop", "–ë–µ–≥—É–Ω –≤–Ω–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (%.0f —Å–º), –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ—Ä–æ–∂–∫–∏", distance_cm);
            id(free_running_active) = false;
            id(auto_mode) = false;
            id(free_running_mode_switch).turn_off();
            id(stop_program).execute();
            //id(display_nextion).set_component_text("t5", "Out of Safe Range");
            id(program_status).publish_state("Stopped: Out of Safe Range");
            return;
          }

          ESP_LOGD("SafeStop", "–ë–µ–≥—É–Ω –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–æ–Ω–µ: %.0f —Å–º", distance_cm);

          
# –°–∫—Ä–∏–ø—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ —Å–∫–æ—Ä–æ—Å—Ç–∏, –Ω–∞–∫–ª–æ–Ω–µ, –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏, –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø—É–ª—å—Å–µ –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏ —á–µ—Ä–µ–∑ BLE.
  - id: send_treadmill_data
    then:
      - lambda: |-
          float speed_kph = id(treadmill_speed_sensor_uart).state;
          float incline = id(treadmill_incline_sensor_uart).state;
          float distance_km = id(treadmill_distance_km).state;
          float time_min = id(treadmill_time_min).state;
          float heart_rate = id(heart_rate_sensor).state; // –ß—Ç–µ–Ω–∏–µ –ø—É–ª—å—Å–∞

          if (isnan(speed_kph) || isnan(incline) || isnan(distance_km) || isnan(time_min)) {
            ESP_LOGE("treadmill", "–û–¥–Ω–æ –∏–∑ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Ä–∞–≤–Ω–æ NaN");
            return;
          }

          uint16_t inst_speed = (uint16_t)(speed_kph * 100);       // 0.01 –∫–º/—á, 2 –±–∞–π—Ç–∞
          int16_t inst_incline = (int16_t)(incline * 10);          // 0.1%, 2 –±–∞–π—Ç–∞
          uint32_t total_distance = (uint32_t)(distance_km * 1000); // –º–µ—Ç—Ä—ã, 3 –±–∞–π—Ç–∞
          uint16_t elapsed_time = (uint16_t)(time_min * 60);       // —Å–µ–∫—É–Ω–¥—ã, 2 –±–∞–π—Ç–∞
          uint8_t inst_heart_rate = isnan(heart_rate) ? 0 : (uint8_t)heart_rate; // –ü—É–ª—å—Å, 1 –±–∞–π—Ç

          ESP_LOGD("treadmill", "Speed: %u, Distance: %u, Incline: %d, Time: %u, Heart Rate: %u",
                  inst_speed, total_distance, inst_incline, elapsed_time, inst_heart_rate);

          // –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–ª–∞–≥–∏:
          uint16_t flags = 0x0000;
          if (total_distance > 0) flags |= 0x0004; // Total Distance Present
          flags |= 0x0008; // Incline and Ramp Angle Setting Present
          if (elapsed_time > 0) flags |= 0x0400; // Elapsed Time Present
          if (!isnan(heart_rate) && inst_heart_rate > 0) flags |= 0x0100; // Heart Rate Present

          std::vector<uint8_t> treadmillData;
          // –§–ª–∞–≥–∏ (2 –±–∞–π—Ç–∞, Little Endian)
          treadmillData.push_back(flags & 0xFF);
          treadmillData.push_back((flags >> 8) & 0xFF);

          // 1. Instantaneous Speed (2 –±–∞–π—Ç–∞)
          treadmillData.push_back(inst_speed & 0xFF);
          treadmillData.push_back((inst_speed >> 8) & 0xFF);

          // 2. Total Distance (3 –±–∞–π—Ç–∞)
          if (flags & 0x0004) {
            treadmillData.push_back(total_distance & 0xFF);
            treadmillData.push_back((total_distance >> 8) & 0xFF);
            treadmillData.push_back((total_distance >> 16) & 0xFF);
          }

          // 3. Inclination (2 –±–∞–π—Ç–∞)
          treadmillData.push_back(inst_incline & 0xFF);
          treadmillData.push_back((inst_incline >> 8) & 0xFF);

          // 4. Ramp Angle Setting (2 –±–∞–π—Ç–∞) ‚Äì –∑–∞–≥–ª—É—à–∫–∞
          treadmillData.push_back(0x00);
          treadmillData.push_back(0x00);

          // 6. Heart Rate (1 –±–∞–π—Ç)
          if (flags & 0x0100) {
            treadmillData.push_back(inst_heart_rate);
          }

          // 5. Elapsed Time (2 –±–∞–π—Ç–∞)
          if (flags & 0x0400) {
            treadmillData.push_back(elapsed_time & 0xFF);
            treadmillData.push_back((elapsed_time >> 8) & 0xFF);
          }


          // –õ–æ–≥–∏—Ä—É–µ–º –±–∞–π—Ç—ã
          for (size_t i = 0; i < treadmillData.size(); ++i) {
            ESP_LOGD("treadmill", "Byte %2d: 0x%02X", i, treadmillData[i]);
          }

          id(treadmill_data_char).set_value(treadmillData);
          id(treadmill_data_char).notify();



# –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–æ–Ω—ã –ø—É–ª—å—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏ –ø–æ–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ—Ç–æ–±—Ä–∞–∂–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.
  - id: update_heart_rate_zones
    then:
      - lambda: |-
          float age = id(age_number).state;                                 // –ü–æ–ª—É—á–∞–µ–º –≤–æ–∑—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          if (id(gender_select).state == "Male") {                          // –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—É–ª—å—Å –¥–ª—è –º—É–∂—á–∏–Ω
            id(max_heart_rate) = 214 - (0.8 * age);
          } else {                                                          // –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—É–ª—å—Å –¥–ª—è –∂–µ–Ω—â–∏–Ω
            id(max_heart_rate) = 209 - (0.7 * age);
          }
          int zone = atoi(id(zone_select).state.c_str());                   // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–æ–Ω—ã –ø—É–ª—å—Å–∞
          id(target_heart_rate_min) = id(max_heart_rate) * (0.5 + (zone - 1) * 0.1); // –í—ã—á–∏—Å–ª—è–µ–º –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É –∑–æ–Ω—ã
          id(target_heart_rate_max) = id(max_heart_rate) * (0.6 + (zone - 1) * 0.1); // –í—ã—á–∏—Å–ª—è–µ–º –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É –∑–æ–Ω—ã
          char buffer[100];                                                 // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
          snprintf(buffer, sizeof(buffer), "%s %.0f, HR Zone %d: %.0f‚Äì%.0f bpm",
                  id(gender_select).state.c_str(), age, zone,
                  id(target_heart_rate_min), id(target_heart_rate_max));

          id(selected_data).publish_state(buffer);                          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å–µ–Ω—Å–æ—Ä –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ




#–°–∫—Ä–∏–ø—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ –¥–∏—Å–ø–ª–µ–π –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
  - id: update_info_display
    then:
      - lambda: |-
          // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞—Ä–∞–Ω–µ–µ
          float last_time = id(last_time_stored); // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–Ω—É—Ç–∞—Ö
          float last_distance = id(last_distance_stored); // –î–∏—Å—Ç–∞–Ω—Ü–∏—è –≤ –∫–º
          int calories = id(last_calories_stored); // –ö–∞–ª–æ—Ä–∏–∏ –≤ –∫–∫–∞–ª
          float avg_speed = id(avg_speed_stored); // –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤ –∫–º/—á
          float avg_incline = id(avg_incline_stored); // –°—Ä–µ–¥–Ω–∏–π –Ω–∞–∫–ª–æ–Ω –≤ %
          float avg_heart_rate = id(avg_heart_rate_stored); // –°—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å
          float max_heart_rate = id(max_heart_rate_stored); // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—É–ª—å—Å
          float fat_grams = id(fat_grams_stored); // –°–æ–∂–∂—ë–Ω–Ω—ã–π –∂–∏—Ä –≤ –≥—Ä–∞–º–º–∞—Ö
          int zone1_time = id(zone1_time_stored) < 0 ? 0 : id(zone1_time_stored); // –í—Ä–µ–º—è –≤ –∑–æ–Ω–µ 1
          int zone2_time = id(zone2_time_stored) < 0 ? 0 : id(zone2_time_stored); // –í—Ä–µ–º—è –≤ –∑–æ–Ω–µ 2
          int zone3_time = id(zone3_time_stored) < 0 ? 0 : id(zone3_time_stored); // –í—Ä–µ–º—è –≤ –∑–æ–Ω–µ 3
          int zone4_time = id(zone4_time_stored) < 0 ? 0 : id(zone4_time_stored); // –í—Ä–µ–º—è –≤ –∑–æ–Ω–µ 4
          int zone5_time = id(zone5_time_stored) < 0 ? 0 : id(zone5_time_stored); // –í—Ä–µ–º—è –≤ –∑–æ–Ω–µ 5
          const char* gender = id(gender_select).state.c_str(); // –ü–æ–ª
          float age = id(age_number).state; // –í–æ–∑—Ä–∞—Å—Ç
          float weight = id(weight_kg).state; // –í–µ—Å

          // --- –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ info ---
          // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –¥–ª—è –∑–æ–Ω
          int total_zone_time = zone1_time + zone2_time + zone3_time + zone4_time + zone5_time;
          int percent_zone1 = total_zone_time > 0 ? (zone1_time * 100) / total_zone_time : 0;
          int percent_zone2 = total_zone_time > 0 ? (zone2_time * 100) / total_zone_time : 0;
          int percent_zone3 = total_zone_time > 0 ? (zone3_time * 100) / total_zone_time : 0;
          int percent_zone4 = total_zone_time > 0 ? (zone4_time * 100) / total_zone_time : 0;
          int percent_zone5 = total_zone_time > 0 ? (zone5_time * 100) / total_zone_time : 0;

          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–∞ –¥–ª—è –∑–æ–Ω
          char t0_txt[10], t1_txt[10], t2_txt[10], t3_txt[10], t4_txt[10];
          snprintf(t0_txt, sizeof(t0_txt), "%d:%02d", zone1_time / 60, zone1_time % 60);
          snprintf(t1_txt, sizeof(t1_txt), "%d:%02d", zone2_time / 60, zone2_time % 60);
          snprintf(t2_txt, sizeof(t2_txt), "%d:%02d", zone3_time / 60, zone3_time % 60);
          snprintf(t3_txt, sizeof(t3_txt), "%d:%02d", zone4_time / 60, zone4_time % 60);
          snprintf(t4_txt, sizeof(t4_txt), "%d:%02d", zone5_time / 60, zone5_time % 60);

          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ–±—â–µ–µ –≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
          int total_minutes = static_cast<int>(last_time);
          int total_seconds = static_cast<int>((last_time - total_minutes) * 60);
          char t5_txt[10];
          snprintf(t5_txt, sizeof(t5_txt), "%02d:%02d", total_minutes, total_seconds);

          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è info
          char t6_txt[10], t7_txt[10], t8_txt[10], t9_txt[10];
          snprintf(t6_txt, sizeof(t6_txt), "%.2f", last_distance);
          snprintf(t7_txt, sizeof(t7_txt), "%d", calories);
          snprintf(t8_txt, sizeof(t8_txt), "%.0f", avg_heart_rate);
          snprintf(t9_txt, sizeof(t9_txt), "%.0f", max_heart_rate);

          // --- –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ avgsummary ---
          // –í—ã—á–∏—Å–ª—è–µ–º MET –∏ VO2
          float avg_met = (id(met_count) > 0) ? (id(total_met_sum) / id(met_count)) : 0;
          float real_incline = avg_incline / 3.0f;
          float speed_m_per_min = avg_speed * 1000.0f / 60.0f;
          float grade = real_incline / 100.0f;
          float vo2 = 0.1f * speed_m_per_min + 1.8f * speed_m_per_min * grade + 3.5f;

          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è avgsummary
          char duration_txt[10], distance_txt[10], speed_txt[10], incline_txt[10], met_txt[10], vo2_txt[10], calories_txt[10], fat_txt[10], user_txt[20];
          snprintf(duration_txt, sizeof(duration_txt), "%02d:%02d", total_minutes, total_seconds);
          snprintf(distance_txt, sizeof(distance_txt), "%.2f", last_distance);
          snprintf(speed_txt, sizeof(speed_txt), "%.1f", avg_speed);
          snprintf(incline_txt, sizeof(incline_txt), "%.1f", avg_incline);
          snprintf(met_txt, sizeof(met_txt), "%.2f", avg_met);
          snprintf(vo2_txt, sizeof(vo2_txt), "%.1f", vo2);
          snprintf(calories_txt, sizeof(calories_txt), "%d", calories);
          snprintf(fat_txt, sizeof(fat_txt), "%.1f", fat_grams);
          snprintf(user_txt, sizeof(user_txt), "%s %.0f, %.0fkg", gender, age, weight);

          // --- –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –≤–∫–ª–∞–¥–∫—É info ---
          id(display_nextion).send_command_printf("info.j0.val=%d", percent_zone1);
          id(display_nextion).send_command_printf("info.j1.val=%d", percent_zone2);
          id(display_nextion).send_command_printf("info.j2.val=%d", percent_zone3);
          id(display_nextion).send_command_printf("info.j3.val=%d", percent_zone4);
          id(display_nextion).send_command_printf("info.j4.val=%d", percent_zone5);

          id(display_nextion).send_command_printf("info.t0.txt=\"%s\"", t0_txt);
          id(display_nextion).send_command_printf("info.t1.txt=\"%s\"", t1_txt);
          id(display_nextion).send_command_printf("info.t2.txt=\"%s\"", t2_txt);
          id(display_nextion).send_command_printf("info.t3.txt=\"%s\"", t3_txt);
          id(display_nextion).send_command_printf("info.t4.txt=\"%s\"", t4_txt);
          id(display_nextion).send_command_printf("info.t5.txt=\"%s\"", t5_txt);
          id(display_nextion).send_command_printf("info.t6.txt=\"%s\"", t6_txt);
          id(display_nextion).send_command_printf("info.t7.txt=\"%s\"", t7_txt);
          id(display_nextion).send_command_printf("info.t8.txt=\"%s\"", t8_txt);
          id(display_nextion).send_command_printf("info.t9.txt=\"%s\"", t9_txt);

          // --- –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –≤–∫–ª–∞–¥–∫—É avgsummary ---
          id(display_nextion).send_command_printf("avgsummary.t0.txt=\"%s\"", duration_txt);
          id(display_nextion).send_command_printf("avgsummary.t1.txt=\"%s\"", distance_txt);
          id(display_nextion).send_command_printf("avgsummary.t2.txt=\"%s\"", speed_txt);
          id(display_nextion).send_command_printf("avgsummary.t3.txt=\"%s\"", incline_txt);
          id(display_nextion).send_command_printf("avgsummary.t4.txt=\"%s\"", met_txt);
          id(display_nextion).send_command_printf("avgsummary.t5.txt=\"%s\"", vo2_txt);
          id(display_nextion).send_command_printf("avgsummary.t6.txt=\"%s\"", calories_txt);
          id(display_nextion).send_command_printf("avgsummary.t7.txt=\"%s\"", fat_txt);
          id(display_nextion).send_command_printf("avgsummary.t8.txt=\"%s\"", user_txt);
          id(display_nextion).send_command_printf("avgsummary.t9.txt=\"%s\"", t8_txt);


  - id: log_workout_summary
    then:
      - lambda: |-
          // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞
          std::string combined_log;

          // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
          char buffer[256];
          const char* gender = id(gender_select).state.c_str();
          float age = id(age_number).state;
          float weight = id(weight_kg).state;
          float max_hr = id(max_heart_rate);
          float avg_met = (id(met_count) > 0) ? (id(total_met_sum) / id(met_count)) : 0;
          float avg_incline = id(avg_incline_stored);
          float avg_speed = id(avg_speed_stored);

          // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º VO2
          float real_incline = avg_incline / 3.0f;
          float speed_m_per_min = avg_speed * 1000.0f / 60.0f;
          float grade = real_incline / 100.0f;
          float vo2 = 0.1f * speed_m_per_min + 1.8f * speed_m_per_min * grade + 3.5f;

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –∑–æ–Ω –ø—É–ª—å—Å–∞
          int zone1_time = id(zone1_time_stored) < 0 ? 0 : id(zone1_time_stored);
          int zone2_time = id(zone2_time_stored) < 0 ? 0 : id(zone2_time_stored);
          int zone3_time = id(zone3_time_stored) < 0 ? 0 : id(zone3_time_stored);
          int zone4_time = id(zone4_time_stored) < 0 ? 0 : id(zone4_time_stored);
          int zone5_time = id(zone5_time_stored) < 0 ? 0 : id(zone5_time_stored);

          // –†–∞—Å—á—ë—Ç —Å–æ–∂–∂—ë–Ω–Ω–æ–≥–æ –∂–∏—Ä–∞
          float total_time = id(last_time_stored) * 60; // –û–±—â–µ–µ –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
          float total_calories = id(last_calories_stored);
          float fat_calories = 0.0f;
          if (total_time > 0) {
            // –î–æ–ª–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤ –∫–∞–∂–¥–æ–π –∑–æ–Ω–µ
            float fraction_zone1 = zone1_time / total_time;
            float fraction_zone2 = zone2_time / total_time;
            float fraction_zone3 = zone3_time / total_time;
            float fraction_zone4 = zone4_time / total_time;
            float fraction_zone5 = zone5_time / total_time;

            // –ö–∞–ª–æ—Ä–∏–∏ –ø–æ –∑–æ–Ω–∞–º
            float calories_zone1 = total_calories * fraction_zone1;
            float calories_zone2 = total_calories * fraction_zone2;
            float calories_zone3 = total_calories * fraction_zone3;
            float calories_zone4 = total_calories * fraction_zone4;
            float calories_zone5 = total_calories * fraction_zone5;

            // –ö–∞–ª–æ—Ä–∏–∏ –∏–∑ –∂–∏—Ä–∞ (–ø—Ä–æ—Ü–µ–Ω—Ç—ã: 80%, 65%, 40%, 15%, 5%)
            fat_calories += calories_zone1 * 0.80f;
            fat_calories += calories_zone2 * 0.65f;
            fat_calories += calories_zone3 * 0.40f;
            fat_calories += calories_zone4 * 0.15f;
            fat_calories += calories_zone5 * 0.05f;
          }
          float fat_grams = fat_calories / 9.0f; // 1 –≥ –∂–∏—Ä–∞ = 9 –∫–∫–∞–ª
          id(fat_grams_stored) = fat_grams; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è Nextion

          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –∑–æ–Ω
          char zone1_str[10], zone2_str[10], zone3_str[10], zone4_str[10], zone5_str[10];
          snprintf(zone1_str, sizeof(zone1_str), "%d:%02d", zone1_time / 60, zone1_time % 60);
          snprintf(zone2_str, sizeof(zone2_str), "%d:%02d", zone2_time / 60, zone2_time % 60);
          snprintf(zone3_str, sizeof(zone3_str), "%d:%02d", zone3_time / 60, zone3_time % 60);
          snprintf(zone4_str, sizeof(zone4_str), "%d:%02d", zone4_time / 60, zone4_time % 60);
          snprintf(zone5_str, sizeof(zone5_str), "%d:%02d", zone5_time / 60, zone5_time % 60);

          // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –ª–æ–≥
          combined_log += "Log start\n";
          combined_log += "===== Workout Summary =====\n";
          combined_log += " \n";

          snprintf(buffer, sizeof(buffer), "  User: Gender=%s, Age=%.0f years, Weight=%.1f kg, Max HR=%.0f bpm\n", gender, age, weight, max_hr);
          combined_log += buffer;

          snprintf(buffer, sizeof(buffer), "  Duration: %.2f min (%.0f sec)\n", id(last_time_stored), id(last_time_stored) * 60);
          combined_log += buffer;

          snprintf(buffer, sizeof(buffer), "  Distance: %.2f km\n", id(last_distance_stored));
          combined_log += buffer;

          snprintf(buffer, sizeof(buffer), "  Calories: %d kcal\n", id(last_calories_stored));
          combined_log += buffer;

          snprintf(buffer, sizeof(buffer), "  Fat Burned: %.1f g\n", fat_grams);
          combined_log += buffer;

          snprintf(buffer, sizeof(buffer), "  Avg Speed: %.2f km/h\n", avg_speed);
          combined_log += buffer;

          snprintf(buffer, sizeof(buffer), "  Avg Incline: %.2f%% (Real Incline: %.2f%%)\n", avg_incline, avg_incline / 3.0f);
          combined_log += buffer;

          snprintf(buffer, sizeof(buffer), "  Avg MET: %.2f\n", avg_met);
          combined_log += buffer;

          snprintf(buffer, sizeof(buffer), "  Avg VO2: %.1f ml/kg/min\n", vo2);
          combined_log += buffer;

          snprintf(buffer, sizeof(buffer), "  Avg Heart Rate: %.0f bpm\n", id(avg_heart_rate_stored));
          combined_log += buffer;

          snprintf(buffer, sizeof(buffer), "  Max Heart Rate: %.0f bpm\n", id(max_heart_rate_stored));
          combined_log += buffer;

          snprintf(buffer, sizeof(buffer), "  Heart Rate Zones: Zone1=%s, Zone2=%s, Zone3=%s, Zone4=%s, Zone5=%s\n", zone1_str, zone2_str, zone3_str, zone4_str, zone5_str);
          combined_log += buffer;

          combined_log += " \n";
          combined_log += "===== End of Summary =====\n";

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –ª–æ–≥ –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
          ESP_LOGI("WorkoutSummary", "%s", combined_log.c_str());

          // –û—á–∏—â–∞–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
          combined_log.clear();
          ESP_LOGI("WorkoutSummary", "Log finished and cleared");

  - id: update_incline_by_map
    then:
      - lambda: |-
          struct Map2D { const char* name; const float (*arr)[2]; int len; };
          Map2D maps[] = {
            {"Russia, Ufa 3.4km", incline_profile_map_russia_ufa3_4km_2d, 114},
            {"Russia, Ufa Sipailovo 4.4km", incline_profile_map_sipailovo_circle_4_37km_2d, 146},
            {"Russia, Ufa Kashkadan 1.7km", incline_profile_map_sipailovo_Kashkadan_1_72km_2d, 58},
            {"Zwift Epic Run 6.2km", incline_profile_Epic_Run_6_2km, 149},
            {"Zwift 5K loop 5.0km", incline_profile_5K_loop_5_0km, 67},
            {"Zwift Mountain Mash 5.9km", incline_profile_Mountain_Mash_5_9km, 106},
            {"Zwift Chili Pepper 8.0km", incline_profile_Chili_Pepper_8_0km, 156},
          };
          const int map_count = sizeof(maps) / sizeof(maps[0]);

          const char* selected = id(map_select).state.c_str();
          float cur_km = id(treadmill_distance_km).state;

          for (int m = 0; m < map_count; m++) {
            if (strcmp(selected, maps[m].name) == 0) {
              float last_dist = maps[m].arr[maps[m].len - 1][0];
              if (cur_km >= last_dist) {
                id(set_incline).publish_state(0.0);
                ESP_LOGI("InclineMap", "Map '%s' end reached (%.3f km >= %.3f km)", selected, cur_km, last_dist);
                id(stop_program).execute();
                return;
              }

              float target_inc = maps[m].arr[0][1]; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞
              for (int i = 0; i < maps[m].len; i++) {
                if (cur_km >= maps[m].arr[i][0]) {
                  target_inc = maps[m].arr[i][1];
                } else {
                  break; // –Ω–∞—à–ª–∏ –ø–µ—Ä–≤—É—é —Ç–æ—á–∫—É –¥–∞–ª—å—à–µ —Ç–µ–∫—É—â–µ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
                }
              }

              // –∑–∞—â–∏—Ç–∞ –æ—Ç –≤—ã—Ö–æ–¥–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã
              if (target_inc < 0.0) target_inc = 0.0;
              if (target_inc > 15.0) target_inc = 15.0;

              // –º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
              if (fabs(id(set_incline).state - target_inc) > 0.01) {
                id(set_incline).publish_state(target_inc);
                ESP_LOGI("InclineMap", "Map '%s' dist=%.3f km -> incline=%.2f%%", selected, cur_km, target_inc);
              }
              return;
            }
          }
          ESP_LOGI("InclineMap", "Map '%s' not found", selected);

  # - id: update_incline_by_map
  #   then:
  #     - lambda: |-
  #         struct Map2D { const char* name; const float (*arr)[2]; int len; };
  #         Map2D maps[] = {
  #           {"Russia, Ufa 3.4km", incline_profile_map_russia_ufa3_4km_2d, 114},
  #           {"Russia, Ufa Sipailovo 4.4km", incline_profile_map_sipailovo_circle_4_37km_2d, 146},
  #           {"Russia, Ufa Kashkadan 1.7km", incline_profile_map_sipailovo_Kashkadan_1_72km_2d, 58},
  #           {"Zwift Epic Run 6.2km", incline_profile_zwift_Epic_Run_6_2km, 148},
  #         };
  #         const int map_count = sizeof(maps) / sizeof(maps[0]);

  #         const char* selected = id(map_select).state.c_str();
  #         float cur_km = id(treadmill_distance_km).state;

  #         for (int m = 0; m < map_count; m++) {
  #           if (strcmp(selected, maps[m].name) == 0) {
  #             float last_dist = maps[m].arr[maps[m].len - 1][0];
  #             if (cur_km >= last_dist) {
  #               id(set_incline).publish_state(0.0);
  #               ESP_LOGI("InclineMap", "Map '%s' end reached (%.3f km >= %.3f km)", selected, cur_km, last_dist);
  #               id(stop_program).execute();
  #               return;
  #             }

  #             float target_inc = maps[m].arr[maps[m].len - 1][1];
  #             if (cur_km <= maps[m].arr[0][0]) {
  #               target_inc = maps[m].arr[0][1];
  #             } else {
  #               for (int i = 0; i < maps[m].len - 1; i++) {
  #                 float d0 = maps[m].arr[i][0];
  #                 float d1 = maps[m].arr[i+1][0];
  #                 if (cur_km >= d0 && cur_km <= d1) {
  #                   float inc0 = maps[m].arr[i][1];
  #                   float inc1 = maps[m].arr[i+1][1];
  #                   float t = (d1 - d0) > 1e-6 ? (cur_km - d0) / (d1 - d0) : 0.0;
  #                   target_inc = inc0 + t * (inc1 - inc0);
  #                   break;
  #                 }
  #               }
  #             }

  #             if (target_inc < 0.0) target_inc = 0.0;
  #             if (target_inc > 15.0) target_inc = 15.0;
  #             if (fabs(id(set_incline).state - target_inc) > 0.01) {
  #               id(set_incline).publish_state(target_inc);
  #               ESP_LOGI("InclineMap", "Map '%s' dist=%.3f km -> incline=%.2f%%", selected, cur_km, target_inc);
  #             }
  #             return;
  #           }
  #         }
  #         ESP_LOGI("InclineMap", "Map '%s' not found", selected);

  # - id: update_incline_by_map
  #   then:
  #     - lambda: |-
  #         struct Map2D { const char* name; float (*arr)[2]; int len; };
  #         Map2D maps[] = {
  #           {"Russia, Ufa 3.4km", id(incline_profile_map_russia_ufa3_4km_2d), 114},
  #           {"Russia, Ufa Sipailovo 4.4km", id(incline_profile_map_sipailovo_circle_4_37km_2d), 146},
  #           {"Russia, Ufa Kashkadan 1.7km", id(incline_profile_map_sipailovo_Kashkadan_1_72km_2d), 58},
  #           {"Zwift Epic Run 6.2km", id(incline_profile_zwift_Epic_Run_6_2km), 148},
  #         };
  #         const int map_count = sizeof(maps) / sizeof(maps[0]);

  #         const char* selected = id(map_select).state.c_str();
  #         float cur_km = id(treadmill_distance_km).state;

  #         for (int m = 0; m < map_count; m++) {
  #           if (strcmp(selected, maps[m].name) == 0) {
  #             float last_dist = maps[m].arr[maps[m].len - 1][0];
  #             if (cur_km >= last_dist) {
  #               id(set_incline).publish_state(0.0);
  #               ESP_LOGI("InclineMap", "Map '%s' end reached (%.3f km >= %.3f km)", selected, cur_km, last_dist);
  #               id(stop_program).execute();
  #               return;
  #             }

  #             // –ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏
  #             float target_inc = maps[m].arr[maps[m].len - 1][1];
  #             if (cur_km <= maps[m].arr[0][0]) {
  #               target_inc = maps[m].arr[0][1];
  #             } else {
  #               for (int i = 0; i < maps[m].len - 1; i++) {
  #                 float d0 = maps[m].arr[i][0];
  #                 float d1 = maps[m].arr[i+1][0];
  #                 if (cur_km >= d0 && cur_km <= d1) {
  #                   float inc0 = maps[m].arr[i][1];
  #                   float inc1 = maps[m].arr[i+1][1];
  #                   float t = (d1 - d0) > 1e-6 ? (cur_km - d0) / (d1 - d0) : 0.0;
  #                   target_inc = inc0 + t * (inc1 - inc0);
  #                   break;
  #                 }
  #               }
  #             }

  #             // –≥—Ä–∞–Ω–∏—Ü—ã –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
  #             if (target_inc < 0.0) target_inc = 0.0;
  #             if (target_inc > 15.0) target_inc = 15.0;
  #             if (fabs(id(set_incline).state - target_inc) > 0.01) {
  #               id(set_incline).publish_state(target_inc);
  #               ESP_LOGI("InclineMap", "Map '%s' dist=%.3f km -> incline=%.2f%%", selected, cur_km, target_inc);
  #             }
  #             return;
  #           }
  #         }

  #         ESP_LOGI("InclineMap", "Map '%s' not found", selected);



  - id: free_running_mode
    mode: restart
    then:
      - if:
          condition:
            lambda: |-
              return !id(free_running_active);
          then:
            - lambda: |-
                id(free_running_active) = true;
                id(auto_mode) = false;
                id(motor_running) = true;
                id(manual_stop) = false;
                ESP_LOGI("FreeRunning", "–†–µ–∂–∏–º —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –±–µ–≥–∞ –∑–∞–ø—É—â–µ–Ω");
                float distance_cm = id(my_distance).state; // –ò—Å–ø–æ–ª—å–∑—É–µ–º my_distance (–≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö)
                if (!isnan(distance_cm)) {
                  id(target_distance) = distance_cm; // –¶–µ–ª–µ–≤–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ —Å–º
                  id(smoothed_distance) = distance_cm; // –°–≥–ª–∞–∂–µ–Ω–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ —Å–º
                  //id(display_nextion).set_component_text("t5", "–°–µ—Ä–µ–¥–∏–Ω–∞");
                  ESP_LOGI("FreeRunning", "–ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è: %.0f —Å–º", id(target_distance));
                } else {
                  ESP_LOGW("FreeRunning", "–û—à–∏–±–∫–∞ –¥–∞—Ç—á–∏–∫–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è, –∑–∞–ø—É—Å–∫ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω");
                  //id(display_nextion).set_component_text("t5", "Sensor Error");
                  id(free_running_active) = false;
                  id(free_running_mode_switch).turn_off();
                  id(stop_program).execute();
                  return;
                }
                if (id(target_speed) == 0) {
                  id(target_speed) = 10; // 1.0 –∫–º/—á
                  id(target_speed_goal) = 10;
                  id(set_speed).publish_state(1.0);
                  ESP_LOGI("FreeRunning", "–ù–∞—á–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: 1.0 –∫–º/—á");
                }
                id(program_status).publish_state("Free Running Mode");
                //id(display_nextion).send_command("page 1");
                ESP_LOGI("Nextion", "–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É 1");
                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ FTMS: Started or Resumed (0x04)
                std::vector<uint8_t> status = {0x04};
                id(ftms_status_char).set_value(status);
                id(ftms_status_char).notify();
                id(last_ftms_status) = status;
                id(ftms_status_sensor).publish_state(id(ftms_status_to_string)(0x04));
                ESP_LOGI("FTMS", "–†–µ–∂–∏–º —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –±–µ–≥–∞: –∑–∞–ø—É—â–µ–Ω (0x04)");
          else:
            - lambda: |-
                ESP_LOGW("FreeRunning", "–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è");



  - id: free_running_logic
    mode: single
    then:
      - lambda: |-
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–∂–∏–º–∞
          if (!id(free_running_mode_switch).state || !id(free_running_active)) {
            ESP_LOGW("FreeRunning", "–†–µ–∂–∏–º –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω: switch=%d, active=%d", id(free_running_mode_switch).state, id(free_running_active));
            id(free_running_active) = false;
            id(auto_mode) = false;
            id(free_running_mode_switch).turn_off();
            return;  // –ü—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º, –Ω–µ –≤—ã–∑—ã–≤–∞—è stop_program
          }

          float distance_cm = id(my_distance).state; // –ò—Å–ø–æ–ª—å–∑—É–µ–º my_distance (–≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö)
          // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
          if (id(smoothed_distance) == 0.0) {
            id(smoothed_distance) = distance_cm;
          } else {
            id(smoothed_distance) = 0.3 * distance_cm + 0.7 * id(smoothed_distance);
          }
          float distance = id(smoothed_distance); // –°–≥–ª–∞–∂–µ–Ω–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ —Å–º

          // –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –∑–æ–Ω
          float accel_strong = id(accel_strong_cm).state; // –°–∏–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ (< 30 —Å–º)
          float accel = id(accel_cm).state;               // –£—Å–∫–æ—Ä–µ–Ω–∏–µ (30‚Äì40 —Å–º)
          float decel = id(decel_cm).state;               // –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ (60‚Äì70 —Å–º)
          float decel_strong = id(decel_strong_cm).state; // –°–∏–ª—å–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ (> 70 —Å–º)
          float treadmill_len = id(treadmill_length).state; // –î–ª–∏–Ω–∞ –¥–æ—Ä–æ–∂–∫–∏ (120 —Å–º)

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∑–æ–Ω
          if (accel_strong >= accel || accel > decel || decel >= decel_strong || decel_strong >= treadmill_len) {
            ESP_LOGW("FreeRunning", "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–æ–Ω—ã: —Å–∏–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ=%.0f, —É—Å–∫–æ—Ä–µ–Ω–∏–µ=%.0f, –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ=%.0f, —Å–∏–ª—å–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ=%.0f, –¥–ª–∏–Ω–∞=%.0f",
                     accel_strong, accel, decel, decel_strong, treadmill_len);
            id(free_running_active) = false;
            id(free_running_mode_switch).turn_off();
            id(stop_program).execute();
            //id(display_nextion).set_component_text("t5", "Invalid Zones");
            return;
          }

          // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
          ESP_LOGD("FreeRunning", "–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: %.0f —Å–º, –ó–æ–Ω—ã: —Å–∏–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ <%.0f, —É—Å–∫–æ—Ä–µ–Ω–∏–µ <%.0f, –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ >%.0f, —Å–∏–ª—å–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ >%.0f",
                   distance, accel_strong, accel, decel, decel_strong);


          // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç—å—é
          int current_speed = id(target_speed);
          int new_speed_int = current_speed;
          bool is_accelerating = distance < accel;
          bool is_decelerating = distance > decel;

          if (is_accelerating) {
            new_speed_int += 1; // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–∞ 0.1 –∫–º/—á
            ESP_LOGI("FreeRunning", "–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: %.0f —Å–º, –¢–µ–∫—É—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: %.1f –∫–º/—á, –ù–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: %.1f –∫–º/—á (–£—Å–∫–æ—Ä–µ–Ω–∏–µ)",
                     distance, current_speed / 10.0, new_speed_int / 10.0);
            id(fast_update) = (distance < accel_strong); // –ë—ã—Å—Ç—Ä–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ
          } else if (is_decelerating) {
            new_speed_int -= 1; // –£–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞ 0.1 –∫–º/—á
            ESP_LOGI("FreeRunning", "–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: %.0f —Å–º, –¢–µ–∫—É—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: %.1f –∫–º/—á, –ù–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: %.1f –∫–º/—á (–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ)",
                     distance, current_speed / 10.0, new_speed_int / 10.0);
            id(fast_update) = (distance > decel_strong); // –ë—ã—Å—Ç—Ä–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ
          } else {
            id(fast_update) = false;
            ESP_LOGD("FreeRunning", "–ë–µ–≥—É–Ω –≤ –∑–æ–Ω–µ –∫–æ–º—Ñ–æ—Ä—Ç–∞ (%.0f —Å–º), —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è", distance);
          }

          // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
          if (new_speed_int < 6) new_speed_int = 6; // –ú–∏–Ω. —Å–∫–æ—Ä–æ—Å—Ç—å 0.6 –∫–º/—á
          if (new_speed_int > 180) new_speed_int = 180; // –ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å 18.0 –∫–º/—á

          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
          if (new_speed_int != current_speed) {
            id(target_speed) = new_speed_int;
            id(target_speed_goal) = new_speed_int;
            id(set_speed).publish_state(new_speed_int / 10.0);
            int ftms_speed = new_speed_int * 10;
            std::vector<uint8_t> status = {0x05, (uint8_t)(ftms_speed & 0xFF), (uint8_t)((ftms_speed >> 8) & 0xFF)};
            id(ftms_status_char).set_value(status);
            id(ftms_status_char).notify();
            id(last_ftms_status) = status;
            id(ftms_status_sensor).publish_state(id(ftms_status_to_string)(0x05));
            ESP_LOGI("FreeRunning", "–°–∫–æ—Ä–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ %.1f –∫–º/—á", new_speed_int / 10.0);
            char speed_buffer[13];
            snprintf(speed_buffer, sizeof(speed_buffer), "[SETSPD:%03d]", new_speed_int);
            id(uart_bus)->write_str(speed_buffer);
            ESP_LOGI("FreeRunning", "–ö–æ–º–∞–Ω–¥–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: %s", speed_buffer);
          } else {
            ESP_LOGD("FreeRunning", "–°–∫–æ—Ä–æ—Å—Ç—å –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å: %.1f –∫–º/—á", new_speed_int / 10.0);
          }


# –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º number.set

  - id: start_calibration
    mode: restart
    then:
      - lambda: |- 
          id(calibration_active) = true;
          id(calibration_min_distance) = 9999.0;  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
          id(calibration_max_distance) = 0.0;    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
          id(calibration_start_time) = millis(); // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
          id(motor_running) = true;              // –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ—Ç–æ—Ä
          id(manual_stop) = false;               // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä—É—á–Ω—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É
          id(target_speed) = 40;                 // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å 4 –∫–º/—á (40 –≤ —Ñ–æ—Ä–º–∞—Ç–µ 1 –∫–º/—á = 10)
          id(target_speed_goal) = 40;
          id(set_speed).publish_state(4.0);      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
          id(program_status).publish_state("–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞: –ë–µ–≥–∏—Ç–µ –≤ –ø–µ—Ä–µ–¥–Ω–µ–π –∑–æ–Ω–µ");
          id(display_nextion).set_component_text("t_info_calib", "    Step 1:\\rFront zone\\r      30s");
          id(display_nextion).send_command_printf("p_zone.pic=76"); // –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–æ–Ω—ã 
          ESP_LOGI("Calibration", "–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –Ω–∞—á–∞—Ç–∞, —Å–∫–æ—Ä–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ 4 –∫–º/—á");

          // Fitness Machine Status: Started or Resumed (0x04)
          std::vector<uint8_t> status = {0x04};
          id(ftms_status_char).set_value(status);
          id(ftms_status_char).notify();
          id(last_ftms_status) = status;
          id(ftms_status_sensor).publish_state(id(ftms_status_to_string)(0x04));
          ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Started or Resumed (0x04)");

          // Training Status: Other (0x00)
          std::vector<uint8_t> training_status = {0x00, 0x00};
          id(training_status_char).set_value(training_status);
          id(training_status_char).notify();
          id(last_training_status) = training_status;
          id(training_status_sensor).publish_state(id(training_status_to_string)(0x00));
          ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Other (0x00)");
      - delay: 30s  # –ü–µ—Ä–≤—ã–µ 30 —Å–µ–∫—É–Ω–¥ ‚Äî –±–µ–≥ –≤ –ø–µ—Ä–µ–¥–Ω–µ–π –∑–æ–Ω–µ
      - lambda: |- 
          id(program_status).publish_state("–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞: –ë–µ–≥–∏—Ç–µ –≤ –∑–∞–¥–Ω–µ–π –∑–æ–Ω–µ");
          id(display_nextion).set_component_text("t_info_calib", "   Step 2:\\rRear zone\\r     30s");
          id(display_nextion).send_command_printf("p_zone.pic=77"); // –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–æ–Ω—ã 
          ESP_LOGI("Calibration", "–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∑–∞–¥–Ω—é—é –∑–æ–Ω—É");
      - delay: 30s  # –°–ª–µ–¥—É—é—â–∏–µ 30 —Å–µ–∫—É–Ω–¥ ‚Äî –±–µ–≥ –≤ –∑–∞–¥–Ω–µ–π –∑–æ–Ω–µ
      - lambda: |- 
          if (id(calibration_active)) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∏ –ª–∏ —Å–æ–±—Ä–∞–Ω—ã –≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            if (id(calibration_min_distance) < 9999.0 && id(calibration_max_distance) > 0.0) {
              // –û–∫—Ä—É–≥–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–æ–≤
              int min_distance = (int)round(id(calibration_min_distance));
              int max_distance = (int)round(id(calibration_max_distance));

              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è treadmill_slider_min (0‚Äì40)
              if (min_distance >= 0 && min_distance <= 40) {
                auto call = id(treadmill_slider_min).make_call();
                call.set_value(min_distance);
                call.perform();
              } else {
                auto call = id(treadmill_slider_min).make_call();
                call.set_value(25); // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                call.perform();
                ESP_LOGW("Calibration", "–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞: %d —Å–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ 25 —Å–º", min_distance);
              }

              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è treadmill_slider_max (60‚Äì120)
              if (max_distance >= 60 && max_distance <= 120) {
                auto call = id(treadmill_slider_max).make_call();
                call.set_value(max_distance);
                call.perform();
              } else {
                auto call = id(treadmill_slider_max).make_call();
                call.set_value(85); // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                call.perform();
                ESP_LOGW("Calibration", "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞: %d —Å–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ 85 —Å–º", max_distance);
              }

              // –í—ã—á–∏—Å–ª—è–µ–º –¥–ª–∏–Ω—É –¥–æ—Ä–æ–∂–∫–∏: max + 30 —Å–º
              float calculated_treadmill_length = id(calibration_max_distance) + 30.0;
              int treadmill_length_int = (int)round(calculated_treadmill_length);
              if (treadmill_length_int >= 80 && treadmill_length_int <= 140) {
                auto call = id(treadmill_length).make_call();
                call.set_value(treadmill_length_int);
                call.perform();
              } else {
                auto call = id(treadmill_length).make_call();
                call.set_value(100); // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                call.perform();
                ESP_LOGW("Calibration", "–î–ª–∏–Ω–∞ –¥–æ—Ä–æ–∂–∫–∏ –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞: %d —Å–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ 100 —Å–º", treadmill_length_int);
              }

              // –ó–æ–Ω—ã —É—Å–∫–æ—Ä–µ–Ω–∏—è –∏ –∑–∞–º–µ–¥–ª–µ–Ω–∏—è
              float accel_zone = id(calibration_min_distance) + 12.0;
              float decel_zone = id(calibration_max_distance) - 12.0;
              int accel_zone_int = (int)round(accel_zone);
              int decel_zone_int = (int)round(decel_zone);

              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è accel_cm (20‚Äì60)
              if (accel_zone_int >= 20 && accel_zone_int <= 60) {
                auto call = id(accel_cm).make_call();
                call.set_value(accel_zone_int);
                call.perform();
              } else {
                auto call = id(accel_cm).make_call();
                call.set_value(35); // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                call.perform();
                ESP_LOGW("Calibration", "–ó–æ–Ω–∞ —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞: %d —Å–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ 35 —Å–º", accel_zone_int);
              }

              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è decel_cm (60‚Äì90)
              if (decel_zone_int >= 60 && decel_zone_int <= 90) {
                auto call = id(decel_cm).make_call();
                call.set_value(decel_zone_int);
                call.perform();
              } else {
                auto call = id(decel_cm).make_call();
                call.set_value(62); // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                call.perform();
                ESP_LOGW("Calibration", "–ó–æ–Ω–∞ –∑–∞–º–µ–¥–ª–µ–Ω–∏—è –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞: %d —Å–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ 62 —Å–º", decel_zone_int);
              }

              id(program_status).publish_state("–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
              id(display_nextion).set_component_text("t_info_calib", " Calibration\\r  Complete");
              id(display_nextion).send_command_printf("p_zone.pic=75"); // –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–æ–Ω—ã 

              id(display_nextion).set_component_text_printf("caldistspeed.t_speed_up", "%d", (int)id(accel_cm).state);
              id(display_nextion).set_component_text_printf("caldistspeed.t_speed_down", "%d", (int)id(decel_cm).state);
              id(display_nextion).set_component_text_printf("caldistspeed.t_lenght", "%d", (int)id(treadmill_length).state);
              id(display_nextion).set_component_text("b_cal", "Calibrate");

              ESP_LOGI("Calibration", "–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: min=%d —Å–º, max=%d —Å–º, –¥–ª–∏–Ω–∞=%d —Å–º, accel=%d —Å–º, decel=%d —Å–º",
                       min_distance, max_distance, treadmill_length_int, accel_zone_int, decel_zone_int);
            } else {
              id(program_status).publish_state("–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞: –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö");
              id(display_nextion).set_component_text("t_info_calib", "Calibration\\r     Eror");
              ESP_LOGW("Calibration", "–û—à–∏–±–∫–∞: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–∞");
            }

            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–æ—Ä–æ–∂–∫—É
            id(motor_running) = false;
            id(target_speed) = 0;
            id(target_speed_goal) = 0;
            id(set_speed).publish_state(0.0);
            id(treadmill_speed_sensor_uart).publish_state(0.0);
            id(calibration_active) = false;

            // Fitness Machine Status: Stopped or Paused (0x02)
            std::vector<uint8_t> status = {0x02};
            id(ftms_status_char).set_value(status);
            id(ftms_status_char).notify();
            id(last_ftms_status) = status;
            id(ftms_status_sensor).publish_state(id(ftms_status_to_string)(0x02));
            ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Stopped or Paused (0x02)");

            // Training Status: Idle (0x01)
            std::vector<uint8_t> training_status = {0x00, 0x01};
            id(training_status_char).set_value(training_status);
            id(training_status_char).notify();
            id(last_training_status) = training_status;
            id(training_status_sensor).publish_state(id(training_status_to_string)(0x01));
            ESP_LOGI("FTMS", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Idle (0x01)");
          }
      - script.execute: stop_program

# –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
interval:
  - interval: 1s
    id: free_running_interval
    then:
      - if:
          condition:
            lambda: |-
              bool is_active = id(free_running_mode_switch).state && id(free_running_active);
              ESP_LOGD("FreeRunning", "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞: switch=%d, active=%d, is_active=%d, auto_mode=%d",
                       id(free_running_mode_switch).state, id(free_running_active), is_active, id(auto_mode));
              return is_active;
          then:
            - script.execute: free_running_logic
          else:
            - lambda: |-
                if (id(free_running_active)) {
                  ESP_LOGI("FreeRunning", "Free Running Mode –æ—Ç–∫–ª—é—á–µ–Ω: switch=%d, active=%d",
                           id(free_running_mode_switch).state, id(free_running_active));
                  id(free_running_active) = false;
                  id(auto_mode) = false;
                  id(free_running_mode_switch).turn_off(); // –Ø–≤–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º —Å–≤–∏—Ç—á
                  id(stop_program).execute();
                }

  # –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∑–æ–Ω–µ –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏ –∏–Ω–∞—á–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ
  - interval: 1s
    id: safe_stop_interval
    then:
      - if:
          condition:
            lambda: 'return id(motor_running);'
          then:
            - script.execute: safe_stop


  - interval: 800ms
    then:
      - if:
          condition:
            lambda: 'return id(motor_running) && id(target_speed) > 0;'
          then:
            - lambda: |-
                //ESP_LOGI("Interval", "Interval triggered: motor_running=%d, target_speed=%d, warm_up_active=%d, remaining_cool_down_time=%d, auto_mode=%d",
                         //id(motor_running), id(target_speed), id(warm_up_active), id(remaining_cool_down_time), id(auto_mode));
                if (id(target_speed) < 6) {
                  id(target_speed) = 6;
                  ESP_LOGW("Interval", "Target speed below 0.6 km/h, corrected to 0.6 km/h");
                }
                char speed_buffer[13];
                snprintf(speed_buffer, sizeof(speed_buffer), "[SETSPD:%03d]", id(target_speed));
                id(uart_bus)->write_str(speed_buffer);
                //ESP_LOGI("Interval", "Speed command sent: %s", speed_buffer);
          else:
            - lambda: |-
                //ESP_LOGI("Interval", "Interval skipped: motor_running=%d, target_speed=%d, warm_up_active=%d, remaining_cool_down_time=%d, auto_mode=%d",
                         //id(motor_running), id(target_speed), id(warm_up_active), id(remaining_cool_down_time), id(auto_mode));


  - interval: 700ms
    then:
      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–∫–ª–æ–Ω–æ–º
      - lambda: |-
          char incline_buffer[13];
          // –ï—Å–ª–∏ –¥–≤–∏–≥–∞—Ç–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–ª—å –Ω–∞–∫–ª–æ–Ω–∞
          if (id(motor_running)) {
            snprintf(incline_buffer, sizeof(incline_buffer), "[SETINC:%03d]", id(target_incline_goal));
            id(uart_bus)->write_str(incline_buffer);
            //ESP_LOGI("treadmill", "Incline sent (running): %s", incline_buffer);
          }
          // –ï—Å–ª–∏ –¥–≤–∏–≥–∞—Ç–µ–ª—å –≤—ã–∫–ª—é—á–µ–Ω, –Ω–æ –Ω–∞–∫–ª–æ–Ω –µ—â—ë –Ω–µ 0, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ 0
          else if (id(treadmill_incline_feedback_sensor).state > 0) {
            snprintf(incline_buffer, sizeof(incline_buffer), "[SETINC:000]");
            id(uart_bus)->write_str(incline_buffer);
            //ESP_LOGI("treadmill", "Incline sent (reset to 0): %s", incline_buffer);
          }

  # –ò–Ω—Ç–µ—Ä–≤–∞–ª –∑–∞–ø—É—Å–∫–∞–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É (HIIT) –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏–π
  - interval: 1s
    then:
      - if:
          condition:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤—ã–±—Ä–∞–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ HIIT –∏ —Ä–∞–∑–º–∏–Ω–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
            lambda: 'return id(motor_running) && id(program_select).state == "HIIT" && !id(warm_up_active);'
          then:
             # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–∑–∞–º–∏
            - script.execute: interval_training

  # –ò–Ω—Ç–µ—Ä–≤–∞–ª —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ –ø—É–ª—å—Å—É –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Ä–µ–∂–∏–º–µ
  # –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è —Ä–∞–∑–º–∏–Ω–∫–∏ –∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
  - interval: 10s
    then:
      - if:
          condition:
            lambda: 'return id(motor_running);'
          then:
            - lambda: |-
                static int speed_increase_timer = 0;
                speed_increase_timer += 10; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 10 —Å–µ–∫—É–Ω–¥ –∑–∞ –∫–∞–∂–¥—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
                float heart_rate = id(heart_rate_sensor).state;

                // –≠—Ç–∞–ø –æ–∂–∏–¥–∞–Ω–∏—è –ø—É–ª—å—Å–∞ –≤ —Ä–∞–∑–º–∏–Ω–∫–µ
                if (id(control_mode) != 1 && id(warm_up_active) && id(remaining_warm_up_time) <= 0 && id(target_speed) == id(target_speed_goal)) {
                  float zone_1_min = id(max_heart_rate) * 0.5;
                  if (!isnan(heart_rate) && heart_rate < zone_1_min && speed_increase_timer >= 20) {
                    if (id(target_speed_goal) < 120) {
                      id(target_speed_goal) += 5;
                      id(smooth_speed).execute();
                      speed_increase_timer = 0;
                      ESP_LOGI("Interval10s", "Warm-up: Waiting for pulse, increase speed by 0.5, target_speed_goal=%d", id(target_speed_goal));
                    }
                  }
                }
                // –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Ä–µ–∂–∏–º–µ
                else if (id(control_mode) != 1 && id(auto_mode) && !id(warm_up_active) && id(remaining_cool_down_time) <= 0) {
                  id(adjust_speed_by_pulse).execute();
                }

  # –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–ª–∞–≤–Ω–æ –∏–∑–º–µ–Ω—è–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã, –µ—Å–ª–∏ —Ç–µ–∫—É—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ü–µ–ª–µ–≤–æ–π
# –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏
  - interval: 2s
    then:
      - if:
          condition:
            lambda: |-
              return id(motor_running) && id(target_speed) != id(target_speed_goal) && (
                (!id(warm_up_active) && id(remaining_cool_down_time) <= 0) ||
                (id(warm_up_active) && id(remaining_warm_up_time) <= 0)
              );
          then:
            - script.execute: smooth_speed
            - lambda: |-
                //ESP_LOGI("Interval2s", "Smooth speed triggered: target_speed=%d, target_speed_goal=%d", id(target_speed), id(target_speed_goal));
                         

  # –ò–Ω—Ç–µ—Ä–≤–∞–ª —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–∞–∑–º–∏–Ω–∫–æ–π –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É, –æ–±–Ω–æ–≤–ª—è—è –≤—Ä–µ–º—è –∏ –≤—ã–∑—ã–≤–∞—è –ª–æ–≥–∏–∫—É —Ä–∞–∑–º–∏–Ω–∫–∏
  - interval: 1s
    then:
      - if:
          condition:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Ä–∞–∑–º–∏–Ω–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
            lambda: 'return id(motor_running) && id(warm_up_active);'
          then:
            - lambda: |- 
                if (id(remaining_warm_up_time) > 0) {                               // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º—è —Ä–∞–∑–º–∏–Ω–∫–∏
                  id(remaining_warm_up_time)--;                                     // –£–º–µ–Ω—å—à–∞–µ–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –Ω–∞ 1 —Å–µ–∫—É–Ω–¥—É
                  if (id(remaining_warm_up_time) % 60 == 0) {                       // –ö–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫
                    int remaining_minutes = id(remaining_warm_up_time) / 60;        // –í—ã—á–∏—Å–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –º–∏–Ω—É—Ç—ã
                    id(set_warm_up_time).publish_state((float)remaining_minutes);   // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ —Ä–∞–∑–º–∏–Ω–∫–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
                  }
                }
                // –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç —Ä–∞–∑–º–∏–Ω–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç—å—é –∏ –ø—É–ª—å—Å–æ–º
                id(warm_up).execute();

  # –ò–Ω—Ç–µ—Ä–≤–∞–ª —É–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Å—Ç—å—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—è –≤—Ä–µ–º—è
  - interval: 1s
    then:
      - if:
          condition:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å—Ç—å –≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, —Ä–∞–∑–º–∏–Ω–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
            lambda: 'return id(motor_running) && id(remaining_run_time) > 0 && id(remaining_warm_up_time) <= 0 && !id(warm_up_active);'
          then:
            # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –∑–∞–º–∏–Ω–∫–µ
            - script.execute: run_program

  # –ò–Ω—Ç–µ—Ä–≤–∞–ª —É–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–º–∏–Ω–∫–æ–π –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É, —Å–Ω–∏–∂–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –∏ –∑–∞–≤–µ—Ä—à–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
  - interval: 1s
    then:
      - if:
          condition:
            lambda: 'return id(motor_running) && id(remaining_cool_down_time) > 0 && id(remaining_run_time) <= 0;'
          then:
            - lambda: |-
                if (id(remaining_cool_down_time) > 0) {
                  id(remaining_cool_down_time)--; // –£–º–µ–Ω—å—à–∞–µ–º –≤—Ä–µ–º—è
                  if (id(remaining_cool_down_time) % 60 == 0) { // –ö–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
                    int remaining_minutes = id(remaining_cool_down_time) / 60;
                    id(set_cool_down_time).publish_state((float)remaining_minutes); // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫
                  }
                }
            - script.execute: cool_down                        

  # –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –Ω–∞–∫–æ–ª–ø–µ–Ω–∏—è –∏ –ø–æ–¥—Å—á–µ—Ç–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—è–º
  - interval: 1s
    then:
      - lambda: |-
          if (id(motor_running)) {
            id(total_time_min) += 1.0 / 60.0;
            float current_distance = id(treadmill_distance_km).state;
            if (current_distance > 0) id(total_distance_km) = current_distance;

            float current_speed = id(treadmill_speed_sensor_uart).state;
            float current_incline = id(treadmill_incline_sensor_uart).state;
            float current_heart_rate = id(heart_rate_sensor).state;

            if (current_speed > 0) {
              id(total_speed_sum) += current_speed;
              id(speed_count)++;
            }

            if (current_incline >= 0) {
              id(total_incline_sum) += current_incline;
              id(incline_count)++;
            }

            if (current_heart_rate > 0 && !isnan(current_heart_rate)) {
              id(total_heart_rate_sum) += current_heart_rate;
              id(heart_rate_count)++;
              if (current_heart_rate > id(max_heart_rate_total)) id(max_heart_rate_total) = current_heart_rate;
            }

            // –†–∞—Å—á–µ—Ç MET –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—É–ª—å—Å–∞
            if (current_speed > 0 && current_incline >= 0) {
              float real_incline = current_incline / 3.0f;
              float speed_m_per_min = current_speed * 1000.0f / 60.0f;
              float grade = real_incline / 100.0f;
              float vo2 = 0.1f * speed_m_per_min + 1.8f * speed_m_per_min * grade + 3.5f;
              float met = vo2 / 3.5f;
              id(total_met_sum) += met;
              id(met_count)++;
            }

            // –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ –∑–æ–Ω–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–æ–Ω–∞ > 0
            int zone = id(current_zone);
            if (zone == 1) id(zone1_time)++;
            else if (zone == 2) id(zone2_time)++;
            else if (zone == 3) id(zone3_time)++;
            else if (zone == 4) id(zone4_time)++;
            else if (zone == 5) id(zone5_time)++;

            // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
           // ESP_LOGI("Interval", "heart_rate=%.0f, isnan=%d, current_zone=%d, zone1_time=%d, zone2_time=%d, zone3_time=%d, zone4_time=%d, zone5_time=%d",
                    //current_heart_rate, isnan(current_heart_rate), zone, id(zone1_time), id(zone2_time), id(zone3_time), id(zone4_time), id(zone5_time));
          } else {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–æ–Ω—É, –µ—Å–ª–∏ –º–æ—Ç–æ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
            id(current_zone) = 0;
            //ESP_LOGI("Interval", "Motor not running, current_zone reset to 0");
          }

# –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è heart_rate_sensor –ö–æ–º–ø–æ–Ω–µ–Ω—Ç number –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ –ø—É–ª—å—Å–∞
  - interval: 1s
    then:
      - if:
          condition:
            lambda: 'return id(emulate_ble_connected) && id(test_heart_rate).state >= 60 && id(test_heart_rate).state <= 200;'
          then:
            - sensor.template.publish:
                id: heart_rate_sensor
                state: !lambda 'return id(test_heart_rate).state;'
            - lambda: |-
                float heart_rate = id(test_heart_rate).state;
                ESP_LOGD("TEST", "Heart Rate updated to: %.0f bpm", heart_rate);
                // –ü–æ–≤—Ç–æ—Ä—è–µ–º –ª–æ–≥–∏–∫—É –∑–æ–Ω –∏ –¥–∏—Å–ø–ª–µ—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                float max_hr = id(max_heart_rate);
                float min_zone_1 = max_hr * 0.50;
                float max_zone_1 = max_hr * 0.60;
                float min_zone_2 = max_hr * 0.60;
                float max_zone_2 = max_hr * 0.70;
                float min_zone_3 = max_hr * 0.70;
                float max_zone_3 = max_hr * 0.80;
                float min_zone_4 = max_hr * 0.80;
                float max_zone_4 = max_hr * 0.90;
                float min_zone_5 = max_hr * 0.90;
                float max_zone_5 = max_hr;

                int heart_rate_zone = 0;
                if (heart_rate < min_zone_1) {
                  heart_rate_zone = 0;
                } else if (heart_rate < max_zone_1) {
                  heart_rate_zone = 1;
                } else if (heart_rate < max_zone_2) {
                  heart_rate_zone = 2;
                } else if (heart_rate < max_zone_3) {
                  heart_rate_zone = 3;
                } else if (heart_rate < max_zone_4) {
                  heart_rate_zone = 4;
                } else {
                  heart_rate_zone = 5;
                }
                id(current_zone) = heart_rate_zone;
                ESP_LOGD("TEST", "Heart Rate: %.0f, Current Zone: %d", heart_rate, heart_rate_zone);

                if (id(speed).state) {
                  char heart_str[10];
                  sprintf(heart_str, "%.0f", heart_rate);
                  id(display_nextion).send_command_printf("t0.txt=\"%s\"", heart_str);

                  uint16_t picture_id = 7;
                  uint16_t t0_bco = 21162;
                  if (heart_rate < min_zone_1) {
                    picture_id = 7;
                  } else if (heart_rate < max_zone_1) {
                    picture_id = 2;
                    t0_bco = 15487;
                  } else if (heart_rate < max_zone_2) {
                    picture_id = 3;
                    t0_bco = 11744;
                  } else if (heart_rate < max_zone_3) {
                    picture_id = 4;
                    t0_bco = 64992;
                  } else if (heart_rate < max_zone_4) {
                    picture_id = 5;
                    t0_bco = 64294;
                  } else {
                    picture_id = 6;
                    t0_bco = 64040;
                  }
                  id(display_nextion).send_command_printf("p0.pic=%d", picture_id);
                  id(display_nextion).send_command_printf("t0.bco=%d", t0_bco);
                }

# –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –∏–∑–º–∏–Ω–µ–Ω–∏—è –Ω–∞–∫–ª–æ–Ω–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã
  - interval: 5s
    then:
      - if:
          condition:
            lambda: 'return id(motor_running);'
          then:
            - script.execute: update_incline_by_map

# –ö–Ω–æ–ø–∫–∏ –∏ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
button:

  - platform: template
    id: update_nextion_button
    name: Update Nextion
    entity_category: diagnostic
    on_press:
      then:
        - lambda: 'id(display_nextion)->upload_tft();'


  - platform: template
    id: calibration_button
    name: "Start Calibration"
    on_press:
      then:
        - script.execute: start_calibration
        - lambda: |- 
            ESP_LOGI("Nextion", "–ö–Ω–æ–ø–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –Ω–∞–∂–∞—Ç–∞");

  - platform: template
    name: "Start Treadmill"
    id: start_treadmill_button
    on_press:
      - if:
          condition:
            lambda: 'return id(program_select).state != "None";'
          then:
            - script.execute: start_program
          else:
            - script.execute: start_manual

  - platform: template
    name: "Stop Treadmill"
    id: stop_treadmill_button
    on_press:
      - script.execute: stop_program

  - platform: template
    name: "Speed +0.1"
    internal: true
    id: speed_up_button
    on_press:
      - lambda: |-
          if (id(motor_running) && id(target_speed) < 120) {
            id(target_speed) += 1;
            id(target_speed_goal) = id(target_speed);
            id(set_speed).publish_state(id(target_speed) / 10.0);
            //char buffer[13];
            //snprintf BUFFER, sizeof(buffer), "[SETSPD:%03d]", id(target_speed));
            //id(uart_bus)->write_str(buffer);
          }

# –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –Ω–∞ 0.5
  - platform: template
    name: "Speed +0.5"
    internal: true
    id: speed_up_button_large
    on_press:
      - lambda: |-
          if (id(motor_running) && id(target_speed) < 120) {
            id(target_speed) += 5;  // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–∞ 0.5 –∫–º/—á
            id(target_speed_goal) = id(target_speed);
            id(set_speed).publish_state(id(target_speed) / 10.0);
          }

  - platform: template
    name: "Speed -0.1"
    internal: true
    id: speed_down_button
    on_press:
      - lambda: |-
          if (id(motor_running) && id(target_speed) > 6) {
            id(target_speed) -= 1;
            id(target_speed_goal) = id(target_speed);
            id(set_speed).publish_state(id(target_speed) / 10.0);
            //char buffer[13];
            //snprintf(buffer, sizeof(buffer), "[SETSPD:%03d]", id(target_speed));
            //id(uart_bus)->write_str(buffer);
          }


# –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –Ω–∞ 0.5
  - platform: template
    name: "Speed -0.5"
    internal: true
    id: speed_down_button_large
    on_press:
      - lambda: |-
          if (id(motor_running) && id(target_speed) > 6) {
            id(target_speed) -= 5;  // –£–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞ 0.5 –∫–º/—á
            id(target_speed_goal) = id(target_speed);
            id(set_speed).publish_state(id(target_speed) / 10.0);
          }


  - platform: template
    name: "Incline +1"
    internal: true
    id: incline_up_button
    on_press:
      - lambda: |-
          if (id(motor_running)) {
            float current_incline = id(set_incline).state;
            float new_incline = current_incline + 1.0;
            if (new_incline <= 15.0) {
              id(set_incline).publish_state(new_incline);
              ESP_LOGI("treadmill", "Incline increased to %.1f%%", new_incline);
            }
          }

  - platform: template
    name: "Incline -1"
    internal: true
    id: incline_down_button
    on_press:
      - lambda: |-
          if (id(motor_running)) {
            float current_incline = id(set_incline).state;
            float new_incline = current_incline - 1.0;
            if (new_incline >= 0.0) {
              id(set_incline).publish_state(new_incline);
              ESP_LOGI("treadmill", "Incline decreased to %.1f%%", new_incline);
            }
          }

one_wire:
  - platform: gpio
    pin: 21

debug:
  update_interval: 5s  # –∫–∞–∫ —á–∞—Å—Ç–æ –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å

# –°–µ–Ω—Å–æ—Ä—ã
sensor:
  - platform: debug
    free:
      name: "Heap Free"
    block:
      name: "Heap Max Block"
    loop_time:
      name: "Loop Time"
    psram:
      name: "Free PSRAM"
    cpu_frequency:
      name: "CPU Frequency"


# –°–µ–Ω—Å–æ—Ä –¥–ª—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–∞—Ä—Ç—ã
  - platform: nextion
    name: "Map ID"
    id: map_id_sensor
    variable_name: "mapid"
    #update_interval: 1s
    entity_category: diagnostic
    accuracy_decimals: 0
    on_value:
      then:
        - lambda: |-
            if (x == 1) {
              id(map_select).publish_state("Russia, Ufa 3.4km");
            } else if (x == 2) {
              id(map_select).publish_state("Russia, Ufa Sipailovo 4.4km");
            } else if (x == 3) {
              id(map_select).publish_state("Russia, Ufa Kashkadan 1.7km");
            } else if (x == 4) {
              id(map_select).publish_state("Zwift Epic Run 6.2km");
            } else if (x == 5) {
              id(map_select).publish_state("Zwift 5K loop 5.0km");
            } else if (x == 6) {
              id(map_select).publish_state("Zwift Mountain Mash 5.9km");
            } else if (x == 7) {
              id(map_select).publish_state("Zwift Chili Pepper 8.0km");
            }


# –°–µ–Ω—Å–æ—Ä –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ —è—Ä–∫–æ—Å—Ç—å
  - platform: nextion
    id: nextion_slider
    component_name: display.hbright
    entity_category: diagnostic
    name: "Brightness Slider"
    update_interval: 2s
    on_value:
      then:
        - lambda: |-
            id(brightness_level) = (int)x;

  - platform: vl53l1x
    distance_mode: long
    distance:
      entity_category: diagnostic
      name: My Raw Distance
      id: my_raw_distance
      unit_of_measurement: "mm" 
    # range_status:
    #   name: My Range Status
    #   id: my_range_status
    update_interval: 1s


  - platform: template
    id: my_distance
    name: "My Distance"
    unit_of_measurement: "cm"
    state_class: "measurement"
    device_class: "distance"
    accuracy_decimals: 0
    lambda: |-
      return id(my_raw_distance).state / 10.0;
    filters:
      - delta: 1.0
    update_interval: 1s
    on_value:
      then:
        - lambda: |-
            float distance = x;
            int position_value = (int)distance;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏—Å–ø–ª–µ—è Nextion
            id(display_nextion).send_command_printf("position=%d", position_value);
            id(display_nextion).send_command_printf("caldistspeed.ndist.val=%d", position_value);

            // –õ–æ–≥–∏–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
            if (id(calibration_active)) {
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ä–∞–∑—É–º–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ (0‚Äì150 —Å–º)
              if (distance > 0.0 && distance < 150.0) {
                if (distance < id(calibration_min_distance)) {
                  id(calibration_min_distance) = distance;
                  ESP_LOGD("Calibration", "–ù–æ–≤–æ–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ: %.1f —Å–º", distance);
                }
                if (distance > id(calibration_max_distance)) {
                  id(calibration_max_distance) = distance;
                  ESP_LOGD("Calibration", "–ù–æ–≤–æ–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ: %.1f —Å–º", distance);
                }
              }
            }


#—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –º–æ—Ç–æ—Ä–∞
  - platform: dallas_temp
    address: 0xdf3ce0f64959df28
    name: "Motor"
    id: temp
    force_update: true
    update_interval: 30s
    on_value:
      then:
        - lambda: |-
            int tempmotor = (int)id(temp).state;
            //if (id(speed).state) {
            //id(display_nextion).send_command_printf("speed.ntemp.val=%d", tempmotor);
            //id(display_nextion).send_command_printf("motor.ntemp.val=%d", tempmotor);
            id(display_nextion).set_component_value("speed.ntemp", tempmotor);
            id(display_nextion).set_component_value("motor.ntemp", tempmotor);
            //}

  - platform: template
    name: "Calories Burned"
    id: total_calories
    unit_of_measurement: "kcal"
    accuracy_decimals: 0
    update_interval: 1s
    lambda: |-
      // –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
      float weight = id(weight_kg).state;
      int age = id(age_number).state;
      bool is_male = (strcmp(id(gender_select)->state.c_str(), "Male") == 0);
      float max_hr = (is_male) ? (214 - 0.8 * age) : (209 - 0.7 * age);

      // –°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
      float time_min = id(total_time_min);
      float avg_speed = (id(speed_count) > 0) ? (id(total_speed_sum) / id(speed_count)) : 0;
      float avg_incline = (id(incline_count) > 0) ? (id(total_incline_sum) / id(incline_count)) : 0;
      float avg_heart_rate = (id(heart_rate_count) > 0) ? (id(total_heart_rate_sum) / id(heart_rate_count)) : 0;

      // –ü–µ—Ä–µ—Å—á–µ—Ç –Ω–∞–∫–ª–æ–Ω–∞ –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω—ã–π –Ω–∞–∫–ª–æ–Ω
      float real_incline = avg_incline / 3.0f;  // 15% –Ω–∞ –±–µ–≥–æ–≤–æ–π –¥–æ—Ä–æ–∂–∫–µ = 5% —Ä–µ–∞–ª—å–Ω–æ–≥–æ –Ω–∞–∫–ª–æ–Ω–∞

      // –ü–µ—Ä–µ—Å—á–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤ –º/–º–∏–Ω –∏ —É–∫–ª–æ–Ω–∞ –≤ –¥–æ–ª–∏
      float speed_m_per_min = avg_speed * 1000.0f / 60.0f;  // –∫–º/—á ‚Üí –º/–º–∏–Ω
      float grade = real_incline / 100.0f;                 // –†–µ–∞–ª—å–Ω—ã–π –Ω–∞–∫–ª–æ–Ω % ‚Üí –¥–æ–ª–∏

      // –£—Ä–∞–≤–Ω–µ–Ω–∏–µ ACSM –¥–ª—è VO‚ÇÇ (–º–ª/–∫–≥/–º–∏–Ω)
      float vo2 = 0.1f * speed_m_per_min
                 + 1.8f * speed_m_per_min * grade
                 + 3.5f;

      // –ü–µ—Ä–µ–≤–æ–¥ VO‚ÇÇ –≤ MET
      float met = vo2 / 3.5f;

      // –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –ø–æ –ø—É–ª—å—Å—É (–Ω–µ–±–æ–ª—å—à–∞—è, –¥–æ 10%)
      float hr_ratio = avg_heart_rate / max_hr;
      if (hr_ratio > 0.7f) {
        float hr_factor = 1.0f + (hr_ratio - 0.7f) * 0.2f; // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–æ 10% –ø—Ä–∏ 90% –ø—É–ª—å—Å–∞
        if (hr_factor > 1.1f) hr_factor = 1.1f; // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 10%
        met *= hr_factor;
      }

      // –†–∞—Å—á–µ—Ç –∫–∞–ª–æ—Ä–∏–π
      float calories_per_hour = met * weight;
      float calories = (calories_per_hour * time_min) / 60.0f;

      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      if (calories < 0) calories = 0;

      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
      ESP_LOGD("Calories", "VO‚ÇÇ: %.2f ml/kg/min, MET: %.2f, Weight: %.1f kg, Time: %.2f min, Avg Speed: %.2f km/h, Avg Incline (Treadmill): %.2f %, Real Incline: %.2f %, Avg HR: %.0f bpm, Calories: %.0f kcal",
               vo2, met, weight, time_min, avg_speed, avg_incline, real_incline, avg_heart_rate, calories);

      return calories;

  # –°–µ–Ω—Å–æ—Ä—ã –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –ø—É–ª—å—Å–∞
  - platform: template
    name: "Average Heart Rate"
    id: avg_heart_rate_sensor
    unit_of_measurement: "bpm"
    accuracy_decimals: 0
    lambda: |-
      return (id(heart_rate_count) > 0) ? (id(total_heart_rate_sum) / id(heart_rate_count)) : 0;

  - platform: template
    name: "Max Heart Rate"
    id: max_heart_rate_sensor
    unit_of_measurement: "bpm"
    accuracy_decimals: 0
    lambda: |-
      return id(max_heart_rate_total);

  - platform: nextion
    nextion_id: display_nextion
    id: age_sensor
    name: "Age from Nextion"
    internal: true
    component_name: n_age  
    on_value:
      then:
        - lambda: |-
            int new_age = x; // –ó–Ω–∞—á–µ–Ω–∏–µ –æ—Ç number_sensor
            if (new_age >= 16 && new_age <= 100) {
              id(age_number).publish_state(new_age); // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
              ESP_LOGD("Settings", "Age updated to: %d", new_age);
              //id(update_heart_rate_zones).execute(); // –û–±–Ω–æ–≤–ª—è–µ–º –∑–æ–Ω—ã –ø—É–ª—å—Å–∞
            } else {
              ESP_LOGW("Settings", "Invalid age value: %d", new_age);
            }          


  - platform: nextion
    nextion_id: display_nextion
    id: weight_sensor
    name: "Weight from Nextion"
    internal: true
    component_name: n_weight  
    on_value:
      then:
        - lambda: |-
            int new_weight = x; // –ó–Ω–∞—á–µ–Ω–∏–µ –æ—Ç Nextion
            if (new_weight >= 40 && new_weight <= 100) {
              id(weight_kg).publish_state(new_weight);
              ESP_LOGD("Settings", "Weight updated to: %d kg", new_weight);
            } else {
              ESP_LOGW("Settings", "Invalid weight value: %d kg", new_weight);
            }


  - platform: nextion
    nextion_id: display_nextion
    id: time_sensor
    name: "time from Nextion"
    internal: true
    component_name: n_min  
    on_value:
      then:
        - lambda: |-
            int new_time = x; // –ó–Ω–∞—á–µ–Ω–∏–µ –æ—Ç number_sensor
            if (new_time >= 1 && new_time <= 999) {
              id(set_run_time).publish_state(new_time); // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
              ESP_LOGD("Settings", "Age updated to: %d", new_time);
              //id(update_heart_rate_zones).execute(); // –û–±–Ω–æ–≤–ª—è–µ–º –∑–æ–Ω—ã –ø—É–ª—å—Å–∞
            } else {
              ESP_LOGW("Settings", "Invalid age value: %d", new_time);
            }    

  - platform: nextion
    nextion_id: display_nextion
    id: warm_sensor
    name: "time warm from Nextion"
    internal: true
    component_name: n_warm
    on_value:
      then:
        - lambda: |-
            int new_time_warm = x; // –ó–Ω–∞—á–µ–Ω–∏–µ –æ—Ç number_sensor
            if (new_time_warm >= 0 && new_time_warm <= 10) {
              id(set_warm_up_time).publish_state(new_time_warm); // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
              ESP_LOGD("Settings", "Age updated to: %d", new_time_warm);
              //id(update_heart_rate_zones).execute(); // –û–±–Ω–æ–≤–ª—è–µ–º –∑–æ–Ω—ã –ø—É–ª—å—Å–∞
            } else {
              ESP_LOGW("Settings", "Invalid age value: %d", new_time_warm);
            }    

  - platform: nextion
    nextion_id: display_nextion
    id: cool_sensor
    name: "time cool from Nextion"
    internal: true
    component_name: n_cool 
    on_value:
      then:
        - lambda: |-
            int new_time_cool = x; // –ó–Ω–∞—á–µ–Ω–∏–µ –æ—Ç number_sensor
            if (new_time_cool >= 0 && new_time_cool <= 10) {
              id(set_cool_down_time).publish_state(new_time_cool); // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
              ESP_LOGD("Settings", "Age updated to: %d", new_time_cool);
              //id(update_heart_rate_zones).execute(); // –û–±–Ω–æ–≤–ª—è–µ–º –∑–æ–Ω—ã –ø—É–ª—å—Å–∞
            } else {
              ESP_LOGW("Settings", "Invalid age value: %d", new_time_cool);
            }    

  - platform: template
    name: "Treadmill Speed Feedback"
    id: treadmill_speed_feedback_sensor
    unit_of_measurement: "km/h"
    accuracy_decimals: 1
    update_interval: 1.2s
    entity_category: diagnostic
    icon: "mdi:run"
    lambda: |-
      return id(treadmill_speed_feedback) / 10.0;

  - platform: template
    name: "Treadmill Incline Feedback"
    id: treadmill_incline_feedback_sensor
    unit_of_measurement: "%"
    accuracy_decimals: 0
    entity_category: diagnostic
    update_interval: 1.1s
    icon: "mdi:angle-acute"
    lambda: |-
      return id(treadmill_incline_feedback) / 10.0;

  - platform: template
    name: "Treadmill Speed"
    unit_of_measurement: "km/h"
    accuracy_decimals: 1
    update_interval: 1s
    id: treadmill_speed_sensor_uart
    icon: "mdi:run"
    lambda: |-
      return id(motor_running) ? id(target_speed) / 10.0 : 0.0;
    on_value:
      - lambda: |-
          if (id(speed).state) {
            char speed_str[10]; // –ë—É—Ñ–µ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏
            sprintf(speed_str, "%.1f", id(treadmill_speed_sensor_uart).state); // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞ —Å –æ–¥–Ω–æ–π —Ü–∏—Ñ—Ä–æ–π –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
            id(display_nextion).set_component_text("t1", speed_str); // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
          }
      - if:
          condition:
            lambda: 'return id(ble_client_connected);'
          then:
            - script.execute: send_treadmill_data

  - platform: template
    name: "Treadmill Incline"
    unit_of_measurement: "%"
    accuracy_decimals: 0
    update_interval: 1s
    id: treadmill_incline_sensor_uart
    icon: "mdi:angle-acute"
    lambda: |-
      return id(target_incline) / 10.0;
    on_value:
      - lambda: |-
          if (id(speed).state) {
            char incline_str[10]; // –ë—É—Ñ–µ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏
            sprintf(incline_str, "%.1f", id(treadmill_incline_sensor_uart).state); // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞ —Å –æ–¥–Ω–æ–π —Ü–∏—Ñ—Ä–æ–π –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
            id(display_nextion).set_component_text("t4", incline_str); // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
          }

  # - platform: template
  #   name: "ESP32 Free Memory"
  #   lambda: |-
  #     return (float)ESP.getFreeHeap() / 1024.0;
  #   unit_of_measurement: "kB"
  #   accuracy_decimals: 1
  #   update_interval: 60s
  #   entity_category: diagnostic
  #   icon: "mdi:memory"

  - platform: wifi_signal
    name: "ESP32 WiFi Signal"
    update_interval: 60s

  - platform: template
    name: "Treadmill Time"
    id: treadmill_time_min
    lambda: |-
      static float total_time_min = 0.0;
      if (!id(motor_running)) {
        total_time_min = 0.0;
        return total_time_min;
      }
      total_time_min += 1.0 / 60.0;
      return total_time_min;
    on_value:
      - lambda: |-
          int minutes = static_cast<int>(id(treadmill_time_min).state); // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–ª—ã–µ –º–∏–Ω—É—Ç—ã
          int seconds = static_cast<int>((id(treadmill_time_min).state - minutes) * 60); // –ü–æ–ª—É—á–∞–µ–º —Å–µ–∫—É–Ω–¥—ã
          if (id(speed).state) {
            char time_str[6]; // –ë—É—Ñ–µ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "M:SS"
            sprintf(time_str, "%d:%02d", minutes, seconds); // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
            id(display_nextion).set_component_text("t3", time_str); // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
          }
    unit_of_measurement: "min"
    accuracy_decimals: 2
    update_interval: 1s
    icon: "mdi:timer-play-outline"

  - platform: template
    name: "Treadmill Distance"
    id: treadmill_distance_km
    lambda: |-
      static float current_distance_km = 0.0;
      if (!id(motor_running)) {
        current_distance_km = 0.0;
        return current_distance_km;
      }
      float speed_kph = id(target_speed) / 10.0;
      float distance_increment_km = speed_kph / 3600.0;
      current_distance_km += distance_increment_km;
      return current_distance_km;
    on_value:
      - lambda: |-
          if (id(speed).state) {
            char distance_str[10]; // –ë—É—Ñ–µ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏
            sprintf(distance_str, "%.2f", id(treadmill_distance_km).state); // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞ —Å –æ–¥–Ω–æ–π —Ü–∏—Ñ—Ä–æ–π –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
            id(display_nextion).set_component_text("t2", distance_str); // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
          }
    unit_of_measurement: "km"
    accuracy_decimals: 2
    update_interval: 1s
    icon: "mdi:map-marker-distance"


  - platform: pulse_counter
    pin:
      number: GPIO16
      mode:
        input: true
        pullup: true
    name: "Raw Treadmill Data"
    id: treadmill_raw_data
    unit_of_measurement: "pulses/s"
    accuracy_decimals: 0
    update_interval: 1s
    count_mode:
      rising_edge: INCREMENT
      falling_edge: DISABLE
    internal_filter: 13us
    entity_category: diagnostic

  - platform: template
    name: "Treadmill Speed Motor"
    id: treadmill_speed_kph
    unit_of_measurement: "km/h"
    accuracy_decimals: 1
    lambda: |-
      float rc = id(roller_circumference);
      float pulses_per_rotation = 144.0;
      float gr_r = id(gear_ratio);
      float raw_pulses = id(treadmill_raw_data).state;
      if (raw_pulses == 0.0) {
        if (id(treadmill_running)) {
          id(run_stopped_timer)++;
          if (id(run_stopped_timer) >= 2) {
            id(treadmill_running) = false;
          }
        }
        return 0.0;
      }
      float speed_kph = (raw_pulses / pulses_per_rotation / gr_r) * rc * 3.6;
      id(treadmill_running) = true;
      id(run_stopped_timer) = 0;
      return speed_kph;
    update_interval: 1s
    icon: "mdi:run"
    filters:
      - exponential_moving_average:
          alpha: 0.25
          send_every: 1

  - platform: ble_client
    type: characteristic
    ble_client_id: fit_smart
    name: "Heart Rate"
    id: heart_rate_sensor
    service_uuid: "180d"
    characteristic_uuid: "2a37"
    notify: true
    update_interval: never
    lambda: |-
      static uint16_t last_heart_rate = 0;
      static uint16_t last_picture_id = 7; // –°–µ—Ä—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ BLE
      if (!id(fit_smart).connected()) {
        if (id(speed).state) {
          id(display_nextion).send_command_printf("p0.pic=%d", 7); // –°–µ—Ä—ã–π
          id(display_nextion).send_command_printf("t0.txt=\"-\"");
        }
        return 0.0;
      }
      if (x.size() < 2) return 0.0;

      // –ß–∏—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø—É–ª—å—Å–∞
      uint8_t flags = x[0];
      uint16_t heart_rate = x[1];
      if (flags & 0x01) {
        heart_rate = (x[2] << 8) | x[1]; // 16-–±–∏—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      }

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∑–æ–Ω –ø—É–ª—å—Å–∞
      float max_hr = id(max_heart_rate);
      float min_zone_1 = max_hr * 0.50; // 50%
      float max_zone_1 = max_hr * 0.60; // 60%
      float min_zone_2 = max_hr * 0.60; // 60%
      float max_zone_2 = max_hr * 0.70; // 70%
      float min_zone_3 = max_hr * 0.70; // 70%
      float max_zone_3 = max_hr * 0.80; // 80%
      float min_zone_4 = max_hr * 0.80; // 80%
      float max_zone_4 = max_hr * 0.90; // 90%
      float min_zone_5 = max_hr * 0.90; // 90%
      float max_zone_5 = max_hr;        // 100%

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∑–æ–Ω—É
      int heart_rate_zone = 0;
      if (heart_rate < min_zone_1) {
        heart_rate_zone = 0;
      } else if (heart_rate < max_zone_1) {
        heart_rate_zone = 1;
      } else if (heart_rate < max_zone_2) {
        heart_rate_zone = 2;
      } else if (heart_rate < max_zone_3) {
        heart_rate_zone = 3;
      } else if (heart_rate < max_zone_4) {
        heart_rate_zone = 4;
      } else {
        heart_rate_zone = 5;
      }
      id(current_zone) = heart_rate_zone; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –∑–æ–Ω—É
      //ESP_LOGI("DEBUG", "Heart Rate: %d, Current Zone: %d, Max HR: %.1f", heart_rate, heart_rate_zone, max_hr);

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID –∫–∞—Ä—Ç–∏–Ω–∫–∏
      uint16_t picture_id = 7; // –°–µ—Ä—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      if (heart_rate < min_zone_1) {
        picture_id = 7; // –°–µ—Ä—ã–π (–Ω–∏–∂–µ –∑–æ–Ω—ã 1)
      } else if (heart_rate < max_zone_1) {
        picture_id = 2; // –ì–æ–ª—É–±–æ–π (–∑–æ–Ω–∞ 1)
      } else if (heart_rate < max_zone_2) {
        picture_id = 3; // –ó–µ–ª—ë–Ω—ã–π (–∑–æ–Ω–∞ 2)
      } else if (heart_rate < max_zone_3) {
        picture_id = 4; // –ñ—ë–ª—Ç—ã–π (–∑–æ–Ω–∞ 3)
      } else if (heart_rate < max_zone_4) {
        picture_id = 5; // –û—Ä–∞–Ω–∂–µ–≤—ã–π (–∑–æ–Ω–∞ 4)
      } else {
        picture_id = 6; // –ö—Ä–∞—Å–Ω—ã–π (–∑–æ–Ω–∞ 5)
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏—Å–ø–ª–µ–π
      if (id(speed).state) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—É–ª—å—Å–∞
        if (heart_rate != last_heart_rate) {
          char heart_str[10];
          sprintf(heart_str, "%d", heart_rate);
          id(display_nextion).send_command_printf("t0.txt=\"%s\"", heart_str);
          last_heart_rate = heart_rate;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–æ–Ω—ã
        if (picture_id != last_picture_id) {
          uint16_t t0_bco = 14792; // –°–µ—Ä—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          if (picture_id == 2) t0_bco = 15487; // –ì–æ–ª—É–±–æ–π
          else if (picture_id == 3) t0_bco = 11744; // –ó–µ–ª—ë–Ω—ã–π
          else if (picture_id == 4) t0_bco = 64992; // –ñ—ë–ª—Ç—ã–π
          else if (picture_id == 5) t0_bco = 64294; // –û—Ä–∞–Ω–∂–µ–≤—ã–π
          else if (picture_id == 6) t0_bco = 63688; // –ö—Ä–∞—Å–Ω—ã–π

          id(display_nextion).send_command_printf("p0.pic=%d", picture_id);
          id(display_nextion).send_command_printf("t0.bco=%d", t0_bco);
          last_picture_id = picture_id;
        }
      }
      return (float)heart_rate;
    unit_of_measurement: "bpm"
    icon: "mdi:heart-pulse"


  - platform: ble_client
    type: characteristic
    ble_client_id: fit_smart
    name: "Battery Level"
    id: battery_level_sensor
    service_uuid: "180F"
    characteristic_uuid: "2A19"
    notify: true
    update_interval: never  # –û—Ç–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –æ–ø—Ä–æ—Å
    lambda: |-
      if (!id(fit_smart).connected()) {
        return 0.0;  // –ò–∑–º–µ–Ω–µ–Ω–æ —Å NAN –Ω–∞ 0.0
      }
      if (x.size() < 1) return 0.0;  // –ò–∑–º–µ–Ω–µ–Ω–æ —Å NAN –Ω–∞ 0.0
      uint8_t battery_level = x[0];
      return (float)battery_level;
    unit_of_measurement: "%"
    icon: "mdi:battery"

# BLE
esp32_ble_tracker:
  scan_parameters:
    #interval: 1100ms
    #window: 300ms
    active: true

ble_client:
  - mac_address: "C9:5A:91:C1:92:58"
    id: fit_smart
    on_connect:
      - text_sensor.template.publish:
          id: connection_status
          state: "–ü–æ–¥–∫–ª—é—á–µ–Ω"
      - delay: 20ms 
      - lambda: |-
          ESP_LOGD("ble_client", "Connected to fit_smart");
          // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –±–∞—Ç–∞—Ä–µ–∏ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
          id(battery_level_sensor).update();
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ hr –≤ 1 (–ø–æ–¥–∫–ª—é—á–µ–Ω–æ)
          id(display_nextion).send_command_printf("hr=1");
      - if:
          condition:
            lambda: 'return id(mainPage).state;'
          then:
            - lambda: |-
                id(display_nextion).send_command_printf("p_error.pic=15");
                id(display_nextion).send_command_printf("vis p_error,1");
            - delay: 3000ms  # –ó–∞–¥–µ—Ä–∂–∫–∞ 3 —Å–µ–∫—É–Ω–¥—ã
            - lambda: |-
                id(display_nextion).send_command_printf("vis p_error,0");
                id(display_nextion).send_command_printf("mainPage.bhr_zone.aph=127"); 
                id(display_nextion).send_command_printf("mainPage.bhiit.aph=127"); 
                id(display_nextion).send_command_printf("mainPage.bfit_test.aph=127"); 
    on_disconnect:
      - sensor.template.publish:
          id: heart_rate_sensor
          state: 0 # !lambda 'return NAN;'
      - lambda: |-
          if (id(speed).state) {
            id(display_nextion).set_component_text("b0", "-"); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –Ω–∞ –¥–∏—Å–ø–ª–µ–π
            id(display_nextion).send_command_printf("b0.pic=7");
          }

          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ hr –≤ 0 –æ—Ç–∫–ª—é—á–µ–Ω–æ
          id(display_nextion).send_command_printf("hr=0");
          if (id(mainPage).state) {
            id(display_nextion).send_command_printf("mainPage.bhr_zone.aph=80"); 
            id(display_nextion).send_command_printf("mainPage.bhiit.aph=80"); 
            id(display_nextion).send_command_printf("mainPage.bfit_test.aph=80"); 
          }
      - sensor.template.publish:
          id: battery_level_sensor
          state: 0 # !lambda 'return NAN;'
      - text_sensor.template.publish:
          id: connection_status
          state: "–û—Ç–∫–ª—é—á–µ–Ω–æ"


    # - uuid: "1814"  # Running Speed and Cadence Service
    #   advertise: true
    #   characteristics:
    #     - uuid: "2A53"  # RSC Measurement
    #       id: rsc_measurement_char
    #       notify: true
    #       read: true
    #       value: !lambda |-
    #         std::vector<uint8_t> data;
    #         uint8_t flags = 0x03; // –î–ª–∏–Ω–∞ —à–∞–≥–∞ –∏ –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è
    #         data.push_back(flags);
    #         float speed_kph = id(treadmill_speed_sensor_uart).state;
    #         if (isnan(speed_kph)) speed_kph = 0;
    #         uint16_t speed = (uint16_t)(speed_kph * 256 / 3.6); // –°–∫–æ—Ä–æ—Å—Ç—å –≤ 1/256 –º/—Å (–∏–∑ –∫–º/—á)
    #         data.push_back(speed & 0xFF);         // –ù–∏–∑—à–∏–π –±–∞–π—Ç
    #         data.push_back((speed >> 8) & 0xFF);  // –í—ã—Å—à–∏–π –±–∞–π—Ç
    #         uint8_t cadence = 120; // –ü—Ä–∏–º–µ—Ä: 120 —à–∞–≥–æ–≤ –≤ –º–∏–Ω—É—Ç—É (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
    #         data.push_back(cadence);
    #         uint16_t stride_length = 100; // –ü—Ä–∏–º–µ—Ä: –¥–ª–∏–Ω–∞ —à–∞–≥–∞ 100 —Å–º
    #         data.push_back(stride_length & 0xFF);
    #         data.push_back((stride_length >> 8) & 0xFF);
    #         float distance_km = id(treadmill_distance_km).state;
    #         uint32_t distance = isnan(distance_km) ? 0 : (uint32_t)(distance_km * 10000); // –î–µ—Ü–∏–º–µ—Ç—Ä—ã
    #         data.push_back(distance & 0xFF);
    #         data.push_back((distance >> 8) & 0xFF);
    #         data.push_back((distance >> 16) & 0xFF);
    #         data.push_back((distance >> 24) & 0xFF);
    #         return data;
    #     - uuid: "2A54"  # RSC Feature
    #       id: rsc_feature_char
    #       read: true
    #       value: !lambda |-
    #         std::vector<uint8_t> data;
    #         uint16_t features = 0x000F; // –ü–æ–¥–¥–µ—Ä–∂–∫–∞: –¥–ª–∏–Ω–∞ —à–∞–≥–∞, –¥–∏—Å—Ç–∞–Ω—Ü–∏—è, —Å—Ç–∞—Ç—É—Å —Ö–æ–¥—å–±–∞/–±–µ–≥, –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞
    #         data.push_back(features & 0xFF);         // 0x0F
    #         data.push_back((features >> 8) & 0xFF);  // 0x00
    #         return data;
    #     - uuid: "2A5D"  # Sensor Location
    #       id: sensor_location_char
    #       read: true
    #       value: !lambda |-
    #         std::vector<uint8_t> data;
    #         data.push_back(14); // 14 = "Treadmill" –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É BLE
    #         return data;
    #     - uuid: "2A55"  # SC Control Point
    #       id: sc_control_point_char
    #       write: true
    #       indicate: true
    #       on_write: !lambda |-
    #         if (x.empty()) return;
    #         uint8_t op_code = x[0];
    #         ESP_LOGI("RSC", "–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ RSC: 0x%02X, –î–∞–Ω–Ω—ã–µ: %d –±–∞–π—Ç", op_code, x.size());
    #         std::vector<uint8_t> response;
    #         if (op_code == 0x03) {  // Start Sensor Calibration
    #           ESP_LOGI("RSC", "–ó–∞–ø—É—Å–∫ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏");
    #           // –ü—Ä–∏–º–µ—Ä: —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–µ–∫—É—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
    #           float speed_kph = id(treadmill_speed_sensor_uart).state;
    #           ESP_LOGI("RSC", "–¢–µ–∫—É—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏: %.2f –∫–º/—á", speed_kph);
    #           response = {0x10, 0x03, 0x01};  // Success
    #         } else if (op_code == 0x01) {  // Request Supported Sensor Locations
    #           response = {0x10, 0x01, 0x01, 14};  // Success, location = Treadmill
    #         } else {
    #           response = {0x10, op_code, 0x02};  // Op Code Not Supported
    #         }
    #         if (!response.empty()) {
    #           id(sc_control_point_char).set_value(response);
    #           id(sc_control_point_char).indicate();
    #           ESP_LOGI("RSC", "–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: 0x%02X", response[2]);
    #         }

esp32_ble_server:
  model: Treadmill Controller
  manufacturer: "ESP32-S3"
  firmware_version: "1.0.0"
  on_connect:
    - globals.set:
        id: ble_client_connected
        value: 'true'
    - text_sensor.template.publish:
        id: ble_server_status
        state: "–ü–æ–¥–∫–ª—é—á–µ–Ω"
    - lambda: |-
        // –û—Ç–ø—Ä–∞–≤–∫–∞ Training Status: Idle (0x01) –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        if (!id(motor_running)) {
          std::vector<uint8_t> training_status = {0x00, 0x01};
          id(training_status_char).set_value(training_status);
          id(training_status_char).notify();
          id(last_training_status) = training_status;
          id(training_status_sensor).publish_state(id(training_status_to_string)(0x01));
          ESP_LOGI("FTMS", "BLE –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω: Training Status = Idle (0x01)");
        }
  on_disconnect:
    - globals.set:
        id: ble_client_connected
        value: 'false'
    - text_sensor.template.publish:
        id: ble_server_status
        state: "–û—Ç–∫–ª—é—á–µ–Ω"
  services:
    - uuid: "1826"  # FTMS
      advertise: true
      characteristics:
        - uuid: "2ACD"  # Treadmill Data
          id: treadmill_data_char
          notify: true
          read: true
          value: !lambda 'return id(treadmill_data_char).get_value();'
        - uuid: "2ACC"  # Fitness Machine Feature
          id: ftms_feature_char
          read: true
          value: !lambda |-
            // 32–±–∏—Ç–∞ (0000 0000 0000 0000 0001 0100 0000 1101)
            uint32_t features = 0x140D; // Speed, Distance, Incline, Heart Rate, Time supported
            // 32–±–∏—Ç–∞ (0000 0000 0000 0000 0000 0000 0000 0011)
            uint32_t target_features = 0x0003;  // Speed Target + Incline Target supported
            std::vector<uint8_t> data;
            data.push_back(features & 0xFF);         // 0x0D
            data.push_back((features >> 8) & 0xFF);  // 0x14
            data.push_back((features >> 16) & 0xFF); // 0x00
            data.push_back((features >> 24) & 0xFF); // 0x00
            data.push_back(target_features & 0xFF);  // 0x03
            data.push_back((target_features >> 8) & 0xFF);  // 0x00
            data.push_back((target_features >> 16) & 0xFF); // 0x00
            data.push_back((target_features >> 24) & 0xFF); // 0x00
            return data;
        - uuid: "2ADA"  # Fitness Machine Status
          id: ftms_status_char
          notify: true
          read: true
          value: !lambda |-
            return id(last_ftms_status);
        - uuid: "2AD3"  # Training Status
          id: training_status_char
          notify: true
          read: true
          value: !lambda |-
            return id(last_training_status);
        - uuid: "2AD4"  # Supported Speed Range
          id: supported_speed_range
          read: true
          value: !lambda |-
            // min: 0.0 –∫–º/—á (0), max: 12.0 –∫–º/—á (1200), increment: 0.1 –∫–º/—á (10)
            return std::vector<uint8_t>{0x00, 0x00, 0xB0, 0x04, 0x0A, 0x00};
        - uuid: "2AD5"  # Supported Inclination Range
          id: supported_incline_range
          read: true
          value: !lambda |-
            // min: 0.0% (0), max: 15.0% (150), increment: 1.0% (10)
            return std::vector<uint8_t>{0x00, 0x00, 0x96, 0x00, 0x0A, 0x00};
        - uuid: "2AD9"  # Fitness Machine Control Point
          id: ftms_control_point_char
          write: true
          on_write:
            then:
              - lambda: |-
                  if (x.empty()) return;
                  uint8_t op_code = x[0];
                  ESP_LOGI("FTMS", "–ö–æ–º–∞–Ω–¥–∞: 0x%02X, –î–∞–Ω–Ω—ã–µ: %d –±–∞–π—Ç, motor_running=%d, manual_stop=%d", 
                    op_code, x.size(), id(motor_running), id(manual_stop));

                  std::string hex_data;
                  for (size_t i = 0; i < x.size(); ++i) {
                    char buf[4];
                    snprintf(buf, sizeof(buf), "%02X ", x[i]);
                    hex_data += buf;
                  }
                  ESP_LOGI("FTMS", "RAW: %s", hex_data.c_str());

                  std::vector<uint8_t> response;

                  if (op_code == 0x00) {  // Request Control
                    response = {0x80, 0x00, 0x01};  // Success
                    ESP_LOGI("FTMS", "Request Control –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω");
                  } else if (op_code == 0x07) {  // Start
                      if (id(manual_stop)) {
                          response = {0x80, 0x07, 0x02};  // Invalid Parameter
                          ESP_LOGW("FTMS", "–ö–æ–º–∞–Ω–¥–∞ Start –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∞: —Ç—Ä–µ–Ω–∞–∂—ë—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é");
                      } else if (id(motor_running)) {
                          response = {0x80, 0x07, 0x01};  // Success
                          ESP_LOGI("FTMS", "–ö–æ–º–∞–Ω–¥–∞ Start –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∞: —Ç—Ä–µ–Ω–∞–∂—ë—Ä —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç");
                      } else {
                          if (id(program_select).state != "None") {
                              id(start_program).execute();
                              ESP_LOGI("FTMS", "–ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã");
                          } else {
                              id(start_manual).execute();
                              ESP_LOGI("FTMS", "–ó–∞–ø—É—Å–∫ —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞");
                          }
                          response = {0x80, 0x07, 0x01};  // Success
                      }

                  } else if (op_code == 0x08) {  // Stop
                    id(stop_program).execute();
                    response = {0x80, 0x08, 0x01};  // Success
                    ESP_LOGI("FTMS", "–°—Ç–æ–ø –≤—ã–ø–æ–ª–Ω–µ–Ω");
                  } else if (op_code == 0x02 && x.size() >= 3) {  // Set Target Speed
                    float requested_kmh = (x[1] | (x[2] << 8)) / 100.0f;
                    if (requested_kmh >= 0.6f && requested_kmh <= 12.0f) {
                      id(set_speed).publish_state(requested_kmh);
                      id(target_speed) = (int)(requested_kmh * 10);
                      id(target_speed_goal) = id(target_speed);
                      response = {0x80, 0x02, 0x01};  // Success
                      std::vector<uint8_t> status = {0x05, x[1], x[2]};  // Target Speed Changed
                      id(ftms_status_char).set_value(status);
                      id(ftms_status_char).notify();
                      id(last_ftms_status) = status;
                      id(ftms_status_sensor).publish_state(id(ftms_status_to_string)(0x05));
                      ESP_LOGI("FTMS", "–°–∫–æ—Ä–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: %.2f –∫–º/—á, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Target Speed Changed (0x05)");
                    } else {
                      response = {0x80, 0x02, 0x02};  // Invalid Parameter
                      ESP_LOGW("FTMS", "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: %.2f –∫–º/—á", requested_kmh);
                    }
                  } else if (op_code == 0x03 && x.size() >= 3) {  // Set Target Incline
                    static uint32_t last_incline_time = 0;
                    if (millis() - last_incline_time < 500) {
                      ESP_LOGD("FTMS", "–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —á–∞—Å—Ç—É—é –∫–æ–º–∞–Ω–¥—É –Ω–∞–∫–ª–æ–Ω–∞");
                      return;
                    }
                    last_incline_time = millis();
                    float requested_incline = (x[1] | (x[2] << 8)) / 10.0f;
                    if (requested_incline >= 0.0f && requested_incline <= 15.0f) {
                      id(set_incline).publish_state(requested_incline);
                      id(target_incline_goal) = (int)(requested_incline * 10);
                      id(target_incline) = id(target_incline_goal);
                      response = {0x80, 0x03, 0x01};  // Success
                      std::vector<uint8_t> status = {0x06, x[1], x[2]};  // Target Incline Changed
                      id(ftms_status_char).set_value(status);
                      id(ftms_status_char).notify();
                      id(last_ftms_status) = status;
                      id(ftms_status_sensor).publish_state(id(ftms_status_to_string)(0x06));
                      ESP_LOGI("FTMS", "–ù–∞–∫–ª–æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: %.1f%%, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Target Incline Changed (0x06)");
                    } else {
                      response = {0x80, 0x03, 0x02};  // Invalid Parameter
                      ESP_LOGW("FTMS", "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π –Ω–∞–∫–ª–æ–Ω: %.1f%%", requested_incline);
                    }
                  } else {
                    response = {0x80, op_code, 0x06};  // Op Code Not Supported
                    ESP_LOGW("FTMS", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: 0x%02X", op_code);
                  }

                  if (!response.empty()) {
                    id(ftms_control_point_char).set_value(response);
                    id(ftms_control_point_char).notify();
                    ESP_LOGI("FTMS", "–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: %s", hex_data.c_str());
                  }

    # - uuid: "0000180D-0000-1000-8000-00805F9B34FB"
    #   advertise: true
    #   characteristics:
        # - uuid: "2A37"
        #   id: heart_rate_data
        #   notify: true
        #   read: true
        #   value: !lambda |-
        #     if (isnan(id(heart_rate_sensor).state)) {
        #       return std::vector<uint8_t>{};
        #     }
        #     uint8_t heart_rate = (uint8_t)(id(heart_rate_sensor).state);
        #     std::vector<uint8_t> hr_data(2, 0);
        #     hr_data[0] = 0x06;
        #     hr_data[1] = heart_rate;
        #     return hr_data;

# –ë–∏–Ω–∞—Ä–Ω—ã–µ —Å–µ–Ω—Å–æ—Ä—ã
binary_sensor:

  # - platform: nextion
  #   page_id: 15
  #   component_id: 5
  #   id: calibration_button
  #   name: "Start Calibration"
  #   on_press:
  #     then:
  #       - script.execute: start_calibration
  #       - lambda: |- 
  #           id(calibration_button).publish_state(false);
  #           ESP_LOGI("Nextion", "–ö–Ω–æ–ø–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –Ω–∞–∂–∞—Ç–∞");

            
  - platform: template
    name: "Treadmill Powered On"
    id: treadmill_powered_on
    lambda: |-
      uint32_t now = millis();                  // –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
      if (id(uart_bus).available()) {           // –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –±–∞–π—Ç
        uint8_t c;                              // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –±–∞–π—Ç–∞
        if (id(uart_bus).read_byte(&c)) {       // –ß–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –±–∞–π—Ç
          id(last_packet_time) = now;           // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
        }
      }
      return (now - id(last_packet_time) < 5000);  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–æ –ª–∏ –º–µ–Ω–µ–µ 5 —Å–µ–∫—É–Ω–¥
    filters:
      - delayed_off: 5s

  - platform: template
    name: "Treadmill Usage"
    id: treadmill_usage
    lambda: |-
      return id(treadmill_speed_sensor_uart).state > 0.0;


  - platform: gpio
    pin:
      number: 13
      mode: INPUT_PULLUP
      inverted: true
    name: "Speed Up Button"
    entity_category: diagnostic
    on_press:
      - button.press: speed_up_button_large
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms

  - platform: gpio
    pin:
      number: 14
      mode: INPUT_PULLUP
      inverted: true
    name: "Speed Down Button"
    entity_category: diagnostic
    on_press:
      - button.press: speed_down_button_large
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms


  - platform: gpio
    pin:
      number: 9
      mode: INPUT_PULLUP
      inverted: true
    name: "Incline Up Button"
    entity_category: diagnostic
    on_press:
      - button.press: incline_up_button
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms

  - platform: gpio
    pin:
      number: 10
      mode: INPUT_PULLUP
      inverted: true
    name: "Incline Down Button"
    entity_category: diagnostic
    on_press:
      - button.press: incline_down_button
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms

#–¥–∏—Å–ø–ª–µ–π —Å–µ–Ω—Å–æ—Ä
  - platform: nextion
    page_id: 0
    component_id: 0
    id: mainPage
    on_press:
      then:
        #- component.update: display_nextion
        - lambda: |-
            ESP_LOGI("Nextion", "mainPage tab (page 0) opened");
            id(map_select).publish_state("None"); //–ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É —Å–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ –∫–∞—Ä—Ç—ã
            id(program_select).publish_state("None"); //–ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É —Å–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ –∫–∞—Ä—Ç—ã

  - platform: nextion
    page_id: 10
    component_id: 0
    id: map_page
    on_press:
      then:
       # - component.update: display_nextion
        - lambda: |-
            ESP_LOGI("Nextion", "map tab (page 10) opened");


  - platform: nextion
    page_id: 16
    component_id: 0
    id: info_page
    on_press:
      then:
       # - component.update: display_nextion
        - lambda: |-
            id(display_nextion).set_component_text_printf("tVersion", id(ESPHomeVersion).state.c_str());
            ESP_LOGI("Nextion", "info_page (page 16) opened");

  - platform: nextion
    page_id: 17
    component_id: 0
    id: motor_page
    on_press:
      then:
       # - component.update: display_nextion
        - lambda: |-
            ESP_LOGI("Nextion", "motor_page (page 17) opened");

  - platform: nextion
    page_id: 15
    component_id: 0
    id: caldistspeed
    on_press:
      then:
       # - component.update: display_nextion
        - lambda: |-
            ESP_LOGI("Nextion", "caldistspeed tab (page 15) opened");

  - platform: nextion
    page_id: 11
    component_id: 0
    id: page_map_select
    on_press:
      then:
       # - component.update: display_nextion
        - lambda: |-
            ESP_LOGI("Nextion", "map select (page 11) opened");

  - platform: nextion
    page_id: 8
    component_id: 0
    id: avgsummary
    on_press:
      then:
      #  - component.update: display_nextion
        - lambda: |-
            ESP_LOGI("Nextion", "avgsummary tab (page 8) opened");

  - platform: nextion
    page_id: 1
    component_id: 1
    id: speed
    on_press:
      then:
        - lambda: |-
            ESP_LOGI("Nextion", "Speed tab (page 1) opened");

  - platform: nextion
    page_id: 2
    component_id: 0
    id: pulsezone
    on_press:
      then:
      #  - component.update: display_nextion
        - lambda: |-
            ESP_LOGI("Nextion", "Pulse zone tab (page 2) opened");

  - platform: nextion
    page_id: 9
    component_id: 0
    id: delayPage
    on_press:
      # then:
      #   - script.execute: start_manual
        - lambda: |-
            id(speed).publish_state(false);
            ESP_LOGI("Nextion", "delayPage zone tab (page 9) opened");


  - platform: nextion
    page_id: 3
    component_id: 1
    id: age
    on_press:
      then:
        #- component.update: display_nextion
        - lambda: |-
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç
            id(display_nextion).send_command_printf("n_age.val=%d", (int)id(age_number).state);
            ESP_LOGD("Nextion", "Loaded age %d to n_age", (int)id(age_number).state);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–µ—Å –≤ –∫–≥
            id(display_nextion).send_command_printf("n_weight.val=%d", (int)id(weight_kg).state);
            ESP_LOGD("Nextion", "Loaded age %d to n_weight", (int)id(weight_kg).state);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª (bt0)
            const char* gender = id(gender_select)->state.c_str();
            int button_val = (strcmp(gender, "Male") == 0) ? 0 : 1;
            id(display_nextion).send_command_printf("age.bt0.val=%d", button_val);
            ESP_LOGI("Nextion", "Age tab (page 3) opened");


  - platform: nextion
    page_id: 5
    component_id: 0
    id: Time
    on_press:
      then:
        #- component.update: display_nextion
        - lambda: |-
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è
            id(display_nextion).send_command_printf("n_min.val=%d", (int)id(set_run_time).state);
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è —Ä–∞–∑–º–∏–Ω–∫–∏
            id(display_nextion).send_command_printf("n_warm.val=%d", (int)id(set_warm_up_time).state);
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –∑–∞–º–∏–Ω–∫–∞
            id(display_nextion).send_command_printf("n_cool.val=%d", (int)id(set_cool_down_time).state);
            ESP_LOGI("Nextion", "Time tab (page 5) opened");

  - platform: nextion
    page_id: 7
    component_id: 0
    id: info
    on_press:
      then:
        #- component.update: display_nextion
        # - script.execute: update_info_display
        - lambda: |-
           ESP_LOGI("Nextion", "INFO tab (page 7) opened");
        # - lambda: id(info).publish_state(false);


  - platform: nextion
    page_id: 1
    component_id: 14
    id: m0_stop
    on_press:
      then:
        - logger.log: "m0_stop pressed, scheduling stop_program"
        - if:
            condition:
              lambda: 'return id(free_running_mode_switch).state || id(motor_running);'
            then:
              - script.execute: stop_program
              - lambda: id(m0_stop).publish_state(false);
            else:
              - logger.log: "m0_stop: Treadmill already stopped, skipping"

  # - platform: nextion
  #   page_id: 1
  #   component_id: 8
  #   id: m0_stop
  #   on_press:
  #     then:
  #       - script.execute: stop_program
  #       - lambda: id(m0_stop).publish_state(false);

  - platform: nextion
    page_id: 0
    component_id: 2
    id: bquick_start
    on_press:
      then:
        - delay: 3400ms
        - script.execute: start_manual
        - lambda: |-
            id(program_select).publish_state("None");
            id(bquick_start).publish_state(false);

  - platform: nextion
    page_id: 11
    component_id: 1
    id: bquick_start1
    on_press:
      then:
        - delay: 3400ms
        - script.execute: start_manual
        - lambda: |-
            id(program_select).publish_state("None");
            id(bquick_start).publish_state(false);

  - platform: nextion
    page_id: 0
    component_id: 7
    id: bfree_run
    on_press:
      then:
        - delay: 3400ms
        - switch.turn_on: free_running_mode_switch
        - script.execute: start_manual
        - lambda: |-
            id(program_select).publish_state("None");
            id(bfree_run).publish_state(false);


  - platform: nextion
    page_id: 11
    component_id: 3
    id: bfree_run1
    on_press:
      then:
        - delay: 3400ms
        - switch.turn_on: free_running_mode_switch
        - script.execute: start_manual
        - lambda: |-
            id(program_select).publish_state("None");
            id(bfree_run).publish_state(false);

  - platform: nextion
    page_id: 15
    component_id: 4
    id: b_cal
    on_press:
      then:
        - lambda: |-
           id(display_nextion).set_component_text("b_cal", "Running...");
           id(display_nextion).set_component_text("caldistspeed.t_info_calib", "3");
           id(display_nextion).send_command_printf("p_zone.pic=76"); // –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∑–æ–Ω—ã 
           id(display_nextion).set_component_text("caldistspeed.t_speed_up", "");
           id(display_nextion).set_component_text("caldistspeed.t_speed_down", "");
           id(display_nextion).set_component_text("caldistspeed.t_lenght", "");
        - delay: 1000ms
        - lambda: id(display_nextion).set_component_text("caldistspeed.t_info_calib", "2");
        - delay: 1000ms
        - lambda: id(display_nextion).set_component_text("caldistspeed.t_info_calib", "1");
        - delay: 1000ms
        - script.execute: start_calibration
        - lambda: |-
            id(b_cal).publish_state(false);
            ESP_LOGI("Nextion", "Button (b_cal) press");

  - platform: nextion
    page_id: 5
    component_id: 9
    id: bstart_program
    on_press:
      then:
        - delay: 3400ms
        - script.execute: start_program
        - lambda: |-
            id(bstart_program).publish_state(false);

  - platform: nextion
    page_id: 0
    component_id: 5
    id: bmap
    on_press:
      then:
        - lambda: |-
            ESP_LOGI("Nextion", "INFO tab (bmap) press");
            id(bmap).publish_state(false);

  - platform: nextion
    page_id: 0
    component_id: 6
    id: bsettings
    on_press:
      then:
        - lambda: |-
            ESP_LOGI("Nextion", "INFO tab (bsettings) press");
            id(bsettings).publish_state(false);

  # - platform: nextion
  #   page_id: 10
  #   component_id: 1
  #   id: m0_select_russia_ufa
  #   on_press:
  #     then:
  #       - lambda: |-
  #           id(map_select).publish_state("Russia, Ufa 3.4km");
  #           id(m0_select_russia_ufa).publish_state(false);

  # - platform: nextion
  #   page_id: 10
  #   component_id: 2
  #   id: m0_select_russia_ufa1
  #   on_press:
  #     then:
  #       - lambda: |-
  #           id(map_select).publish_state("Russia, Ufa Sipailovo 4.4km");
  #           id(m0_select_russia_ufa1).publish_state(false);

  # - platform: nextion
  #   page_id: 10
  #   component_id: 3
  #   id: m0_select_russia_ufa2
  #   on_press:
  #     then:
  #       - lambda: |-
  #           id(map_select).publish_state("Russia, Ufa Kashkadan 1.7km");
  #           id(m0_select_russia_ufa2).publish_state(false);


  # - platform: nextion
  #   page_id: 11
  #   component_id: 1
  #   id: map_start
  #   on_press:
  #     then:
  #       - delay: 3400ms
  #       - script.execute: start_manual
  #       - lambda: |-
  #           ESP_LOGI("Nextion", "INFO tab (map start) press"); 
  #           id(map_start).publish_state(false);

  - platform: nextion
    page_id: 11
    component_id: 2
    id: map_start_hrzone
    on_press:
      then:
        - lambda: |-
            id(program_select).publish_state("Pulse Zone");  // –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É
            ESP_LOGI("Nextion", "INFO tab (map start hrzone) press"); 
            id(map_start_hrzone).publish_state(false);

  - platform: nextion
    page_id: 0
    component_id: 4
    id: bhiit
    on_press:
      then:
        - lambda: |-
            id(program_select).publish_state("HIIT");  // –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É
        - lambda: id(bhiit).publish_state(false);

  - platform: nextion
    page_id: 0
    component_id: 3
    id: bhr_zone
    on_press:
      then:
        - lambda: |-
            id(program_select).publish_state("Pulse Zone");  // –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É
        - lambda: id(bhr_zone).publish_state(false);

  - platform: nextion
    page_id: 2
    component_id: 2
    id: bzone1
    on_press:
      then:
        - lambda: |-
            id(zone_select).publish_state("1");
        - lambda: id(bzone1).publish_state(false);
  - platform: nextion
    page_id: 2
    component_id: 3
    id: bzone2
    on_press:
      then:
        - lambda: |-
            id(zone_select).publish_state("2");
        - lambda: id(bzone2).publish_state(false);
  - platform: nextion
    page_id: 2
    component_id: 4
    id: bzone3
    on_press:
      then:
        - lambda: |-
            id(zone_select).publish_state("3");
        - lambda: id(bzone2).publish_state(false);
  - platform: nextion
    page_id: 2
    component_id: 5
    id: bzone4
    on_press:
      then:
        - lambda: |-
            id(zone_select).publish_state("4");
        - lambda: id(bzone2).publish_state(false);
  - platform: nextion
    page_id: 2
    component_id: 6
    id: bzone5
    on_press:
      then:
        - lambda: |-
            id(zone_select).publish_state("5");
        - lambda: id(bzone5).publish_state(false);


# –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–µ–Ω—Å–æ—Ä—ã
text_sensor:
  - platform: version
    id: ESPHomeVersion
    name: "ESPHome version"
    hide_timestamp: true

  - platform: debug
    device:
      name: "Device Info"
    reset_reason:
      name: "Reset Reason"

  - platform: template
    name: "Pulse monitor"
    id: connection_status
    icon: "mdi:bluetooth"

  - platform: template
    name: "Zwift"
    id: ble_server_status
    icon: "mdi:bluetooth"

  - platform: template
    name: "Selected Data"
    id: selected_data
    icon: "mdi:information"

  - platform: template
    name: "Status"
    id: program_status
    icon: "mdi:monitor-dashboard"
    lambda: |-
      return id(program_status).state;  // –ü—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

  - platform: template
    name: "FTMS Status"
    id: ftms_status_sensor
    icon: "mdi:information-outline"
    entity_category: diagnostic
    update_interval: never  # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é

  - platform: template
    name: "Training Status"
    id: training_status_sensor
    icon: "mdi:information-outline"
    update_interval: never

  # - platform: ble_client
  #   ble_client_id: fit_smart
  #   name: "Pulse"
  #   service_uuid: '180d'
  #   characteristic_uuid: '2a38'

select:
  - platform: template
    name: "Workout Program"
    id: program_select
    restore_value: no
    options:
      - "None"
      - "Pulse Zone"
      - "Fat Burn"
      - "Recovery run"
      - "HIIT"
    initial_option: "None"
    optimistic: true
    on_value:
      - lambda: |-
          std::string program = x;

          if (program == "None") {
            id(zone_select).publish_state("1");
            id(set_run_time).publish_state(00.0); //–≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ 
            id(set_warm_up_time).publish_state(00.0); //–≤—Ä–µ–º—è —Ä–∞–∑–º–∏–Ω–∫–∏
            id(set_cool_down_time).publish_state(00.0); //–≤—Ä–µ–º—è –∑–∞–º–∏–Ω–∫–∏
            //id(stop_program).execute();
          } else if (program == "Fat Burn") {
            id(zone_select).publish_state("2");
            id(set_run_time).publish_state(40.0); //–≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ 
            id(set_warm_up_time).publish_state(03.0); //–≤—Ä–µ–º—è —Ä–∞–∑–º–∏–Ω–∫–∏
            id(set_cool_down_time).publish_state(03.0); //–≤—Ä–µ–º—è –∑–∞–º–∏–Ω–∫–∏
            id(remaining_run_time) = 40 * 60;
            id(manual_stop) = false;
          } else if (program == "Recovery run") {
            id(zone_select).publish_state("1");
            id(set_run_time).publish_state(25.0);
            id(set_warm_up_time).publish_state(03.0); //–≤—Ä–µ–º—è —Ä–∞–∑–º–∏–Ω–∫–∏
            id(set_cool_down_time).publish_state(03.0); //–≤—Ä–µ–º—è –∑–∞–º–∏–Ω–∫–∏
            id(remaining_run_time) = 25 * 60;
            id(manual_stop) = false;
          } else if (program == "HIIT") {
            id(set_run_time).publish_state(30.0);
            id(remaining_run_time) = 30 * 60;
            id(set_warm_up_time).publish_state(03.0); //–≤—Ä–µ–º—è —Ä–∞–∑–º–∏–Ω–∫–∏
            id(set_cool_down_time).publish_state(03.0); //–≤—Ä–µ–º—è –∑–∞–º–∏–Ω–∫–∏
            id(interval_phase) = "high";
            id(interval_time) = 0;
            id(manual_stop) = false;
          } else if (program == "Pulse Zone") {
            id(set_run_time).publish_state(30.0);
            id(set_warm_up_time).publish_state(03.0); //–≤—Ä–µ–º—è —Ä–∞–∑–º–∏–Ω–∫–∏
            id(set_cool_down_time).publish_state(03.0); //–≤—Ä–µ–º—è –∑–∞–º–∏–Ω–∫–∏
            id(manual_stop) = false;
          }


# –í—ã–±–æ—Ä –ø–æ–ª–∞, –∑–æ–Ω—ã, –≤–æ–∑—Ä–∞—Å—Ç–∞
  - platform: template
    name: "Gender"
    id: gender_select
    restore_value: yes
    options:
      - "Male"
      - "Female"
    initial_option: "Male"
    optimistic: true
    on_value:
      - lambda: |-
          const char* gender = id(gender_select)->state.c_str();
          int button_val = (strcmp(gender, "Male") == 0) ? 0 : 1;  // 0 –¥–ª—è Male, 1 –¥–ª—è Female
          // –û–±–Ω–æ–≤–ª—è–µ–º bt0 (Dual State Button)
          id(display_nextion).send_command_printf("age.bt0.val=%d", button_val);
      - script.execute: update_heart_rate_zones

  - platform: template
    name: "Heart Rate Zone"
    id: zone_select
    restore_value: no
    options:
      - "1"
      - "2"
      - "3"
      - "4"
      - "5"
    initial_option: "1"
    optimistic: true
    on_value:
      - script.execute: update_heart_rate_zones

  - platform: template
    name: "Map"
    id: map_select
    restore_value: no
    options:
      - "None"
      - "Russia, Ufa 3.4km"
      - "Russia, Ufa Sipailovo 4.4km"
      - "Russia, Ufa Kashkadan 1.7km"
      - "Zwift Epic Run 6.2km"
      - "Zwift 5K loop 5.0km"
      - "Zwift Mountain Mash 5.9km"
      - "Zwift Chili Pepper 8.0km"
    initial_option: "None"
    optimistic: true
    # on_value:
    #   - script.execute: update_heart_rate_zones


  # - platform: template
  #   name: "UART Data Bits"
  #   id: uart_data_bits
  #   options:
  #     - "5"
  #     - "6"
  #     - "7"
  #     - "8"
  #   initial_option: "8"
  #   optimistic: true
  #   restore_value: true
  #   entity_category: config
  #   icon: "mdi:numeric"
  #   set_action:
  #     - lambda: |-
  #         id(uart_bus).flush();
  #         uint8_t new_data_bits = (uint8_t)stoi(x);
  #         ESP_LOGD("UART", "Changing data bits from %i to %i", id(uart_bus).get_data_bits(), new_data_bits);
  #         if (id(uart_bus).get_data_bits() != new_data_bits) {
  #           id(uart_bus).set_data_bits(new_data_bits);
  #           id(uart_bus).load_settings();
  #         }

  # - platform: template
  #   name: "UART Parity"
  #   id: uart_parity
  #   options:
  #     - "NONE"
  #     - "EVEN"
  #     - "ODD"
  #   initial_option: "NONE"
  #   optimistic: true
  #   restore_value: true
  #   entity_category: config
  #   icon: "mdi:check-circle"
  #   set_action:
  #     - lambda: |-
  #         id(uart_bus).flush();
  #         uart::UARTParityOptions new_parity;
  #         if (x == "NONE") {
  #           new_parity = uart::UARTParityOptions::UART_CONFIG_PARITY_NONE;
  #         } else if (x == "EVEN") {
  #           new_parity = uart::UARTParityOptions::UART_CONFIG_PARITY_EVEN;
  #         } else {
  #           new_parity = uart::UARTParityOptions::UART_CONFIG_PARITY_ODD;
  #         }
  #         ESP_LOGD("UART", "Changing parity to %s", x.c_str());
  #         id(uart_bus).set_parity(new_parity);
  #         id(uart_bus).load_settings();

  # - platform: template
  #   name: "UART Stop Bits"
  #   id: uart_stop_bits
  #   options:
  #     - "1"
  #     - "2"
  #   initial_option: "1"
  #   optimistic: true
  #   restore_value: true
  #   entity_category: config
  #   icon: "mdi:stop-circle"
  #   set_action:
  #     - lambda: |-
  #         id(uart_bus).flush();
  #         uint8_t new_stop_bits = (uint8_t)stoi(x);
  #         ESP_LOGD("UART", "Changing stop bits from %i to %i", id(uart_bus).get_stop_bits(), new_stop_bits);
  #         if (id(uart_bus).get_stop_bits() != new_stop_bits) {
  #           id(uart_bus).set_stop_bits(new_stop_bits);
  #           id(uart_bus).load_settings();
  #         }

number:
  - platform: template
    name: "Age"
    id: age_number
    min_value: 16
    max_value: 100
    step: 1
    initial_value: 30
    optimistic: true
    restore_value: yes
    on_value:
      - lambda: |-
          //if (id(age).state) {
          id(display_nextion).send_command_printf("age.n_age.val=%d", (int)id(age_number).state);
          //}
      - script.execute: update_heart_rate_zones


  - platform: template
    name: "weight"
    id: weight_kg
    min_value: 40
    max_value: 100
    step: 1
    initial_value: 70
    optimistic: true
    restore_value: yes
    on_value:
      - lambda: |-
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–µ—Å –Ω–∞ –¥–∏—Å–ø–ª–µ–π (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è n_weight)
          id(display_nextion).send_command_printf("age.n_weight.val=%d", (int)id(weight_kg).state);
          //ESP_LOGD("Settings", "Weight updated to: %d kg", (int)id(weight_kg).state);


  - platform: template
    name: "Set Speed"
    id: set_speed
    min_value: 0.6
    max_value: 18.0
    step: 0.1
    unit_of_measurement: "km/h"
    icon: "mdi:speedometer"
    optimistic: true
    restore_value: no
    initial_value: 0.0
    on_value:
      - lambda: |-
          if (id(auto_mode)) {
            return;
          }
          float speed = x;
          int target = (int)(speed * 10);  // –í –¥–µ—Å—è—Ç–∏—ã—Ö –∫–º/—á: 1.0 ‚Üí 10, 2.1 ‚Üí 21
          if (target < 6 && target != 0) target = 6;  // –ú–∏–Ω–∏–º—É–º 0.6 –∫–º/—á ‚Üí 6
          if (target > 180) target = 180;  // –ú–∞–∫—Å–∏–º—É–º 18.0 –∫–º/—á ‚Üí 180
          if (id(target_speed) != target) {
            id(target_speed) = target;  // 10 –¥–ª—è 1.0 –∫–º/—á
            id(target_speed_goal) = target;
            int ftms_speed = target * 10;  // –î–ª—è FTMS: 10 * 10 = 100 –¥–ª—è 1.0 –∫–º/—á
            std::vector<uint8_t> status = {0x05, (uint8_t)(ftms_speed & 0xFF), (uint8_t)((ftms_speed >> 8) & 0xFF)};
            id(ftms_status_char).set_value(status);
            id(ftms_status_char).notify();
            id(last_ftms_status) = status;
            id(ftms_status_sensor).publish_state(id(ftms_status_to_string)(0x05));
            ESP_LOGI("treadmill", "Speed updated: %.1f km/h, Target: %d", speed, target);
          }
        
# –ü–æ–ª–∑—É–Ω–æ–∫ –Ω–∞–∫–ª–æ–Ω–∞ –¥–ª—è 0-15% 
  - platform: template
    name: "Set Incline"
    id: set_incline
    min_value: 0
    max_value: 15
    step: 1
    unit_of_measurement: "%"
    icon: "mdi:angle-acute"
    optimistic: true
    on_value:
      - lambda: |-
          float incline = x;
          int incline_value = (int)(incline * 10);  // –ù–∞–∫–ª–æ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ SINT16 (—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ 0.1%)
          if (id(target_incline) != incline_value) {
            id(target_incline_goal) = incline_value;
            id(target_incline) = incline_value;
            std::vector<uint8_t> status = {0x06, (uint8_t)(incline_value & 0xFF), (uint8_t)((incline_value >> 8) & 0xFF)};
            id(ftms_status_char).set_value(status);
            id(ftms_status_char).notify();
            id(last_ftms_status) = status;  // –°–æ—Ö—Ä–∞–Ω—è–µ–º {0x06, low_byte, high_byte}
            id(ftms_status_sensor).publish_state(id(ftms_status_to_string)(0x06));
            ESP_LOGI("treadmill", "Set Incline updated: %.1f%, Goal set to %d", incline, incline_value);
          }

  - platform: template
    name: "Set Warm-up Time"
    id: set_warm_up_time
    min_value: 0
    max_value: 10
    step: 1
    unit_of_measurement: "min"
    icon: "mdi:timer-play-outline"
    optimistic: true
    restore_value: no
    initial_value: 0  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 –º–∏–Ω—É—Ç
    on_value:
      - lambda: |-
          //if (id(age).state) {
          id(display_nextion).send_command_printf("Time.n_warm.val=%d", (int)id(set_warm_up_time).state);
          //}

  - platform: template
    name: "Set Run Time"
    id: set_run_time
    min_value: 0
    max_value: 240
    step: 1
    unit_of_measurement: "min"
    icon: "mdi:timer"
    optimistic: true
    restore_value: no
    initial_value: 0
    on_value:
      - lambda: |- 
          int new_time_seconds = (int)(x * 60);  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–∏–Ω—É—Ç—ã –≤ —Å–µ–∫—É–Ω–¥—ã
          if (id(motor_running)) {
            if (id(remaining_warm_up_time) <= 0 && !id(warm_up_active)) {
              // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
              id(remaining_run_time) = new_time_seconds;
            } else if (id(remaining_warm_up_time) > 0 || id(warm_up_active)) {
              // –ï—Å–ª–∏ –∏–¥–µ—Ç —Ä–∞–∑–º–∏–Ω–∫–∞, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª–∑—É–Ω–∫–∞
              id(set_run_time).publish_state(id(set_run_time).state);
            }
          } else {
            // –ï—Å–ª–∏ –º–æ—Ç–æ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∑–∞–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            id(remaining_run_time) = new_time_seconds;
          }

          //if (id(age).state) {
          id(display_nextion).send_command_printf("Time.n_min.val=%d", (int)id(set_run_time).state);
          //}

  - platform: template
    name: "Set Cool-down Time"
    id: set_cool_down_time
    min_value: 0
    max_value: 10
    step: 1
    unit_of_measurement: "min"
    icon: "mdi:timer-stop-outline"
    optimistic: true
    restore_value: no
    initial_value: 0  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 –º–∏–Ω—É—Ç
    on_value:
      - lambda: |-
          //if (id(age).state) {
          id(display_nextion).send_command_printf("Time.n_cool.val=%d", (int)id(set_cool_down_time).state);
          //}

#–ö–æ–º–ø–æ–Ω–µ–Ω—Ç number –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ –ø—É–ª—å—Å–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  - platform: template
    name: "Test Heart Rate"
    id: test_heart_rate
    min_value: 60
    max_value: 200
    step: 1
    unit_of_measurement: "bpm"
    icon: "mdi:heart-pulse"
    entity_category: diagnostic
    optimistic: true
    on_value:
      then:
        - if:
            condition:
              lambda: 'return id(emulate_ble_connected);'
            then:
              - sensor.template.publish:
                  id: heart_rate_sensor
                  state: !lambda 'return x;'
              - lambda: |-
                  ESP_LOGI("TEST", "Test Heart Rate set to: %.0f bpm", x);
                  // –≠–º—É–ª—è—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ BLE-–ª–æ–≥–∏–∫–∏
                  float heart_rate = x;
                  float max_hr = id(max_heart_rate);
                  float min_zone_1 = max_hr * 0.50;
                  float max_zone_1 = max_hr * 0.60;
                  float min_zone_2 = max_hr * 0.60;
                  float max_zone_2 = max_hr * 0.70;
                  float min_zone_3 = max_hr * 0.70;
                  float max_zone_3 = max_hr * 0.80;
                  float min_zone_4 = max_hr * 0.80;
                  float max_zone_4 = max_hr * 0.90;
                  float min_zone_5 = max_hr * 0.90;
                  float max_zone_5 = max_hr;

                  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∑–æ–Ω—É
                  int heart_rate_zone = 0;
                  if (heart_rate < min_zone_1) {
                    heart_rate_zone = 0;
                  } else if (heart_rate < max_zone_1) {
                    heart_rate_zone = 1;
                  } else if (heart_rate < max_zone_2) {
                    heart_rate_zone = 2;
                  } else if (heart_rate < max_zone_3) {
                    heart_rate_zone = 3;
                  } else if (heart_rate < max_zone_4) {
                    heart_rate_zone = 4;
                  } else {
                    heart_rate_zone = 5;
                  }
                  id(current_zone) = heart_rate_zone;
                  ESP_LOGI("TEST", "Heart Rate: %.0f, Current Zone: %d", heart_rate, heart_rate_zone);

                  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏—Å–ø–ª–µ—è
                  if (id(speed).state) {
                    char heart_str[10];
                    sprintf(heart_str, "%.0f", heart_rate);
                    id(display_nextion).send_command_printf("t0.txt=\"%s\"", heart_str);

                    uint16_t picture_id = 7; // –°–µ—Ä—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    uint16_t t0_bco = 21162; // –°–µ—Ä—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    if (heart_rate < min_zone_1) {
                      picture_id = 7; // –°–µ—Ä—ã–π
                    } else if (heart_rate < max_zone_1) {
                      picture_id = 2; // –ì–æ–ª—É–±–æ–π
                      t0_bco = 15487;
                    } else if (heart_rate < max_zone_2) {
                      picture_id = 3; // –ó–µ–ª—ë–Ω—ã–π
                      t0_bco = 11744;
                    } else if (heart_rate < max_zone_3) {
                      picture_id = 4; // –ñ—ë–ª—Ç—ã–π
                      t0_bco = 64992;
                    } else if (heart_rate < max_zone_4) {
                      picture_id = 5; // –û—Ä–∞–Ω–∂–µ–≤—ã–π
                      t0_bco = 64294;
                    } else {
                      picture_id = 6; // –ö—Ä–∞—Å–Ω—ã–π
                      t0_bco = 64040;
                    }
                    id(display_nextion).send_command_printf("p0.pic=%d", picture_id);
                    id(display_nextion).send_command_printf("t0.bco=%d", t0_bco);
                  }

  - platform: template
    name: "UART Baud Rate"
    id: uart_baud_rate
    min_value: 1000
    max_value: 115200
    step: 100
    initial_value: 4900
    optimistic: true
    restore_value: no
    entity_category: config
    icon: "mdi:swap-horizontal"
    on_value:
      - lambda: |-
          id(uart_bus).flush();  // –û—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä –ø–µ—Ä–µ–¥ —Å–º–µ–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
          uint32_t new_baud_rate = (uint32_t)x;  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª–∑—É–Ω–∫–∞ –≤ uint32_t
          ESP_LOGD("UART", "Changing baud rate from %i to %i", id(uart_bus).get_baud_rate(), new_baud_rate);
          if (id(uart_bus).get_baud_rate() != new_baud_rate) {
            id(uart_bus).set_baud_rate(new_baud_rate);
            id(uart_bus).load_settings();
          }


  - platform: template
    id: treadmill_slider_max
    name: TM slider max
    min_value: 60
    max_value: 120
    step: 1
    unit_of_measurement: "cm"
    entity_category: config
    mode: slider
    restore_value: yes
    optimistic: true
    initial_value: 85
    on_value:
      then:
        - lambda: |-
            id(display_nextion).send_command_printf("speed.h_position.maxval=%d", (int)id(treadmill_slider_max).state);
            id(display_nextion).send_command_printf("speed.h_position1.maxval=%d", (int)id(treadmill_slider_max).state);
            id(display_nextion).send_command_printf("caldistspeed.h_position.maxval=%d", (int)id(treadmill_slider_max).state);


  - platform: template
    id: treadmill_slider_min
    name: TM slider min
    min_value: 0
    max_value: 40
    step: 1
    unit_of_measurement: "cm"
    entity_category: config
    mode: slider
    restore_value: yes
    optimistic: true
    initial_value: 25
    on_value:
      then:
        - lambda: |-
            id(display_nextion).send_command_printf("speed.h_position.minval=%d", (int)id(treadmill_slider_min).state);
            id(display_nextion).send_command_printf("speed.h_position1.minval=%d", (int)id(treadmill_slider_min).state);
            id(display_nextion).send_command_printf("caldistspeed.h_position.minval=%d", (int)id(treadmill_slider_min).state);


  - platform: template
    id: treadmill_length
    name: TM Length
    min_value: 80
    max_value: 140
    step: 1
    unit_of_measurement: "cm"
    entity_category: config
    mode: slider
    restore_value: yes
    optimistic: true
    initial_value: 100
    on_value:
      then:
        - lambda: |-
            id(display_nextion).set_component_text_printf("caldistspeed.t_lenght", "%d", (int)id(treadmill_length).state);
  - platform: template
    id: accel_strong_cm
    name: TM Strong Accel
    min_value: 10
    max_value: 50
    step: 1
    unit_of_measurement: "cm"
    entity_category: config
    mode: slider
    restore_value: yes
    optimistic: true
    initial_value: 20
  - platform: template
    id: accel_cm
    name: TM Accel
    min_value: 20
    max_value: 60
    step: 1
    unit_of_measurement: "cm"
    entity_category: config
    mode: slider
    optimistic: true
    restore_value: yes
    initial_value: 35
    on_value:
      then:
        - lambda: |-
            id(display_nextion).set_component_text_printf("caldistspeed.t_speed_up", "%d", (int)id(accel_cm).state);
  - platform: template
    id: decel_cm
    name: TM Decel
    min_value: 60
    max_value: 90
    step: 1
    unit_of_measurement: "cm"
    entity_category: config
    mode: slider
    optimistic: true
    restore_value: yes
    initial_value: 62
    on_value:
      then:
        - lambda: |-
            id(display_nextion).set_component_text_printf("caldistspeed.t_speed_down", "%d", (int)id(decel_cm).state);
  - platform: template
    id: decel_strong_cm
    name: TM Strong Decel
    min_value: 30
    max_value: 100
    step: 1
    unit_of_measurement: "cm"
    restore_value: yes
    entity_category: config
    mode: slider
    optimistic: true
    initial_value: 70

  # Switch –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ bt0 (Dual State Button)
switch:
  - platform: nextion
    id: gender_switch
    name: "Gender Switch"
    internal: true
    component_name: bt0  # –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏–º–µ–Ω–∏ –≤ Nextion
    on_turn_on:  # bt0.val = 1 (Female)
      - lambda: |-
          if (id(gender_select)->state != "Female") {
            id(gender_select).publish_state("Female");
            ESP_LOGD("Settings", "Gender set to Female from bt0");
            id(update_heart_rate_zones).execute();
          }
    on_turn_off:  # bt0.val = 0 (Male)
      - lambda: |-
          if (id(gender_select)->state != "Male") {
            id(gender_select).publish_state("Male");
            ESP_LOGD("Settings", "Gender set to Male from bt0");
            id(update_heart_rate_zones).execute();
          }


  - platform: template
    name: "Emulate Heart Rate"
    id: emulate_heart_rate_switch
    entity_category: diagnostic
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    icon: "mdi:heart-pulse"
    turn_on_action:
      - lambda: |-
          id(emulate_ble_connected) = true;
          ESP_LOGI("SWITCH", "Heart rate emulation enabled");
    turn_off_action:
      - lambda: |-
          id(emulate_ble_connected) = false;
          ESP_LOGI("SWITCH", "Heart rate emulation disabled");
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º heart_rate_sensor –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏
          id(heart_rate_sensor).publish_state(NAN);
          // –û—á–∏—â–∞–µ–º –¥–∏—Å–ø–ª–µ–π Nextion
          if (id(speed).state) {
            id(display_nextion).send_command_printf("t0.txt=\"--\"");
            id(display_nextion).send_command_printf("p0.pic=7"); // –°–µ—Ä—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            id(display_nextion).send_command_printf("t0.bco=21162"); // –°–µ—Ä—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          }

  - platform: nextion
    name: "Disp. auto on-off"
    id: sw_display_off
    component_name: display.sw_display_off
    restore_mode: RESTORE_DEFAULT_ON
    on_turn_on:
      - lambda: |-
          id(display_nextion).send_command_printf("display.sw_display_off.val=1"); 
    on_turn_off:
      - lambda: |-
          id(display_nextion).send_command_printf("display.sw_display_off.val=0"); 


  - platform: template
    name: "Free Running Mode"
    id: free_running_mode_switch
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: |-
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω –Ω–µ Free Run
          if (id(control_mode) != 1) {
            id(previous_control_mode) = id(control_mode);
          }
          // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º Free Run
          id(control_mode) = 1;
          id(free_running_active) = true;
          ESP_LOGI("FreeRun", "Free Run –≤–∫–ª—é—á—ë–Ω, –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∂–∏–º: %d", id(previous_control_mode));
          id(display_nextion).send_command_printf("speed.p_icon_mode.pic=58"); // –∏–∫–æ–Ω–∫–∞
      - script.execute: free_running_mode
    on_turn_off:
      - lambda: |-
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∂–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
          id(control_mode) = id(previous_control_mode);
          id(free_running_active) = false;
          ESP_LOGI("FreeRun", "Free Run –≤—ã–∫–ª—é—á–µ–Ω, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä–µ–∂–∏–º: %d", id(control_mode));
          // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ Pulse Zone, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ –ø—É–ª—å—Å—É
          if (id(control_mode) == 2) {
            id(auto_mode) = true;
            id(display_nextion).send_command_printf("speed.p_icon_mode.pic=59"); // –∏–∫–æ–Ω–∫–∞ –ø—É–ª—å—Å
            ESP_LOGI("FreeRun", "–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ –ø—É–ª—å—Å—É");
          } else {
            id(auto_mode) = false;
            id(display_nextion).send_command_printf("speed.p_icon_mode.pic=62"); // –∏–∫–æ–Ω–∫–∞ —É–±—Ä–∞—Ç—å
            ESP_LOGI("FreeRun", "–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ");
          }

  # ***************** display *****************
display:
  - platform: nextion
    uart_id: uart_0
    id: display_nextion
    update_interval: 1s
    tft_url: http://192.168.1.189:8123/local/nextion_treadmill_4.3_ips_800x480.tft
    # command_spacing: 15ms        # –ë—ã—Å—Ç—Ä–µ–µ, –Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ
    # max_queue_size: 50           # –æ—á–µ—Ä–µ–¥—å ‚Äî –¥–æ 50 –∫–æ–º–∞–Ω–¥
    # max_commands_per_loop: 40    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å—ë –∑–∞ —Ä–∞–∑
    # on_buffer_overflow:
    #   then:
    #     - logger.log: "‚ö†Ô∏è –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ Nextion!"
    on_setup:  #–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
      then:
        # - wait_until:  // –∫–æ–º–∞–Ω–¥–∞ (wait_until) –∂–¥–∞—Ç—å –ø–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
        #     api.connected
        #- delay: 10s  # –ü–æ–¥–æ–∂–¥–∞—Ç—å —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –ø–æ–≥–æ–¥–∞
        - lambda: |-
            // –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ 
            if (id(sw_display_off)) {
              id(sw_display_off).turn_on();
            } else {
              id(sw_display_off).turn_off();
            }

            id(display_nextion).set_component_value("display.hbright", id(brightness_level));
            id(display_nextion).set_component_value("dim", id(brightness_level));

            id(display_nextion).send_command_printf("speed.h_position.maxval=%d", (int)id(treadmill_slider_max).state);
            id(display_nextion).send_command_printf("speed.h_position1.maxval=%d", (int)id(treadmill_slider_max).state);
            id(display_nextion).send_command_printf("caldistspeed.h_position.maxval=%d", (int)id(treadmill_slider_max).state);

            id(display_nextion).send_command_printf("speed.h_position.minval=%d", (int)id(treadmill_slider_min).state);
             id(display_nextion).send_command_printf("speed.h_position1.minval=%d", (int)id(treadmill_slider_min).state);
            id(display_nextion).send_command_printf("caldistspeed.h_position.minval=%d", (int)id(treadmill_slider_min).state);


            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π
            id(display_nextion).set_component_text_printf("caldistspeed.t_speed_up", "%d", (int)id(accel_cm).state);
            id(display_nextion).set_component_text_printf("caldistspeed.t_speed_down", "%d", (int)id(decel_cm).state);
            id(display_nextion).set_component_text_printf("caldistspeed.t_lenght", "%d", (int)id(treadmill_length).state);

    lambda: |-
      if (id(speed).state) {
        id(display_nextion).set_component_text("speed.t5", id(program_status).state.c_str());
      }